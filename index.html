<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CVSU Organization Portal</title>
  <style>
    body {
      box-sizing: border-box;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0f6b3a 0%, #1a8f4f 100%);
      min-height: 100%;
      color: #333;
    }

    html, body {
      height: 100%;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .role-pill {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 8px;
    }

    .role-president { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
    .role-vp { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; }
    .role-secretary { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; }
    .role-treasurer { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; }
    .role-auditor { background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); color: white; }
    .role-pio { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #333; }
    .role-sgt { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); color: #333; }
    .role-member { background: #e0e0e0; color: #666; }

    .pending-approval {
      background: #fff3cd;
      border: 2px solid #ffc107;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      text-align: center;
    }

    .pending-approval h3 {
      color: #856404;
      margin-bottom: 10px;
    }

    /* Auth Section */
    #authSection {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100%;
      padding: 20px;
    }

    .auth-card {
      background: white;
      border-radius: 20px;
      padding: 50px 40px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 450px;
      width: 100%;
      text-align: center;
    }

    .auth-logo {
      font-size: 64px;
      margin-bottom: 20px;
    }

    .auth-title {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 10px;
      background: linear-gradient(135deg, #0f6b3a 0%, #1a8f4f 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .auth-subtitle {
      font-size: 16px;
      color: #666;
      margin-bottom: 40px;
    }

    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
      font-size: 14px;
    }

    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
      transition: border-color 0.3s;
      font-family: inherit;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: #0f6b3a;
    }

    .btn-primary {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #0f6b3a 0%, #1a8f4f 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 4px 15px rgba(15, 107, 58, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(15, 107, 58, 0.4);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .auth-toggle {
      margin-top: 20px;
      font-size: 14px;
      color: #666;
    }

    .auth-toggle a {
      color: #0f6b3a;
      text-decoration: none;
      font-weight: 600;
      cursor: pointer;
    }

    .auth-toggle a:hover {
      text-decoration: underline;
    }

    .error-message {
      background: #fee;
      color: #c33;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
    }

    .success-message {
      background: #efe;
      color: #3c3;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
    }

    .google-btn {
      width: 100%;
      padding: 14px;
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
      transition: all 0.3s;
    }

    .google-btn:hover {
      border-color: #0f6b3a;
      background: #f0f8f4;
    }

    .divider {
      text-align: center;
      margin: 20px 0;
      position: relative;
    }

    .divider::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      width: 100%;
      height: 1px;
      background: #e0e0e0;
    }

    .divider span {
      background: white;
      padding: 0 10px;
      position: relative;
      color: #999;
      font-size: 14px;
    }

    /* Main App */
    #mainApp {
      display: none;
    }

    .header {
      background: white;
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .header-logo {
      font-size: 48px;
    }

    .header-text h1 {
      font-size: 28px;
      font-weight: 700;
      background: linear-gradient(135deg, #0f6b3a 0%, #1a8f4f 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 5px;
    }

    .header-text p {
      font-size: 14px;
      color: #666;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .user-info {
      text-align: right;
      margin-right: 10px;
    }

    .user-email {
      font-size: 14px;
      color: #666;
      font-weight: 600;
    }

    .btn-logout {
      padding: 10px 20px;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
    }

    .btn-logout:hover {
      background: #d32f2f;
    }

    .tabs-container {
      background: white;
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      overflow-x: auto;
      overflow-y: hidden;
    }

    .tabs {
      display: flex;
      gap: 10px;
      flex-wrap: nowrap;
      min-width: min-content;
    }

    .tab {
      padding: 12px 24px;
      background: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .tab:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
    }

    .tab.active {
      background: linear-gradient(135deg, #0f6b3a 0%, #1a8f4f 100%);
      color: white;
    }

    .tab.hidden {
      display: none;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .card {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
    }

    .card h2 {
      font-size: 24px;
      margin-bottom: 20px;
      color: #333;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }

    .member-card, .resource-card, .event-card {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      padding: 20px;
      border-radius: 15px;
      transition: transform 0.3s;
    }

    .member-card:hover, .resource-card:hover, .event-card:hover {
      transform: translateY(-5px);
    }

    .member-card h3, .resource-card h3, .event-card h3 {
      font-size: 18px;
      margin-bottom: 10px;
      color: #333;
    }

    .member-card p, .resource-card p, .event-card p {
      font-size: 14px;
      color: #666;
      margin-bottom: 8px;
    }

    .btn-secondary {
      padding: 8px 16px;
      background: #0f6b3a;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
      margin-top: 10px;
    }

    .btn-secondary:hover {
      background: #0d5a31;
    }

    .btn-success {
      padding: 8px 16px;
      background: #4caf50;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
      margin-left: 10px;
    }

    .btn-success:hover {
      background: #45a049;
    }

    .btn-danger {
      padding: 8px 16px;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
      margin-left: 10px;
    }

    .btn-danger:hover {
      background: #d32f2f;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 600px;
      width: 100%;
      max-height: 90%;
      overflow-y: auto;
      position: relative;
    }

    .modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 28px;
      cursor: pointer;
      color: #999;
      background: none;
      border: none;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-close:hover {
      color: #333;
    }

    .modal h2 {
      font-size: 24px;
      margin-bottom: 25px;
      color: #333;
    }

    .file-input-wrapper {
      position: relative;
      display: inline-block;
      width: 100%;
      margin-bottom: 15px;
    }

    .file-input-wrapper input[type="file"] {
      position: absolute;
      left: -9999px;
    }

    .file-input-label {
      display: block;
      padding: 14px 16px;
      background: #f5f5f5;
      border: 2px dashed #ccc;
      border-radius: 10px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
    }

    .file-input-label:hover {
      background: #ebebeb;
      border-color: #667eea;
    }

    .file-name {
      margin-top: 10px;
      font-size: 14px;
      color: #666;
    }

    .upload-progress {
      display: none;
      margin-top: 15px;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e0e0e0;
      border-radius: 10px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #0f6b3a 0%, #1a8f4f 100%);
      width: 0%;
      transition: width 0.3s;
    }

    .progress-text {
      font-size: 14px;
      color: #666;
      margin-top: 8px;
      text-align: center;
    }

    .announcement-item {
      background: linear-gradient(135deg, #0f6b3a 0%, #1a8f4f 100%);
      color: white;
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 20px;
    }

    .announcement-item h3 {
      font-size: 20px;
      margin-bottom: 10px;
    }

    .announcement-item p {
      font-size: 14px;
      margin-bottom: 8px;
    }

    .announcement-date {
      font-size: 12px;
      opacity: 0.8;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }

    .empty-state p {
      font-size: 16px;
    }

    .approval-card {
      background: white;
      border: 2px solid #ffc107;
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 20px;
    }

    .approval-card h3 {
      margin-bottom: 10px;
      color: #333;
    }

    .approval-card p {
      font-size: 14px;
      color: #666;
      margin-bottom: 8px;
    }

    .audit-log-item {
      background: #f5f7fa;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
      border-left: 4px solid #0f6b3a;
    }

    .audit-log-item p {
      font-size: 14px;
      color: #666;
      margin-bottom: 5px;
    }

    .audit-log-time {
      font-size: 12px;
      color: #999;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    .table th, .table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }

    .table th {
      background: #f5f7fa;
      font-weight: 600;
      color: #333;
    }

    .table tr:hover {
      background: #f8f9ff;
    }

    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        text-align: center;
      }

      .header-left {
        flex-direction: column;
      }

      .user-info {
        text-align: center;
        margin-right: 0;
      }

      .grid {
        grid-template-columns: 1fr;
      }

      .tabs-container {
        padding: 15px;
      }

      .tabs {
        gap: 8px;
      }

      .tab {
        white-space: nowrap;
        font-size: 14px;
        padding: 10px 18px;
      }

      .table {
        font-size: 12px;
      }

      .table th, .table td {
        padding: 8px;
      }
    }

    .loading-spinner {
      display: none;
      text-align: center;
      padding: 20px;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #0f6b3a;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body><!-- Auth Section -->
  <div id="authSection">
   <div class="auth-card">
    <div class="auth-logo">
     üéì
    </div>
    <h1 class="auth-title">CVSU Portal</h1>
    <p class="auth-subtitle">Organization Management System</p>
    <div class="error-message" id="authError"></div>
    <div class="success-message" id="authSuccess"></div>
    <div id="loginForm"><button class="google-btn" id="googleSignInBtn">
      <svg width="18" height="18" viewbox="0 0 18 18"><path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z" /> <path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.184l-2.908-2.258c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z" /> <path fill="#FBBC05" d="M3.964 10.707c-.18-.54-.282-1.117-.282-1.707 0-.593.102-1.17.282-1.707V4.961H.957C.347 6.175 0 7.55 0 9s.348 2.825.957 4.039l3.007-2.332z" /> <path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.961L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z" />
      </svg> Sign in with Google </button>
     <div class="divider">
      <span>OR</span>
     </div>
     <form id="loginFormElement">
      <div class="form-group"><label for="loginEmail">Email Address</label> <input type="email" id="loginEmail" placeholder="your@email.com" required>
      </div>
      <div class="form-group"><label for="loginPassword">Password</label> <input type="password" id="loginPassword" placeholder="Enter your password" required>
      </div><button type="submit" class="btn-primary" id="loginBtn">Sign In</button>
     </form>
     <div class="auth-toggle">
      Don't have an account? <a id="showSignup">Sign up</a>
     </div>
    </div>
    <div id="signupForm" style="display: none;">
     <form id="signupFormElement">
      <div class="form-group"><label for="signupEmail">Email Address</label> <input type="email" id="signupEmail" placeholder="your@email.com" required>
      </div>
      <div class="form-group"><label for="signupPassword">Password</label> <input type="password" id="signupPassword" placeholder="At least 6 characters" required>
      </div>
      <div class="form-group"><label for="signupName">Full Name</label> <input type="text" id="signupName" placeholder="Juan Dela Cruz" required>
      </div>
      <div class="form-group"><label for="signupGrade">Grade Level</label> <select id="signupGrade" required> <option value="">Choose grade level...</option> <option value="7">Grade 7</option> <option value="8">Grade 8</option> <option value="9">Grade 9</option> <option value="10">Grade 10</option> </select>
      </div>
      <div class="form-group"><label for="signupSection">Section</label> <input type="text" id="signupSection" placeholder="A" required>
      </div><button type="submit" class="btn-primary" id="signupBtn">Create Account</button>
     </form>
     <div class="auth-toggle">
      Already have an account? <a id="showLogin">Sign in</a>
     </div>
    </div>
   </div>
  </div><!-- Main App -->
  <div id="mainApp">
   <div id="pendingApprovalSection" class="pending-approval" style="display: none;">
    <h3>‚è≥ Pending Approval</h3>
    <p>Your account is awaiting approval from an administrator. You'll receive an email once approved.</p>
   </div>
   <div id="orgSelectionSection" style="display: none;">
    <div class="container">
     <div class="card" style="max-width: 800px; margin: 100px auto;">
      <h2>üèõÔ∏è Select Your Organization</h2>
      <p style="margin-bottom: 30px;">Choose an organization to manage, or create a new one.</p>
      <div id="orgListLoading" class="loading-spinner">
       <div class="spinner"></div>
       <p>Loading organizations...</p>
      </div>
      <div id="orgList" class="grid" style="margin-bottom: 30px;"></div><button class="btn-secondary" id="createNewOrgBtn">ÔøΩÔøΩÔøΩ Create New Organization</button>
     </div>
    </div>
   </div>
   <div id="approvedAppSection" style="display: none;">
    <div class="container">
     <div class="header">
      <div class="header-left">
       <div class="header-logo">
        üéì
       </div>
       <div class="header-text">
        <h1>CVSU Organization Portal</h1>
        <p>Manage your organization efficiently</p>
       </div>
      </div>
      <div class="header-right">
       <div class="user-info">
        <div class="user-email" id="userEmail"></div><span id="userRolePill"></span>
       </div><button class="btn-secondary" id="changeOrgBtn" style="margin-right: 10px;">üèõÔ∏è Change Org</button> <button class="btn-logout" id="logoutBtn">Logout</button>
      </div>
     </div>
     <div class="tabs-container">
      <div class="tabs" id="tabsContainer"><button class="tab active" data-tab="dashboard">üìä Dashboard</button> <button class="tab" data-tab="members">üë• Members</button> <button class="tab" data-tab="roles">üéñÔ∏è Roles</button> <button class="tab" data-tab="events">üìÖ Events</button> <button class="tab" data-tab="files">üìÅ Files</button> <button class="tab" data-tab="attendance">‚úÖ Attendance</button> <button class="tab" data-tab="finance">üí∞ Finance</button> <button class="tab" data-tab="announcements">üì¢ Announcements</button> <button class="tab" data-tab="approvals">‚úîÔ∏è Approvals</button> <button class="tab" data-tab="auditLogs">üìã Audit Logs</button> <button class="tab" data-tab="settings">ÔøΩÔøΩÔøΩÔ∏è Settings</button>
      </div>
     </div><!-- Dashboard Tab -->
     <div class="tab-content active" id="dashboard">
      <div class="card">
       <h2>Welcome to CVSU Portal! üéì</h2>
       <p>Your organization management dashboard</p>
       <div style="margin-top: 30px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
        <div style="background: linear-gradient(135deg, #0f6b3a 0%, #1a8f4f 100%); color: white; padding: 30px; border-radius: 15px; text-align: center;">
         <div style="font-size: 36px; font-weight: 700;" id="memberCount">
          0
         </div>
         <div style="font-size: 14px; margin-top: 5px;">
          Total Members
         </div>
        </div>
        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 30px; border-radius: 15px; text-align: center;">
         <div style="font-size: 36px; font-weight: 700;" id="resourceCount">
          0
         </div>
         <div style="font-size: 14px; margin-top: 5px;">
          Resources
         </div>
        </div>
        <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 30px; border-radius: 15px; text-align: center;">
         <div style="font-size: 36px; font-weight: 700;" id="eventCount">
          0
         </div>
         <div style="font-size: 14px; margin-top: 5px;">
          Upcoming Events
         </div>
        </div>
        <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 30px; border-radius: 15px; text-align: center;">
         <div style="font-size: 36px; font-weight: 700;" id="announcementCount">
          0
         </div>
         <div style="font-size: 14px; margin-top: 5px;">
          Announcements
         </div>
        </div>
       </div>
      </div>
     </div><!-- Members Tab -->
     <div class="tab-content" id="members">
      <div class="card">
       <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
        <h2 style="margin: 0;">Organization Members</h2>
       </div>
       <div class="loading-spinner" id="membersLoading">
        <div class="spinner"></div>
        <p>Loading members...</p>
       </div>
       <div class="grid" id="membersList"></div>
      </div>
     </div><!-- Roles Tab -->
     <div class="tab-content" id="roles">
      <div class="card">
       <h2>Role Management</h2>
       <table class="table" id="rolesTable">
        <thead>
         <tr>
          <th>Role</th>
          <th>Assigned To</th>
          <th>Email</th>
          <th>Actions</th>
         </tr>
        </thead>
        <tbody id="rolesTableBody"></tbody>
       </table>
      </div>
     </div><!-- Events Tab -->
     <div class="tab-content" id="events">
      <div class="card">
       <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
        <h2 style="margin: 0;">Upcoming Events</h2><button class="btn-secondary" id="addEventBtn">‚ûï Add Event</button>
       </div>
       <div class="loading-spinner" id="eventsLoading">
        <div class="spinner"></div>
        <p>Loading events...</p>
       </div>
       <div class="grid" id="eventsList"></div>
      </div>
     </div><!-- Files Tab -->
     <div class="tab-content" id="files">
      <div class="card">
       <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
        <h2 style="margin: 0;">Organization Files</h2><button class="btn-secondary" id="addFileBtn">üì§ Upload File</button>
       </div>
       <div class="loading-spinner" id="filesLoading">
        <div class="spinner"></div>
        <p>Loading files...</p>
       </div>
       <div class="grid" id="filesList"></div>
      </div>
     </div><!-- Attendance Tab -->
     <div class="tab-content" id="attendance">
      <div class="card">
       <h2>Attendance Tracking</h2>
       <div class="form-group"><label for="attendanceEvent">Select Event</label> <select id="attendanceEvent"> <option value="">Choose an event...</option> </select>
       </div><button class="btn-secondary" id="markAttendanceBtn">Mark Attendance</button> <button class="btn-secondary" id="exportAttendanceBtn">Export CSV</button>
       <table class="table" id="attendanceTable">
        <thead>
         <tr>
          <th>Member</th>
          <th>Status</th>
          <th>Time</th>
         </tr>
        </thead>
        <tbody id="attendanceTableBody"></tbody>
       </table>
      </div>
     </div><!-- Finance Tab -->
     <div class="tab-content" id="finance">
      <div class="card">
       <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
        <h2 style="margin: 0;">Financial Records</h2>
        <div><button class="btn-secondary" id="addIncomeBtn">‚ûï Income</button> <button class="btn-secondary" id="addExpenseBtn">‚ûï Expense</button> <button class="btn-secondary" id="exportFinanceBtn">Export CSV</button>
        </div>
       </div>
       <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
        <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 20px; border-radius: 15px;">
         <div style="font-size: 28px; font-weight: 700;" id="totalIncome">
          ‚Ç±0
         </div>
         <div style="font-size: 14px; margin-top: 5px;">
          Total Income
         </div>
        </div>
        <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; padding: 20px; border-radius: 15px;">
         <div style="font-size: 28px; font-weight: 700;" id="totalExpense">
          ‚Ç±0
         </div>
         <div style="font-size: 14px; margin-top: 5px;">
          Total Expenses
         </div>
        </div>
        <div style="background: linear-gradient(135deg, #0f6b3a 0%, #1a8f4f 100%); color: white; padding: 20px; border-radius: 15px;">
         <div style="font-size: 28px; font-weight: 700;" id="netBalance">
          ‚Ç±0
         </div>
         <div style="font-size: 14px; margin-top: 5px;">
          Net Balance
         </div>
        </div>
       </div>
       <table class="table" id="financeTable">
        <thead>
         <tr>
          <th>Date</th>
          <th>Type</th>
          <th>Description</th>
          <th>Amount</th>
          <th>Recorded By</th>
          <th>Actions</th>
         </tr>
        </thead>
        <tbody id="financeTableBody"></tbody>
       </table>
      </div>
     </div><!-- Announcements Tab -->
     <div class="tab-content" id="announcements">
      <div class="card">
       <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
        <h2 style="margin: 0;">Announcements</h2><button class="btn-secondary" id="addAnnouncementBtn">üì¢ New Announcement</button>
       </div>
       <div class="loading-spinner" id="announcementsLoading">
        <div class="spinner"></div>
        <p>Loading announcements...</p>
       </div>
       <div id="announcementsList"></div>
      </div>
     </div><!-- Approvals Tab -->
     <div class="tab-content" id="approvals">
      <div class="card">
       <h2>Pending Approvals</h2>
       <div class="loading-spinner" id="approvalsLoading">
        <div class="spinner"></div>
        <p>Loading approvals...</p>
       </div>
       <div id="approvalsList"></div>
      </div>
     </div><!-- Audit Logs Tab -->
     <div class="tab-content" id="auditLogs">
      <div class="card">
       <h2>Audit Logs</h2><button class="btn-secondary" id="exportAuditBtn">Export CSV</button>
       <div class="loading-spinner" id="auditLogsLoading">
        <div class="spinner"></div>
        <p>Loading audit logs...</p>
       </div>
       <div id="auditLogsList"></div>
      </div>
     </div><!-- Settings Tab -->
     <div class="tab-content" id="settings">
      <div class="card">
       <h2>Settings</h2>
       <form id="settingsForm">
        <div class="form-group"><label for="orgName">Organization Name</label> <input type="text" id="orgName" value="CVSU">
        </div>
        <div class="form-group"><label for="orgDescription">Description</label> <textarea id="orgDescription" placeholder="About your organization..."></textarea>
        </div><button type="submit" class="btn-primary">Save Settings</button>
       </form>
      </div>
     </div>
    </div>
   </div>
  </div><!-- Add Event Modal -->
  <div class="modal" id="eventModal">
   <div class="modal-content"><button class="modal-close" id="closeEventModal">√ó</button>
    <h2>Add New Event</h2>
    <form id="eventForm">
     <div class="form-group"><label for="eventTitle">Event Title</label> <input type="text" id="eventTitle" placeholder="General Assembly" required>
     </div>
     <div class="form-group"><label for="eventDate">Date &amp; Time</label> <input type="datetime-local" id="eventDate" required>
     </div>
     <div class="form-group"><label for="eventLocation">Location</label> <input type="text" id="eventLocation" placeholder="Main Hall, Online, etc." required>
     </div>
     <div class="form-group"><label for="eventDescription">Description</label> <textarea id="eventDescription" placeholder="Event details"></textarea>
     </div><button type="submit" class="btn-primary">Add Event</button>
    </form>
   </div>
  </div><!-- Add File Modal -->
  <div class="modal" id="fileModal">
   <div class="modal-content"><button class="modal-close" id="closeFileModal">√ó</button>
    <h2>Upload File</h2>
    <form id="fileForm">
     <div class="form-group"><label for="fileTitle">File Title</label> <input type="text" id="fileTitle" placeholder="Meeting Notes, Budget, etc." required>
     </div>
     <div class="form-group"><label for="fileDescription">Description</label> <input type="text" id="fileDescription" placeholder="Brief description">
     </div>
     <div class="form-group"><label>Upload File</label>
      <div class="file-input-wrapper"><input type="file" id="fileUpload" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.jpg,.jpeg,.png"> <label for="fileUpload" class="file-input-label"> üìÅ Click to select file </label>
      </div>
      <div class="file-name" id="fileFileName"></div>
     </div>
     <div class="upload-progress" id="fileUploadProgress">
      <div class="progress-bar">
       <div class="progress-fill" id="fileProgressFill"></div>
      </div>
      <div class="progress-text" id="fileProgressText">
       Uploading...
      </div>
     </div><button type="submit" class="btn-primary" id="uploadFileBtn">Upload File</button>
    </form>
   </div>
  </div><!-- Add Announcement Modal -->
  <div class="modal" id="announcementModal">
   <div class="modal-content"><button class="modal-close" id="closeAnnouncementModal">√ó</button>
    <h2>New Announcement</h2>
    <form id="announcementForm">
     <div class="form-group"><label for="announcementTitle">Title</label> <input type="text" id="announcementTitle" placeholder="Important Update" required>
     </div>
     <div class="form-group"><label for="announcementContent">Content</label> <textarea id="announcementContent" placeholder="Announcement details" required></textarea>
     </div><button type="submit" class="btn-primary">Post Announcement</button>
    </form>
   </div>
  </div><!-- Add Finance Modal -->
  <div class="modal" id="financeModal">
   <div class="modal-content"><button class="modal-close" id="closeFinanceModal">√ó</button>
    <h2 id="financeModalTitle">Add Transaction</h2>
    <form id="financeForm"><input type="hidden" id="financeType">
     <div class="form-group"><label for="financeDescription">Description</label> <input type="text" id="financeDescription" placeholder="e.g., Membership fee, Event expenses" required>
     </div>
     <div class="form-group"><label for="financeAmount">Amount (‚Ç±)</label> <input type="number" id="financeAmount" placeholder="0.00" step="0.01" required>
     </div><button type="submit" class="btn-primary">Add Transaction</button>
    </form>
   </div>
  </div><!-- Create Organization Modal -->
  <div class="modal" id="createOrgModal">
   <div class="modal-content"><button class="modal-close" id="closeCreateOrgModal">√ó</button>
    <h2>Create New Organization</h2>
    <div style="background: #fff3cd; border: 2px solid #ffc107; padding: 12px; border-radius: 8px; margin-bottom: 20px;">
     <p style="margin: 0; font-size: 13px; color: #856404; font-weight: 600;">‚ö†Ô∏è Organization Approval Required</p>
     <p style="margin: 5px 0 0 0; font-size: 12px; color: #856404;">New organizations must be manually approved in the database before they become active.</p>
    </div>
    <form id="createOrgForm">
     <div class="form-group"><label for="newOrgName">Organization Name</label> <input type="text" id="newOrgName" placeholder="e.g., Computer Science Club, Math Society" required>
     </div>
     <div class="form-group"><label for="newOrgDescription">Description</label> <textarea id="newOrgDescription" placeholder="Brief description of your organization" required></textarea>
     </div>
     <div class="form-group"><label for="newOrgType">Organization Type</label> <select id="newOrgType" required> <option value="">Choose type...</option> <option value="club">Club</option> <option value="society">Society</option> <option value="committee">Committee</option> <option value="association">Association</option> <option value="other">Other</option> </select>
     </div><button type="submit" class="btn-primary">Submit for Approval</button>
    </form>
   </div>
  </div><!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script>
    // Configuration
    const CONFIG = {
      ORG_ID: null,
      ORG_NAME: null,
      FIREBASE: {
        apiKey: "AIzaSyAK_41CRZM1pt5zTNqMzy_WdrZu1g8fKks",
        authDomain: "org-organizer.firebaseapp.com",
        databaseURL: "https://org-organizer-default-rtdb.firebaseio.com",
        projectId: "org-organizer",
        storageBucket: "org-organizer.firebasestorage.app",
        messagingSenderId: "971435967798",
        appId: "1:971435967798:web:969835f265d9ee4f879f97",
        measurementId: "G-STG68DJDWF"
      },
      CLOUDINARY: {
        CLOUD_NAME: 'damr6r9op',
        UPLOAD_PRESET: 'org-resources'
      },
      DISCORD_WEBHOOK: "https://discord.com/api/webhooks/1330706822034378292/20zggT_tEPEIZ6lYF52-wRaB6eAUOHCirNebJEoU2Hj7eytnDo9ZaxSlMVgzPQpQql18"
    };

    // Initialize Firebase
    firebase.initializeApp(CONFIG.FIREBASE);
    const auth = firebase.auth();
    const db = firebase.database();

    // Set persistence to LOCAL
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(err => {
      console.error('Persistence error:', err);
    });

    // Global state
    let currentUser = null;
    let currentUserData = null;
    let positionCheckInterval = null;

    // Role permissions
    const PERMISSIONS = {
      President: ['all'],
      VP: ['all'],
      Secretary: ['members', 'roles', 'events', 'auditLogs', 'approvals'],
      Treasurer: ['finance', 'files', 'auditLogs'],
      Auditor: ['auditLogs'],
      PIO: ['announcements'],
      Sgt: ['view'],
      Member: ['view']
    };

    // Auth state observer
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        await loadUserData();
      } else {
        currentUser = null;
        currentUserData = null;
        showAuthSection();
      }
    });

    async function loadUserData() {
      try {
        const snapshot = await db.ref(`users/${currentUser.uid}`).once('value');
        currentUserData = snapshot.val();
        
        if (!currentUserData) {
          showError('User data not found');
          await auth.signOut();
          return;
        }

        if (currentUserData.approved === undefined || currentUserData.approved === true) {
          showOrgSelection();
        } else {
          showPendingApproval();
        }
      } catch (error) {
        console.error('Error loading user data:', error);
        showError('Failed to load user data');
      }
    }

    function showOrgSelection() {
      const savedOrgId = localStorage.getItem('selectedOrgId');
      const savedOrgName = localStorage.getItem('selectedOrgName');
      
      if (savedOrgId && savedOrgName) {
        db.ref(`organizations/${savedOrgId}`).once('value', (snapshot) => {
          const org = snapshot.val();
          if (org && org.approved) {
            selectOrganization(savedOrgId, savedOrgName);
            return;
          } else {
            localStorage.removeItem('selectedOrgId');
            localStorage.removeItem('selectedOrgName');
            showOrgSelectionUI();
          }
        });
      } else {
        showOrgSelectionUI();
      }
    }

    function showOrgSelectionUI() {
      document.getElementById('authSection').style.display = 'none';
      document.getElementById('mainApp').style.display = 'block';
      document.getElementById('pendingApprovalSection').style.display = 'none';
      document.getElementById('orgSelectionSection').style.display = 'block';
      document.getElementById('approvedAppSection').style.display = 'none';
      
      loadOrganizations();
    }

    function loadOrganizations() {
      const orgListLoading = document.getElementById('orgListLoading');
      const orgList = document.getElementById('orgList');
      
      orgListLoading.style.display = 'block';
      orgList.innerHTML = '';

      db.ref('organizations').once('value', (snapshot) => {
        orgListLoading.style.display = 'none';
        orgList.innerHTML = '';
        
        const orgs = snapshot.val();
        if (!orgs) {
          orgList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üèõÔ∏è</div><p>No organizations yet. Create the first one!</p></div>';
          return;
        }

        Object.entries(orgs).forEach(([orgId, org]) => {
          const card = document.createElement('div');
          card.className = 'member-card';
          
          const isApproved = org.approved === true;
          
          if (isApproved) {
            card.style.cursor = 'pointer';
            card.innerHTML = `
              <h3>üèõÔ∏è ${org.name}</h3>
              <p>${org.description || 'No description'}</p>
              <p><strong>Type:</strong> ${org.type || 'N/A'}</p>
            `;
            card.addEventListener('click', () => selectOrganization(orgId, org.name));
          } else {
            card.style.cursor = 'not-allowed';
            card.style.opacity = '0.6';
            card.innerHTML = `
              <h3>üèõÔ∏è ${org.name}</h3>
              <p>${org.description || 'No description'}</p>
              <p><strong>Type:</strong> ${org.type || 'N/A'}</p>
              <p style="background: #fff3cd; border: 2px solid #ffc107; padding: 8px; border-radius: 8px; margin-top: 10px; font-size: 12px; color: #856404; font-weight: 600;">‚è≥ Pending Approval</p>
            `;
          }
          
          orgList.appendChild(card);
        });
      });
    }

    async function selectOrganization(orgId, orgName) {
      CONFIG.ORG_ID = orgId;
      CONFIG.ORG_NAME = orgName;
      
      localStorage.setItem('selectedOrgId', orgId);
      localStorage.setItem('selectedOrgName', orgName);
      
      const memberSnapshot = await db.ref(`organizations/${orgId}/members/${currentUser.uid}`).once('value');
      if (!memberSnapshot.exists()) {
        await db.ref(`organizations/${orgId}/members/${currentUser.uid}`).set({
          role: 'Member',
          joinedAt: Date.now()
        });
      }
      
      startPositionMonitoring();
      showApprovedApp();
    }

    function startPositionMonitoring() {
      if (positionCheckInterval) {
        clearInterval(positionCheckInterval);
      }

      db.ref(`organizations/${CONFIG.ORG_ID}/members/${currentUser.uid}`).on('value', async (snapshot) => {
        const memberData = snapshot.val();
        
        if (!memberData) {
          showError('Your membership was removed from this organization');
          await auth.signOut();
          return;
        }

        const newRole = memberData.role || 'Member';
        const oldRole = window.currentOrgRole;

        if (oldRole && newRole !== oldRole) {
          window.currentOrgRole = newRole;
          
          const rolePill = document.getElementById('userRolePill');
          if (rolePill) {
            rolePill.className = `role-pill role-${newRole.toLowerCase()}`;
            rolePill.textContent = newRole;
          }
          
          applyRolePermissions();
          
          showSuccess(`Your role has been updated to ${newRole}`);
        } else if (!oldRole) {
          window.currentOrgRole = newRole;
        }
      });
    }

    function stopPositionMonitoring() {
      if (CONFIG.ORG_ID && currentUser) {
        db.ref(`organizations/${CONFIG.ORG_ID}/members/${currentUser.uid}`).off();
      }
      if (positionCheckInterval) {
        clearInterval(positionCheckInterval);
        positionCheckInterval = null;
      }
    }

    function showAuthSection() {
      document.getElementById('authSection').style.display = 'flex';
      document.getElementById('mainApp').style.display = 'none';
    }

    function showPendingApproval() {
      document.getElementById('authSection').style.display = 'none';
      document.getElementById('mainApp').style.display = 'block';
      document.getElementById('pendingApprovalSection').style.display = 'block';
      document.getElementById('approvedAppSection').style.display = 'none';
    }

    async function showApprovedApp() {
      document.getElementById('authSection').style.display = 'none';
      document.getElementById('mainApp').style.display = 'block';
      document.getElementById('pendingApprovalSection').style.display = 'none';
      document.getElementById('orgSelectionSection').style.display = 'none';
      document.getElementById('approvedAppSection').style.display = 'block';
      
      document.getElementById('userEmail').textContent = currentUser.email;
      
      const memberSnapshot = await db.ref(`organizations/${CONFIG.ORG_ID}/members/${currentUser.uid}`).once('value');
      const memberData = memberSnapshot.val();
      window.currentOrgRole = memberData?.role || 'Member';
      
      const rolePill = document.getElementById('userRolePill');
      rolePill.className = `role-pill role-${window.currentOrgRole.toLowerCase()}`;
      rolePill.textContent = window.currentOrgRole;
      
      document.querySelector('.header-text h1').textContent = `${CONFIG.ORG_NAME} Portal`;
      document.querySelector('.header-text p').textContent = 'Organization Management System';
      
      applyRolePermissions();
      loadAllData();
    }

    function applyRolePermissions() {
      const role = window.currentOrgRole || 'Member';
      const permissions = PERMISSIONS[role] || ['view'];
      
      if (isHeadAdmin()) {
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('hidden'));
        return;
      }
      
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('hidden'));

      if (role === 'Sgt' || role === 'Member') {
        document.querySelectorAll('.btn-secondary, .btn-danger').forEach(btn => {
          if (!btn.id.includes('export') && btn.id !== 'changeOrgBtn') {
            btn.style.display = 'none';
          }
        });
      }
    }

    function showError(message) {
      const authError = document.getElementById('authError');
      authError.textContent = message;
      authError.style.display = 'block';
      setTimeout(() => {
        authError.style.display = 'none';
      }, 5000);
    }

    function showSuccess(message) {
      const authSuccess = document.getElementById('authSuccess');
      authSuccess.textContent = message;
      authSuccess.style.display = 'block';
      setTimeout(() => {
        authSuccess.style.display = 'none';
      }, 3000);
    }

    document.getElementById('showSignup').addEventListener('click', () => {
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('signupForm').style.display = 'block';
      document.getElementById('authError').style.display = 'none';
      document.getElementById('authSuccess').style.display = 'none';
    });

    document.getElementById('showLogin').addEventListener('click', () => {
      document.getElementById('signupForm').style.display = 'none';
      document.getElementById('loginForm').style.display = 'block';
      document.getElementById('authError').style.display = 'none';
      document.getElementById('authSuccess').style.display = 'none';
    });

    document.getElementById('googleSignInBtn').addEventListener('click', async () => {
      try {
        const provider = new firebase.auth.GoogleAuthProvider();
        const result = await auth.signInWithPopup(provider);
        const user = result.user;

        const userSnapshot = await db.ref(`users/${user.uid}`).once('value');
        if (!userSnapshot.exists()) {
          const userData = {
            email: user.email,
            name: user.displayName || user.email.split('@')[0],
            role: 'Member',
            note: '',
            approved: true,
            createdAt: Date.now()
          };

          await db.ref(`users/${user.uid}`).set(userData);
          await logAudit('User Signup', `${user.email} signed up with Google as Member`);
          showSuccess('Account created successfully!');
        }
      } catch (error) {
        showError(error.message);
      }
    });

    document.getElementById('loginFormElement').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      const btn = document.getElementById('loginBtn');

      btn.disabled = true;
      btn.textContent = 'Signing in...';

      try {
        await auth.signInWithEmailAndPassword(email, password);
      } catch (error) {
        showError(error.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Sign In';
      }
    });

    document.getElementById('signupFormElement').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('signupEmail').value;
      const password = document.getElementById('signupPassword').value;
      const name = document.getElementById('signupName').value;
      const grade = document.getElementById('signupGrade').value;
      const section = document.getElementById('signupSection').value;
      const btn = document.getElementById('signupBtn');

      if (password.length < 6) {
        showError('Password must be at least 6 characters');
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Creating account...';

      try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;

        const userData = {
          email: email,
          name: name,
          grade: grade,
          section: section,
          approved: true,
          uid: user.uid,
          createdAt: Date.now(),
          isHeadAdmin: false
        };

        await db.ref(`users/${user.uid}`).set(userData);
        await logAudit('User Signup', `${email} signed up`);
        showSuccess('Account created! You can now join organizations.');
        await loadUserData();

      } catch (error) {
        showError(error.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Create Account';
      }
    });

    document.getElementById('changeOrgBtn').addEventListener('click', () => {
      stopPositionMonitoring();
      localStorage.removeItem('selectedOrgId');
      localStorage.removeItem('selectedOrgName');
      CONFIG.ORG_ID = null;
      CONFIG.ORG_NAME = null;
      showOrgSelection();
    });

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      try {
        stopPositionMonitoring();
        localStorage.removeItem('selectedOrgId');
        localStorage.removeItem('selectedOrgName');
        await auth.signOut();
        showSuccess('Logged out successfully');
      } catch (error) {
        showError(error.message);
      }
    });

    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab;
        
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.remove('active');
        });
        document.getElementById(tabName).classList.add('active');
      });
    });

    function setupModal(modalId, openBtnId, closeBtnId) {
      const modal = document.getElementById(modalId);
      const openBtn = document.getElementById(openBtnId);
      const closeBtn = document.getElementById(closeBtnId);

      if (openBtn) {
        openBtn.addEventListener('click', () => {
          modal.classList.add('active');
        });
      }

      if (closeBtn) {
        closeBtn.addEventListener('click', () => {
          modal.classList.remove('active');
        });
      }

      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.classList.remove('active');
        }
      });
    }

    setupModal('eventModal', 'addEventBtn', 'closeEventModal');
    setupModal('fileModal', 'addFileBtn', 'closeFileModal');
    setupModal('announcementModal', 'addAnnouncementBtn', 'closeAnnouncementModal');
    setupModal('financeModal', 'addIncomeBtn', 'closeFinanceModal');
    setupModal('financeModal', 'addExpenseBtn', 'closeFinanceModal');
    setupModal('createOrgModal', 'createNewOrgBtn', 'closeCreateOrgModal');

    document.getElementById('addIncomeBtn')?.addEventListener('click', () => {
      document.getElementById('financeModalTitle').textContent = 'Add Income';
      document.getElementById('financeType').value = 'income';
      document.getElementById('financeModal').classList.add('active');
    });

    document.getElementById('addExpenseBtn')?.addEventListener('click', () => {
      document.getElementById('financeModalTitle').textContent = 'Add Expense';
      document.getElementById('financeType').value = 'expense';
      document.getElementById('financeModal').classList.add('active');
    });

    document.getElementById('fileUpload').addEventListener('change', (e) => {
      const fileName = e.target.files[0]?.name || '';
      document.getElementById('fileFileName').textContent = fileName ? `Selected: ${fileName}` : '';
    });

    async function uploadToCloudinary(file) {
      const formData = new FormData();
      formData.append('file', file);
      formData.append('upload_preset', CONFIG.CLOUDINARY.UPLOAD_PRESET);

      try {
        const response = await fetch(
          `https://api.cloudinary.com/v1_1/${CONFIG.CLOUDINARY.CLOUD_NAME}/auto/upload`,
          {
            method: 'POST',
            body: formData
          }
        );

        if (!response.ok) {
          throw new Error('Upload failed');
        }

        const data = await response.json();
        return {
          url: data.secure_url,
          publicId: data.public_id,
          resourceType: data.resource_type,
          format: data.format
        };
      } catch (error) {
        throw new Error(`Failed to upload file: ${error.message}`);
      }
    }

    document.getElementById('createOrgForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const orgName = document.getElementById('newOrgName').value;
      const orgDescription = document.getElementById('newOrgDescription').value;
      const orgType = document.getElementById('newOrgType').value;
      
      const orgId = orgName.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
      
      try {
        const orgSnapshot = await db.ref(`organizations/${orgId}`).once('value');
        if (orgSnapshot.exists()) {
          showError('An organization with this name already exists');
          return;
        }

        const orgData = {
          name: orgName,
          description: orgDescription,
          type: orgType,
          createdBy: currentUser.email,
          createdAt: Date.now(),
          approved: false
        };

        await db.ref(`organizations/${orgId}`).set(orgData);
        
        document.getElementById('createOrgModal').classList.remove('active');
        document.getElementById('createOrgForm').reset();
        
        showSuccess('Organization submitted for approval! You will be notified when it\'s approved.');
        
        await sendDiscordNotification(
          `üÜï New Organization Request`,
          `Name: ${orgName}\nType: ${orgType}\nDescription: ${orgDescription}\nCreated by: ${currentUser.email}`,
          'System'
        );

        loadOrganizations();
      } catch (error) {
        showError('Failed to create organization: ' + error.message);
      }
    });

    document.getElementById('eventForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const eventData = {
        title: document.getElementById('eventTitle').value,
        date: document.getElementById('eventDate').value,
        location: document.getElementById('eventLocation').value,
        description: document.getElementById('eventDescription').value || 'No description',
        createdBy: currentUser.email,
        timestamp: Date.now()
      };

      try {
        await db.ref(`organizations/${CONFIG.ORG_ID}/events`).push(eventData);
        document.getElementById('eventModal').classList.remove('active');
        document.getElementById('eventForm').reset();
        showSuccess('Event added successfully!');
        
        await logAudit('Event Created', `${eventData.title} created by ${currentUser.email}`);
      } catch (error) {
        showError('Failed to add event: ' + error.message);
      }
    });

    document.getElementById('fileForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const fileInput = document.getElementById('fileUpload');
      const file = fileInput.files[0];
      
      if (!file) {
        showError('Please select a file to upload');
        return;
      }

      const maxSize = 50 * 1024 * 1024; // 50MB in bytes
      if (file.size > maxSize) {
        showError('File size must be 50MB or less');
        return;
      }

      const uploadBtn = document.getElementById('uploadFileBtn');
      const progressDiv = document.getElementById('fileUploadProgress');
      const progressFill = document.getElementById('fileProgressFill');

      uploadBtn.disabled = true;
      uploadBtn.textContent = 'Uploading...';
      progressDiv.style.display = 'block';
      progressFill.style.width = '30%';

      try {
        const uploadResult = await uploadToCloudinary(file);
        progressFill.style.width = '70%';

        const fileData = {
          title: document.getElementById('fileTitle').value,
          description: document.getElementById('fileDescription').value || 'No description',
          fileName: file.name,
          fileUrl: uploadResult.url,
          cloudinaryPublicId: uploadResult.publicId,
          fileType: uploadResult.resourceType,
          format: uploadResult.format,
          uploadedBy: currentUser.email,
          timestamp: Date.now()
        };

        await db.ref(`organizations/${CONFIG.ORG_ID}/files`).push(fileData);
        progressFill.style.width = '100%';

        setTimeout(() => {
          document.getElementById('fileModal').classList.remove('active');
          document.getElementById('fileForm').reset();
          document.getElementById('fileFileName').textContent = '';
          progressDiv.style.display = 'none';
          progressFill.style.width = '0%';
          showSuccess('File uploaded successfully!');
        }, 1000);

        await logAudit('File Uploaded', `${fileData.title} uploaded by ${currentUser.email}`);

      } catch (error) {
        showError(error.message);
        progressDiv.style.display = 'none';
      } finally {
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'Upload File';
      }
    });

    document.getElementById('announcementForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const announcementData = {
        title: document.getElementById('announcementTitle').value,
        content: document.getElementById('announcementContent').value,
        postedBy: currentUser.email,
        timestamp: Date.now()
      };

      try {
        await db.ref(`organizations/${CONFIG.ORG_ID}/announcements`).push(announcementData);
        document.getElementById('announcementModal').classList.remove('active');
        document.getElementById('announcementForm').reset();
        showSuccess('Announcement posted!');
        
        await sendDiscordNotification(
          `üì¢ New Announcement: ${announcementData.title}`,
          announcementData.content,
          announcementData.postedBy
        );

        await logAudit('Announcement Posted', `${announcementData.title} by ${currentUser.email}`);
      } catch (error) {
        showError('Failed to post announcement: ' + error.message);
      }
    });

    document.getElementById('financeForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const transactionData = {
        type: document.getElementById('financeType').value,
        description: document.getElementById('financeDescription').value,
        amount: parseFloat(document.getElementById('financeAmount').value),
        recordedBy: currentUser.email,
        timestamp: Date.now()
      };

      try {
        await db.ref(`organizations/${CONFIG.ORG_ID}/finance`).push(transactionData);
        document.getElementById('financeModal').classList.remove('active');
        document.getElementById('financeForm').reset();
        showSuccess('Transaction added successfully!');
        
        await logAudit('Finance Transaction', `${transactionData.type}: ‚Ç±${transactionData.amount} by ${currentUser.email}`);
      } catch (error) {
        showError('Failed to add transaction: ' + error.message);
      }
    });

    function loadAllData() {
      loadMembers();
      loadEvents();
      loadFiles();
      loadAnnouncements();
      loadApprovals();
      loadAuditLogs();
      loadRoles();
      loadFinance();
    }

    function loadMembers() {
      const membersLoading = document.getElementById('membersLoading');
      const membersList = document.getElementById('membersList');
      
      membersLoading.style.display = 'block';
      membersList.innerHTML = '';

      db.ref(`organizations/${CONFIG.ORG_ID}/members`).on('value', async (snapshot) => {
        membersLoading.style.display = 'none';
        membersList.innerHTML = '';
        
        const members = snapshot.val();
        if (!members) {
          membersList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üë•</div><p>No members yet.</p></div>';
          document.getElementById('memberCount').textContent = '0';
          return;
        }

        const memberCount = Object.keys(members).length;
        document.getElementById('memberCount').textContent = memberCount;

        for (const [uid, memberData] of Object.entries(members)) {
          const userSnapshot = await db.ref(`users/${uid}`).once('value');
          const user = userSnapshot.val();
          
          if (!user) continue;

          const card = document.createElement('div');
          card.className = 'member-card';
          const rolePill = memberData.role ? `<span class="role-pill role-${memberData.role.toLowerCase()}">${memberData.role}</span>` : '';
          card.innerHTML = `
            <h3>${user.name || user.email.split('@')[0]} ${rolePill}</h3>
            <p>üìß ${user.email}</p>
            <p>üéì Grade ${user.grade || 'N/A'} - Section ${user.section || 'N/A'}</p>
            <p style="font-size: 12px; color: #999;">Joined: ${new Date(memberData.joinedAt || Date.now()).toLocaleDateString()}</p>
            ${(checkOrgRole(['President']) || isHeadAdmin()) && uid !== currentUser.uid ? `<button class="btn-danger" onclick="removeMember('${uid}')">Remove</button>` : ''}
          `;
          membersList.appendChild(card);
        }
      });
    }

    function loadEvents() {
      const eventsLoading = document.getElementById('eventsLoading');
      const eventsList = document.getElementById('eventsList');
      
      eventsLoading.style.display = 'block';
      eventsList.innerHTML = '';

      db.ref(`organizations/${CONFIG.ORG_ID}/events`).on('value', (snapshot) => {
        eventsLoading.style.display = 'none';
        eventsList.innerHTML = '';
        
        const events = snapshot.val();
        if (!events) {
          eventsList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìÖ</div><p>No events scheduled. Add your first event!</p></div>';
          document.getElementById('eventCount').textContent = '0';
          return;
        }

        const eventCount = Object.keys(events).length;
        document.getElementById('eventCount').textContent = eventCount;

        const attendanceSelect = document.getElementById('attendanceEvent');
        attendanceSelect.innerHTML = '<option value="">Choose an event...</option>';

        Object.entries(events).forEach(([key, event]) => {
          const eventDate = new Date(event.date);
          const card = document.createElement('div');
          card.className = 'event-card';
          card.innerHTML = `
            <h3>${event.title}</h3>
            <p>üìÖ ${eventDate.toLocaleDateString()} ${eventDate.toLocaleTimeString()}</p>
            <p>üìç ${event.location}</p>
            <p>${event.description}</p>
            <button class="btn-secondary" onclick="exportICS('${key}')">üì• Export ICS</button>
            ${canEdit() ? `<button class="btn-danger" onclick="deleteEvent('${key}')">Delete</button>` : ''}
          `;
          eventsList.appendChild(card);

          const option = document.createElement('option');
          option.value = key;
          option.textContent = event.title;
          attendanceSelect.appendChild(option);
        });
      });
    }

    function loadFiles() {
      const filesLoading = document.getElementById('filesLoading');
      const filesList = document.getElementById('filesList');
      
      filesLoading.style.display = 'block';
      filesList.innerHTML = '';

      db.ref(`organizations/${CONFIG.ORG_ID}/files`).on('value', (snapshot) => {
        filesLoading.style.display = 'none';
        filesList.innerHTML = '';
        
        const files = snapshot.val();
        if (!files) {
          filesList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìÅ</div><p>No files yet. Upload your first file!</p></div>';
          document.getElementById('resourceCount').textContent = '0';
          return;
        }

        const fileCount = Object.keys(files).length;
        document.getElementById('resourceCount').textContent = fileCount;

        Object.entries(files).forEach(([key, file]) => {
          const card = document.createElement('div');
          card.className = 'resource-card';
          card.innerHTML = `
            <h3>${file.title}</h3>
            <p>${file.description}</p>
            <p>üìé ${file.fileName}</p>
            <p style="font-size: 12px; color: #999;">Uploaded by: ${file.uploadedBy}</p>
            <button class="btn-secondary" onclick="window.open('${file.fileUrl}', '_blank')">üì• Download</button>
            ${canEdit() ? `<button class="btn-danger" onclick="deleteFile('${key}')">Delete</button>` : ''}
          `;
          filesList.appendChild(card);
        });
      });
    }

    function loadAnnouncements() {
      const announcementsLoading = document.getElementById('announcementsLoading');
      const announcementsList = document.getElementById('announcementsList');
      
      announcementsLoading.style.display = 'block';
      announcementsList.innerHTML = '';

      db.ref(`organizations/${CONFIG.ORG_ID}/announcements`).orderByChild('timestamp').on('value', (snapshot) => {
        announcementsLoading.style.display = 'none';
        announcementsList.innerHTML = '';
        
        const announcements = snapshot.val();
        if (!announcements) {
          announcementsList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì¢</div><p>No announcements yet. Post your first announcement!</p></div>';
          document.getElementById('announcementCount').textContent = '0';
          return;
        }

        const announcementCount = Object.keys(announcements).length;
        document.getElementById('announcementCount').textContent = announcementCount;

        const sortedAnnouncements = Object.entries(announcements).sort((a, b) => b[1].timestamp - a[1].timestamp);

        sortedAnnouncements.forEach(([key, announcement]) => {
          const date = new Date(announcement.timestamp);
          const card = document.createElement('div');
          card.className = 'announcement-item';
          card.innerHTML = `
            <h3>${announcement.title}</h3>
            <p>${announcement.content}</p>
            <p class="announcement-date">Posted by: ${announcement.postedBy} | ${date.toLocaleString()}</p>
            ${canEdit() ? `<button class="btn-danger" onclick="deleteAnnouncement('${key}')" style="margin-top: 10px;">Delete</button>` : ''}
          `;
          announcementsList.appendChild(card);
        });
      });
    }

    function loadApprovals() {
      const approvalsLoading = document.getElementById('approvalsLoading');
      const approvalsList = document.getElementById('approvalsList');
      
      approvalsLoading.style.display = 'block';
      approvalsList.innerHTML = '';

      db.ref(`organizations/${CONFIG.ORG_ID}/role_requests`).on('value', (snapshot) => {
        approvalsLoading.style.display = 'none';
        approvalsList.innerHTML = '';
        
        const requests = snapshot.val();
        if (!requests) {
          approvalsList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚úÖ</div><p>No pending role requests</p></div>';
          return;
        }

        Object.entries(requests).forEach(([requestId, request]) => {
          if (request.approved !== undefined) {
            return;
          }

          const card = document.createElement('div');
          card.className = 'approval-card';
          card.innerHTML = `
            <h3>${request.name || request.email}</h3>
            <p><strong>Email:</strong> ${request.email}</p>
            <p><strong>Requested Role:</strong> <span class="role-pill role-${request.role.toLowerCase()}">${request.role}</span></p>
            <p><strong>Note:</strong> ${request.note}</p>
            <p style="font-size: 12px; color: #999;">Requested: ${new Date(request.requestedAt).toLocaleString()}</p>
            ${(canApprove() || isHeadAdmin()) ? `
              <button class="btn-success" onclick="approveRoleRequest('${requestId}', '${request.uid}', '${request.role}')">‚úÖ Approve</button>
              <button class="btn-danger" onclick="rejectRoleRequest('${requestId}')">‚ùå Reject</button>
            ` : ''}
          `;
          approvalsList.appendChild(card);
        });
      });
    }

    async function approveRoleRequest(requestId, uid, role) {
      try {
        const requestSnapshot = await db.ref(`organizations/${CONFIG.ORG_ID}/role_requests/${requestId}`).once('value');
        const requestData = requestSnapshot.val();

        const roleSnapshot = await db.ref(`organizations/${CONFIG.ORG_ID}/roles/${role}`).once('value');
        if (roleSnapshot.exists()) {
          showError('This role is already filled!');
          return;
        }

        await db.ref(`organizations/${CONFIG.ORG_ID}/roles/${role}`).set({
          uid: uid,
          email: requestData.email,
          name: requestData.name,
          assignedAt: Date.now()
        });

        await db.ref(`organizations/${CONFIG.ORG_ID}/members/${uid}/role`).set(role);

        await db.ref(`organizations/${CONFIG.ORG_ID}/role_requests/${requestId}`).update({
          approved: true,
          approvedAt: Date.now(),
          approvedBy: currentUser.email
        });

        showSuccess('Role request approved!');
        
        await sendDiscordNotification(
          `‚úÖ Role Request Approved`,
          `${requestData.email} has been assigned as ${role} in ${CONFIG.ORG_NAME}`,
          currentUser.email
        );

        await logAudit('Role Assigned', `${requestData.email} approved as ${role} by ${currentUser.email}`);
      } catch (error) {
        showError('Failed to approve request: ' + error.message);
      }
    }

    async function rejectRoleRequest(requestId) {
      try {
        const requestSnapshot = await db.ref(`organizations/${CONFIG.ORG_ID}/role_requests/${requestId}`).once('value');
        const requestData = requestSnapshot.val();

        await db.ref(`organizations/${CONFIG.ORG_ID}/role_requests/${requestId}`).update({
          approved: false,
          rejectedAt: Date.now(),
          rejectedBy: currentUser.email
        });
        
        showSuccess('Role request rejected');
        
        await logAudit('Role Request Rejected', `${requestData.email}'s ${requestData.role} request rejected by ${currentUser.email}`);
      } catch (error) {
        showError('Failed to reject request: ' + error.message);
      }
    }

    function loadAuditLogs() {
      const auditLogsLoading = document.getElementById('auditLogsLoading');
      const auditLogsList = document.getElementById('auditLogsList');
      
      auditLogsLoading.style.display = 'block';
      auditLogsList.innerHTML = '';

      db.ref(`organizations/${CONFIG.ORG_ID}/audit_logs`).orderByChild('timestamp').limitToLast(50).on('value', (snapshot) => {
        auditLogsLoading.style.display = 'none';
        auditLogsList.innerHTML = '';
        
        const logs = snapshot.val();
        if (!logs) {
          auditLogsList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìã</div><p>No audit logs yet</p></div>';
          return;
        }

        const sortedLogs = Object.entries(logs).sort((a, b) => b[1].timestamp - a[1].timestamp);

        sortedLogs.forEach(([key, log]) => {
          const date = new Date(log.timestamp);
          const item = document.createElement('div');
          item.className = 'audit-log-item';
          item.innerHTML = `
            <p><strong>${log.action}</strong></p>
            <p>${log.description}</p>
            <p class="audit-log-time">${date.toLocaleString()}</p>
          `;
          auditLogsList.appendChild(item);
        });
      });
    }

    function loadRoles() {
      const rolesTableBody = document.getElementById('rolesTableBody');
      rolesTableBody.innerHTML = '';

      db.ref(`organizations/${CONFIG.ORG_ID}/roles`).on('value', (snapshot) => {
        rolesTableBody.innerHTML = '';
        
        const roles = snapshot.val();
        const allOfficerRoles = ['President', 'VP', 'Secretary', 'Treasurer', 'Auditor', 'PIO', 'Sgt'];

        allOfficerRoles.forEach(role => {
          const roleData = roles?.[role];
          const row = document.createElement('tr');
          const rolePill = `<span class="role-pill role-${role.toLowerCase()}">${role}</span>`;
          
          if (roleData && roleData.uid) {
            row.innerHTML = `
              <td>${rolePill}</td>
              <td>${roleData.name || roleData.email.split('@')[0]}</td>
              <td>${roleData.email}</td>
              <td>${(canApprove() || isHeadAdmin()) ? `<button class="btn-danger" onclick="removeRole('${role}', '${roleData.uid}')">Remove</button>` : '-'}</td>
            `;
          } else {
            row.innerHTML = `
              <td>${rolePill}</td>
              <td style="color: #999; font-style: italic;">Vacant</td>
              <td>-</td>
              <td>-</td>
            `;
          }
          
          rolesTableBody.appendChild(row);
        });
      });
    }

    async function removeRole(role, uid) {
      const confirmDiv = document.createElement('div');
      confirmDiv.style.position = 'fixed';
      confirmDiv.style.top = '50%';
      confirmDiv.style.left = '50%';
      confirmDiv.style.transform = 'translate(-50%, -50%)';
      confirmDiv.style.background = 'white';
      confirmDiv.style.padding = '30px';
      confirmDiv.style.borderRadius = '15px';
      confirmDiv.style.boxShadow = '0 4px 20px rgba(0,0,0,0.3)';
      confirmDiv.style.zIndex = '10000';
      confirmDiv.innerHTML = `
        <h3 style="margin-bottom: 15px;">Remove Role?</h3>
        <p style="margin-bottom: 20px;">Remove ${role} role from this user?</p>
        <button id="confirmRemoveRole" class="btn-danger">Remove</button>
        <button id="cancelRemoveRole" class="btn-secondary" style="margin-left: 10px;">Cancel</button>
      `;
      
      const overlay = document.createElement('div');
      overlay.style.position = 'fixed';
      overlay.style.top = '0';
      overlay.style.left = '0';
      overlay.style.width = '100%';
      overlay.style.height = '100%';
      overlay.style.background = 'rgba(0,0,0,0.5)';
      overlay.style.zIndex = '9999';
      
      document.body.appendChild(overlay);
      document.body.appendChild(confirmDiv);
      
      document.getElementById('confirmRemoveRole').onclick = async () => {
        try {
          await db.ref(`organizations/${CONFIG.ORG_ID}/roles/${role}`).remove();
          await db.ref(`organizations/${CONFIG.ORG_ID}/members/${uid}/role`).set('Member');
          
          showSuccess('Role removed successfully');
          await logAudit('Role Removed', `${role} role removed by ${currentUser.email}`);
        } catch (error) {
          showError('Failed to remove role: ' + error.message);
        } finally {
          document.body.removeChild(confirmDiv);
          document.body.removeChild(overlay);
        }
      };
      
      document.getElementById('cancelRemoveRole').onclick = () => {
        document.body.removeChild(confirmDiv);
        document.body.removeChild(overlay);
      };
    }

    function loadFinance() {
      const financeTableBody = document.getElementById('financeTableBody');
      financeTableBody.innerHTML = '';

      db.ref(`organizations/${CONFIG.ORG_ID}/finance`).on('value', (snapshot) => {
        financeTableBody.innerHTML = '';
        
        const transactions = snapshot.val();
        if (!transactions) {
          financeTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px;">No transactions yet</td></tr>';
          updateFinanceSummary([], []);
          return;
        }

        const income = [];
        const expenses = [];

        const sortedTransactions = Object.entries(transactions).sort((a, b) => b[1].timestamp - a[1].timestamp);

        sortedTransactions.forEach(([key, transaction]) => {
          const date = new Date(transaction.timestamp);
          const row = document.createElement('tr');
          
          if (transaction.type === 'income') {
            income.push(transaction.amount);
          } else {
            expenses.push(transaction.amount);
          }

          const typeColor = transaction.type === 'income' ? 'green' : 'red';
          const typeText = transaction.type === 'income' ? '+ ‚Ç±' : '- ‚Ç±';
          
          row.innerHTML = `
            <td>${date.toLocaleDateString()}</td>
            <td><span style="color: ${typeColor}; font-weight: 600;">${transaction.type.toUpperCase()}</span></td>
            <td>${transaction.description}</td>
            <td style="color: ${typeColor}; font-weight: 600;">${typeText}${transaction.amount.toFixed(2)}</td>
            <td>${transaction.recordedBy}</td>
            <td>${canEdit() ? `<button class="btn-danger" onclick="deleteFinance('${key}')">Delete</button>` : '-'}</td>
          `;
          financeTableBody.appendChild(row);
        });

        updateFinanceSummary(income, expenses);
      });
    }

    function updateFinanceSummary(income, expenses) {
      const totalIncome = income.reduce((sum, val) => sum + val, 0);
      const totalExpense = expenses.reduce((sum, val) => sum + val, 0);
      const netBalance = totalIncome - totalExpense;

      document.getElementById('totalIncome').textContent = `‚Ç±${totalIncome.toFixed(2)}`;
      document.getElementById('totalExpense').textContent = `‚Ç±${totalExpense.toFixed(2)}`;
      document.getElementById('netBalance').textContent = `‚Ç±${netBalance.toFixed(2)}`;
    }

    function isHeadAdmin() {
      if (!currentUserData) return false;
      return currentUserData.isHeadAdmin === true;
    }

    function canEdit() {
      if (!currentUserData) return false;
      if (isHeadAdmin()) return true;
      return checkOrgRole(['President', 'VP', 'Secretary', 'Treasurer']);
    }

    function canApprove() {
      if (!currentUserData) return false;
      if (isHeadAdmin()) return true;
      return checkOrgRole(['President', 'VP']);
    }

    function checkOrgRole(allowedRoles) {
      const memberRole = window.currentOrgRole || 'Member';
      return allowedRoles.includes(memberRole);
    }

    async function removeMember(uid) {
      const confirmDiv = document.createElement('div');
      confirmDiv.style.position = 'fixed';
      confirmDiv.style.top = '50%';
      confirmDiv.style.left = '50%';
      confirmDiv.style.transform = 'translate(-50%, -50%)';
      confirmDiv.style.background = 'white';
      confirmDiv.style.padding = '30px';
      confirmDiv.style.borderRadius = '15px';
      confirmDiv.style.boxShadow = '0 4px 20px rgba(0,0,0,0.3)';
      confirmDiv.style.zIndex = '10000';
      confirmDiv.innerHTML = `
        <h3 style="margin-bottom: 15px;">Remove Member?</h3>
        <p style="margin-bottom: 20px;">Are you sure you want to remove this member?</p>
        <button id="confirmRemoveMember" class="btn-danger">Remove</button>
        <button id="cancelRemoveMember" class="btn-secondary" style="margin-left: 10px;">Cancel</button>
      `;
      
      const overlay = document.createElement('div');
      overlay.style.position = 'fixed';
      overlay.style.top = '0';
      overlay.style.left = '0';
      overlay.style.width = '100%';
      overlay.style.height = '100%';
      overlay.style.background = 'rgba(0,0,0,0.5)';
      overlay.style.zIndex = '9999';
      
      document.body.appendChild(overlay);
      document.body.appendChild(confirmDiv);
      
      document.getElementById('confirmRemoveMember').onclick = async () => {
        try {
          const snapshot = await db.ref(`users/${uid}`).once('value');
          const user = snapshot.val();
          
          await db.ref(`users/${uid}`).remove();
          showSuccess('Member removed successfully');
          
          await logAudit('Member Removed', `${user.name || user.email} removed by ${currentUser.email}`);
        } catch (error) {
          showError('Failed to remove member: ' + error.message);
        } finally {
          document.body.removeChild(confirmDiv);
          document.body.removeChild(overlay);
        }
      };
      
      document.getElementById('cancelRemoveMember').onclick = () => {
        document.body.removeChild(confirmDiv);
        document.body.removeChild(overlay);
      };
    }

    function deleteEvent(key) {
      const confirmDiv = document.createElement('div');
      confirmDiv.style.position = 'fixed';
      confirmDiv.style.top = '50%';
      confirmDiv.style.left = '50%';
      confirmDiv.style.transform = 'translate(-50%, -50%)';
      confirmDiv.style.background = 'white';
      confirmDiv.style.padding = '30px';
      confirmDiv.style.borderRadius = '15px';
      confirmDiv.style.boxShadow = '0 4px 20px rgba(0,0,0,0.3)';
      confirmDiv.style.zIndex = '10000';
      confirmDiv.innerHTML = `
        <h3 style="margin-bottom: 15px;">Delete Event?</h3>
        <p style="margin-bottom: 20px;">Are you sure you want to delete this event?</p>
        <button id="confirmDeleteEvent" class="btn-danger">Delete</button>
        <button id="cancelDeleteEvent" class="btn-secondary" style="margin-left: 10px;">Cancel</button>
      `;
      
      const overlay = document.createElement('div');
      overlay.style.position = 'fixed';
      overlay.style.top = '0';
      overlay.style.left = '0';
      overlay.style.width = '100%';
      overlay.style.height = '100%';
      overlay.style.background = 'rgba(0,0,0,0.5)';
      overlay.style.zIndex = '9999';
      
      document.body.appendChild(overlay);
      document.body.appendChild(confirmDiv);
      
      document.getElementById('confirmDeleteEvent').onclick = async () => {
        try {
          const snapshot = await db.ref(`organizations/${CONFIG.ORG_ID}/events/${key}`).once('value');
          const event = snapshot.val();
          
          await db.ref(`organizations/${CONFIG.ORG_ID}/events/${key}`).remove();
          showSuccess('Event deleted successfully');
          
          await logAudit('Event Deleted', `${event.title} deleted by ${currentUser.email}`);
        } catch (error) {
          showError('Failed to delete event: ' + error.message);
        } finally {
          document.body.removeChild(confirmDiv);
          document.body.removeChild(overlay);
        }
      };
      
      document.getElementById('cancelDeleteEvent').onclick = () => {
        document.body.removeChild(confirmDiv);
        document.body.removeChild(overlay);
      };
    }

    function deleteFile(key) {
      const confirmDiv = document.createElement('div');
      confirmDiv.style.position = 'fixed';
      confirmDiv.style.top = '50%';
      confirmDiv.style.left = '50%';
      confirmDiv.style.transform = 'translate(-50%, -50%)';
      confirmDiv.style.background = 'white';
      confirmDiv.style.padding = '30px';
      confirmDiv.style.borderRadius = '15px';
      confirmDiv.style.boxShadow = '0 4px 20px rgba(0,0,0,0.3)';
      confirmDiv.style.zIndex = '10000';
      confirmDiv.innerHTML = `
        <h3 style="margin-bottom: 15px;">Delete File?</h3>
        <p style="margin-bottom: 20px;">Are you sure you want to delete this file?</p>
        <button id="confirmDeleteFile" class="btn-danger">Delete</button>
        <button id="cancelDeleteFile" class="btn-secondary" style="margin-left: 10px;">Cancel</button>
      `;
      
      const overlay = document.createElement('div');
      overlay.style.position = 'fixed';
      overlay.style.top = '0';
      overlay.style.left = '0';
      overlay.style.width = '100%';
      overlay.style.height = '100%';
      overlay.style.background = 'rgba(0,0,0,0.5)';
      overlay.style.zIndex = '9999';
      
      document.body.appendChild(overlay);
      document.body.appendChild(confirmDiv);
      
      document.getElementById('confirmDeleteFile').onclick = async () => {
        try {
          const snapshot = await db.ref(`organizations/${CONFIG.ORG_ID}/files/${key}`).once('value');
          const file = snapshot.val();
          
          await db.ref(`organizations/${CONFIG.ORG_ID}/files/${key}`).remove();
          showSuccess('File deleted successfully');
          
          await logAudit('File Deleted', `${file.title} deleted by ${currentUser.email}`);
        } catch (error) {
          showError('Failed to delete file: ' + error.message);
        } finally {
          document.body.removeChild(confirmDiv);
          document.body.removeChild(overlay);
        }
      };
      
      document.getElementById('cancelDeleteFile').onclick = () => {
        document.body.removeChild(confirmDiv);
        document.body.removeChild(overlay);
      };
    }

    function deleteAnnouncement(key) {
      const confirmDiv = document.createElement('div');
      confirmDiv.style.position = 'fixed';
      confirmDiv.style.top = '50%';
      confirmDiv.style.left = '50%';
      confirmDiv.style.transform = 'translate(-50%, -50%)';
      confirmDiv.style.background = 'white';
      confirmDiv.style.padding = '30px';
      confirmDiv.style.borderRadius = '15px';
      confirmDiv.style.boxShadow = '0 4px 20px rgba(0,0,0,0.3)';
      confirmDiv.style.zIndex = '10000';
      confirmDiv.innerHTML = `
        <h3 style="margin-bottom: 15px;">Delete Announcement?</h3>
        <p style="margin-bottom: 20px;">Are you sure you want to delete this announcement?</p>
        <button id="confirmDeleteAnnouncement" class="btn-danger">Delete</button>
        <button id="cancelDeleteAnnouncement" class="btn-secondary" style="margin-left: 10px;">Cancel</button>
      `;
      
      const overlay = document.createElement('div');
      overlay.style.position = 'fixed';
      overlay.style.top = '0';
      overlay.style.left = '0';
      overlay.style.width = '100%';
      overlay.style.height = '100%';
      overlay.style.background = 'rgba(0,0,0,0.5)';
      overlay.style.zIndex = '9999';
      
      document.body.appendChild(overlay);
      document.body.appendChild(confirmDiv);
      
      document.getElementById('confirmDeleteAnnouncement').onclick = async () => {
        try {
          const snapshot = await db.ref(`organizations/${CONFIG.ORG_ID}/announcements/${key}`).once('value');
          const announcement = snapshot.val();
          
          await db.ref(`organizations/${CONFIG.ORG_ID}/announcements/${key}`).remove();
          showSuccess('Announcement deleted successfully');
          
          await logAudit('Announcement Deleted', `${announcement.title} deleted by ${currentUser.email}`);
        } catch (error) {
          showError('Failed to delete announcement: ' + error.message);
        } finally {
          document.body.removeChild(confirmDiv);
          document.body.removeChild(overlay);
        }
      };
      
      document.getElementById('cancelDeleteAnnouncement').onclick = () => {
        document.body.removeChild(confirmDiv);
        document.body.removeChild(overlay);
      };
    }

    function deleteFinance(key) {
      const confirmDiv = document.createElement('div');
      confirmDiv.style.position = 'fixed';
      confirmDiv.style.top = '50%';
      confirmDiv.style.left = '50%';
      confirmDiv.style.transform = 'translate(-50%, -50%)';
      confirmDiv.style.background = 'white';
      confirmDiv.style.padding = '30px';
      confirmDiv.style.borderRadius = '15px';
      confirmDiv.style.boxShadow = '0 4px 20px rgba(0,0,0,0.3)';
      confirmDiv.style.zIndex = '10000';
      confirmDiv.innerHTML = `
        <h3 style="margin-bottom: 15px;">Delete Transaction?</h3>
        <p style="margin-bottom: 20px;">Are you sure you want to delete this transaction?</p>
        <button id="confirmDeleteFinance" class="btn-danger">Delete</button>
        <button id="cancelDeleteFinance" class="btn-secondary" style="margin-left: 10px;">Cancel</button>
      `;
      
      const overlay = document.createElement('div');
      overlay.style.position = 'fixed';
      overlay.style.top = '0';
      overlay.style.left = '0';
      overlay.style.width = '100%';
      overlay.style.height = '100%';
      overlay.style.background = 'rgba(0,0,0,0.5)';
      overlay.style.zIndex = '9999';
      
      document.body.appendChild(overlay);
      document.body.appendChild(confirmDiv);
      
      document.getElementById('confirmDeleteFinance').onclick = async () => {
        try {
          await db.ref(`organizations/${CONFIG.ORG_ID}/finance/${key}`).remove();
          showSuccess('Transaction deleted successfully');
          
          await logAudit('Finance Transaction Deleted', `Transaction deleted by ${currentUser.email}`);
        } catch (error) {
          showError('Failed to delete transaction: ' + error.message);
        } finally {
          document.body.removeChild(confirmDiv);
          document.body.removeChild(overlay);
        }
      };
      
      document.getElementById('cancelDeleteFinance').onclick = () => {
        document.body.removeChild(confirmDiv);
        document.body.removeChild(overlay);
      };
    }

    function exportICS(eventKey) {
      db.ref(`organizations/${CONFIG.ORG_ID}/events/${eventKey}`).once('value', (snapshot) => {
        const event = snapshot.val();
        const eventDate = new Date(event.date);
        
        const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//CVSU//Organization Portal//EN
BEGIN:VEVENT
UID:${eventKey}@cvsu-portal
DTSTAMP:${formatICSDate(new Date())}
DTSTART:${formatICSDate(eventDate)}
SUMMARY:${event.title}
DESCRIPTION:${event.description}
LOCATION:${event.location}
END:VEVENT
END:VCALENDAR`;

        const blob = new Blob([icsContent], { type: 'text/calendar' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${event.title.replace(/\s+/g, '_')}.ics`;
        a.click();
        URL.revokeObjectURL(url);
      });
    }

    function formatICSDate(date) {
      return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
    }

    document.getElementById('exportAttendanceBtn')?.addEventListener('click', () => {
      showSuccess('Attendance export feature coming soon!');
    });

    document.getElementById('exportFinanceBtn')?.addEventListener('click', () => {
      db.ref(`organizations/${CONFIG.ORG_ID}/finance`).once('value', (snapshot) => {
        const transactions = snapshot.val();
        if (!transactions) {
          showError('No transactions to export');
          return;
        }

        let csv = 'Date,Type,Description,Amount,Recorded By\n';
        Object.values(transactions).forEach(t => {
          const date = new Date(t.timestamp).toLocaleDateString();
          csv += `${date},${t.type},${t.description},${t.amount},${t.recordedBy}\n`;
        });

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'finance_records.csv';
        a.click();
        URL.revokeObjectURL(url);
      });
    });

    document.getElementById('exportAuditBtn')?.addEventListener('click', () => {
      db.ref(`organizations/${CONFIG.ORG_ID}/audit_logs`).once('value', (snapshot) => {
        const logs = snapshot.val();
        if (!logs) {
          showError('No audit logs to export');
          return;
        }

        let csv = 'Date,Action,Description\n';
        Object.values(logs).forEach(log => {
          const date = new Date(log.timestamp).toLocaleString();
          csv += `${date},${log.action},${log.description}\n`;
        });

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'audit_logs.csv';
        a.click();
        URL.revokeObjectURL(url);
      });
    });

    async function sendDiscordNotification(title, content, author) {
      try {
        await fetch(CONFIG.DISCORD_WEBHOOK, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            embeds: [{
              title: title,
              description: content,
              color: 6750054,
              footer: { text: `By: ${author}` },
              timestamp: new Date().toISOString()
            }]
          })
        });
      } catch (error) {
        console.error('Discord notification failed:', error);
      }
    }

    async function logAudit(action, description) {
      try {
        await db.ref(`organizations/${CONFIG.ORG_ID}/audit_logs`).push({
          action: action,
          description: description,
          timestamp: Date.now()
        });
      } catch (error) {
        console.error('Audit log failed:', error);
      }
    }

    window.removeMember = removeMember;
    window.deleteEvent = deleteEvent;
    window.deleteFile = deleteFile;
    window.deleteAnnouncement = deleteAnnouncement;
    window.deleteFinance = deleteFinance;
    window.exportICS = exportICS;
    window.approveRoleRequest = approveRoleRequest;
    window.rejectRoleRequest = rejectRoleRequest;
    window.removeRole = removeRole;
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a30dda1337b705c',t:'MTc2MzkwMjk5Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
