<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CVSU Batch Officers Portal</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <style>
    :root {
      --primary: #1e40af;
      --primary-dark: #1e3a8a;
      --secondary: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --info: #3b82f6;
      --dark: #1f2937;
      --light: #f3f4f6;
      --border: #e5e7eb;
      --text: #111827;
      --text-muted: #6b7280;
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: var(--text);
      min-height: 100%;
      overflow-x: hidden;
    }
    
    #authScreen {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100%;
      padding: 20px;
    }
    
    .auth-container {
      background: white;
      border-radius: 16px;
      box-shadow: var(--shadow-lg);
      max-width: 450px;
      width: 100%;
      padding: 40px;
      animation: slideUp 0.5s ease;
    }
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .auth-header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .auth-header h1 {
      color: var(--primary);
      font-size: 28px;
      margin-bottom: 8px;
    }
    
    .auth-header p {
      color: var(--text-muted);
      font-size: 14px;
    }
    
    .auth-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      border-bottom: 2px solid var(--border);
    }
    
    .auth-tab {
      flex: 1;
      padding: 12px;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      color: var(--text-muted);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .auth-tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }
    
    .auth-form {
      display: none;
    }
    
    .auth-form.active {
      display: block;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text);
      font-size: 14px;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    .form-hint {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }
    
    .form-warning {
      background: #fef3c7;
      border-left: 4px solid var(--warning);
      padding: 12px;
      margin-bottom: 20px;
      border-radius: 4px;
      font-size: 13px;
      color: #92400e;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
      width: 100%;
    }
    
    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    .btn-secondary {
      background: var(--light);
      color: var(--text);
      width: 100%;
    }
    
    .btn-secondary:hover {
      background: var(--border);
    }
    
    .btn-google {
      background: white;
      color: var(--text);
      border: 2px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: 100%;
      margin-top: 15px;
    }
    
    .btn-google:hover {
      background: var(--light);
    }
    
    .divider {
      text-align: center;
      margin: 20px 0;
      position: relative;
    }
    
    .divider::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      width: 100%;
      height: 1px;
      background: var(--border);
    }
    
    .divider span {
      background: white;
      padding: 0 10px;
      position: relative;
      color: var(--text-muted);
      font-size: 13px;
    }
    
    #appScreen {
      display: none;
      height: 100%;
      background: var(--light);
    }
    
    .app-header {
      background: white;
      padding: 16px 24px;
      box-shadow: var(--shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .app-header h1 {
      font-size: 20px;
      color: var(--primary);
    }
    
    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    
    .user-badge {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 16px;
      background: var(--light);
      border-radius: 20px;
    }
    
    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
    }
    
    .role-pill {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .role-PRESIDENT { background: #fef3c7; color: #92400e; }
    .role-VP { background: #dbeafe; color: #1e40af; }
    .role-SECRETARY { background: #d1fae5; color: #065f46; }
    .role-TREASURER { background: #fce7f3; color: #9f1239; }
    .role-AUDITOR { background: #e0e7ff; color: #3730a3; }
    .role-PIO { background: #fed7aa; color: #92400e; }
    .role-SGT_AT_ARMS { background: #e5e7eb; color: #374151; }
    .role-MEMBER { background: #f3f4f6; color: #6b7280; }
    
    .btn-logout {
      background: var(--danger);
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
    }
    
    .btn-logout:hover {
      opacity: 0.9;
    }
    
    .app-body {
      display: flex;
      height: calc(100% - 64px);
    }
    
    .sidebar {
      width: 250px;
      background: white;
      box-shadow: var(--shadow);
      overflow-y: auto;
    }
    
    .sidebar-nav {
      list-style: none;
      padding: 20px 0;
    }
    
    .sidebar-nav li {
      padding: 12px 24px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 500;
      color: var(--text);
    }
    
    .sidebar-nav li:hover {
      background: var(--light);
    }
    
    .sidebar-nav li.active {
      background: var(--primary);
      color: white;
      border-left: 4px solid var(--primary-dark);
    }
    
    .sidebar-nav li .icon {
      font-size: 18px;
    }
    
    .main-content {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
    }
    
    .content-section {
      display: none;
    }
    
    .content-section.active {
      display: block;
      animation: fadeIn 0.3s;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .section-header {
      margin-bottom: 24px;
    }
    
    .section-header h2 {
      font-size: 24px;
      margin-bottom: 8px;
    }
    
    .section-header p {
      color: var(--text-muted);
      font-size: 14px;
    }
    
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .widget {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: var(--shadow);
    }
    
    .widget-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .widget-title {
      font-weight: 600;
      color: var(--text-muted);
      font-size: 13px;
      text-transform: uppercase;
    }
    
    .widget-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--text);
    }
    
    .widget-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }
    
    .widget-primary { background: #dbeafe; color: var(--primary); }
    .widget-success { background: #d1fae5; color: var(--secondary); }
    .widget-warning { background: #fef3c7; color: var(--warning); }
    .widget-danger { background: #fee2e2; color: var(--danger); }
    
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 24px;
      margin-bottom: 20px;
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid var(--border);
    }
    
    .card-title {
      font-size: 18px;
      font-weight: 700;
    }
    
    .table-container {
      overflow-x: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    thead {
      background: var(--light);
    }
    
    th {
      padding: 12px;
      text-align: left;
      font-weight: 600;
      font-size: 13px;
      color: var(--text);
      text-transform: uppercase;
    }
    
    td {
      padding: 12px;
      border-bottom: 1px solid var(--border);
    }
    
    tbody tr:hover {
      background: var(--light);
    }
    
    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 6px;
      margin: 0 4px;
    }
    
    .btn-success {
      background: var(--secondary);
      color: white;
    }
    
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    
    .btn-info {
      background: var(--info);
      color: white;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: white;
      border-radius: 12px;
      max-width: 600px;
      width: 100%;
      max-height: 90%;
      overflow-y: auto;
      animation: slideUp 0.3s;
    }
    
    .modal-header {
      padding: 20px 24px;
      border-bottom: 2px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-title {
      font-size: 20px;
      font-weight: 700;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-muted);
    }
    
    .modal-body {
      padding: 24px;
    }
    
    .modal-footer {
      padding: 20px 24px;
      border-top: 2px solid var(--border);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    
    .toast-container {
      position: fixed;
      top: 80px;
      right: 20px;
      z-index: 2000;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .toast {
      background: white;
      padding: 16px 20px;
      border-radius: 8px;
      box-shadow: var(--shadow-lg);
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 300px;
      animation: slideInRight 0.3s;
    }
    
    @keyframes slideInRight {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    .toast-success {
      border-left: 4px solid var(--secondary);
    }
    
    .toast-error {
      border-left: 4px solid var(--danger);
    }
    
    .toast-info {
      border-left: 4px solid var(--info);
    }
    
    .toast-warning {
      border-left: 4px solid var(--warning);
    }
    
    #qrVideo {
      width: 100%;
      max-width: 500px;
      border-radius: 8px;
    }
    
    .scanner-overlay {
      position: relative;
    }
    
    .scanner-target {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 250px;
      height: 250px;
      border: 3px solid var(--primary);
      border-radius: 12px;
    }
    
    .kanban-board {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
    }
    
    .kanban-column {
      background: var(--light);
      border-radius: 8px;
      padding: 16px;
    }
    
    .kanban-header {
      font-weight: 700;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px solid var(--border);
    }
    
    .kanban-card {
      background: white;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 12px;
      box-shadow: var(--shadow);
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .kanban-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    .chat-container {
      display: grid;
      grid-template-columns: 250px 1fr;
      gap: 20px;
      height: calc(100% - 200px);
    }
    
    .chat-channels {
      background: white;
      border-radius: 8px;
      padding: 16px;
      overflow-y: auto;
    }
    
    .chat-channel {
      padding: 12px;
      border-radius: 6px;
      cursor: pointer;
      margin-bottom: 8px;
      transition: background 0.3s;
    }
    
    .chat-channel:hover {
      background: var(--light);
    }
    
    .chat-channel.active {
      background: var(--primary);
      color: white;
    }
    
    .chat-main {
      background: white;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
    }
    
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
    
    .chat-message {
      margin-bottom: 16px;
      display: flex;
      gap: 12px;
    }
    
    .chat-message-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
      flex-shrink: 0;
    }
    
    .chat-message-content {
      flex: 1;
    }
    
    .chat-message-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }
    
    .chat-message-author {
      font-weight: 600;
      font-size: 14px;
    }
    
    .chat-message-time {
      font-size: 12px;
      color: var(--text-muted);
    }
    
    .chat-message-text {
      font-size: 14px;
      line-height: 1.5;
    }
    
    .chat-input-container {
      padding: 16px;
      border-top: 2px solid var(--border);
      display: flex;
      gap: 12px;
    }
    
    .chat-input {
      flex: 1;
      padding: 12px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
    }
    
    .typing-indicator {
      padding: 8px 16px;
      font-size: 12px;
      color: var(--text-muted);
      font-style: italic;
    }
    
    @media (max-width: 768px) {
      .app-body {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100%;
        height: auto;
      }
      
      .sidebar-nav {
        display: flex;
        overflow-x: auto;
        padding: 10px;
      }
      
      .sidebar-nav li {
        white-space: nowrap;
      }
      
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
      
      .chat-container {
        grid-template-columns: 1fr;
        height: auto;
      }
      
      .chat-channels {
        display: flex;
        overflow-x: auto;
        padding: 10px;
      }
      
      .chat-channel {
        white-space: nowrap;
      }
      
      .kanban-board {
        grid-template-columns: 1fr;
      }
    }
    
    .hidden {
      display: none !important;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="toast-container" id="toastContainer"></div>
  <div id="authScreen">
   <div class="auth-container">
    <div class="auth-header">
     <h1>
      <svg width="24" height="24" style="vertical-align: middle; margin-right: 8px;" fill="currentColor" viewbox="0 0 20 20">
       <path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0zM6 18a1 1 0 001-1v-2.065a8.935 8.935 0 00-2-.712V17a1 1 0 001 1z" />
      </svg> CVSU Batch Portal</h1>
     <p>Manage your batch officers and activities</p>
    </div>
    <div class="auth-tabs"><button class="auth-tab active" onclick="switchAuthTab('signin')">Sign In</button> <button class="auth-tab" onclick="switchAuthTab('signup')">Sign Up</button>
    </div>
    <form class="auth-form active" id="signinForm" onsubmit="handleSignIn(event)">
     <div class="form-group"><label for="signinEmail">Email</label> <input type="email" id="signinEmail" required placeholder="your@email.com">
     </div>
     <div class="form-group"><label for="signinPassword">Password</label> <input type="password" id="signinPassword" required placeholder="Enter your password">
     </div><button type="submit" class="btn btn-primary">Sign In</button>
     <div class="divider">
      <span>OR</span>
     </div><button type="button" class="btn btn-google" onclick="handleGoogleSignIn()"> <span style="font-weight: 700; color: #4285F4;">G</span> Continue with Google </button> <button type="button" class="btn btn-secondary" onclick="showPhoneAuth()" style="margin-top: 10px;"> ‚òé Sign in with Phone </button>
    </form>
    <form class="auth-form" id="signupForm" onsubmit="handleSignUp(event)">
     <div class="form-group"><label for="signupName">Full Name</label> <input type="text" id="signupName" required placeholder="Juan Dela Cruz">
     </div>
     <div class="form-group"><label for="signupEmail">Email</label> <input type="email" id="signupEmail" required placeholder="your@email.com">
     </div>
     <div class="form-group"><label for="signupPassword">Password</label> <input type="password" id="signupPassword" required placeholder="Create a password (min 6 characters)" minlength="6">
     </div>
     <div class="form-group"><label for="signupRole">Apply as Role</label> <select id="signupRole" required onchange="handleRoleChange()"> <option value="">Select a role...</option> <option value="MEMBER">Member (General Access)</option> <option value="PRESIDENT">President (Full Admin)</option> <option value="VP">Vice President</option> <option value="SECRETARY">Secretary</option> <option value="TREASURER">Treasurer</option> <option value="AUDITOR">Auditor</option> <option value="PIO">Public Information Officer</option> <option value="SGT_AT_ARMS">Sergeant at Arms</option> </select>
      <div class="form-hint">
       Choose your role carefully. Officer roles require approval.
      </div>
     </div>
     <div class="form-warning hidden" id="officerWarning">
      ‚ö†Ô∏è <strong>Officer Role Selected:</strong> You are applying for an officer position. Please provide a reason below. Your application will require approval from existing officers.
     </div>
     <div class="form-group hidden" id="noteGroup"><label for="signupNote">Application Note (Required for Officer Roles)</label> <textarea id="signupNote" placeholder="Why are you applying for this officer role? What qualifications do you have?"></textarea>
     </div><button type="submit" class="btn btn-primary">Create Account</button>
    </form>
    <form class="auth-form" id="phoneForm" onsubmit="handlePhoneAuth(event)">
     <div class="form-group"><label for="phoneNumber">Phone Number</label> <input type="tel" id="phoneNumber" required placeholder="+639123456789">
      <div class="form-hint">
       Format: +63XXXXXXXXXX (Philippines)
      </div>
     </div>
     <div id="recaptcha-container"></div><button type="submit" class="btn btn-primary">Send Code</button>
     <div class="form-group hidden" id="verificationGroup"><label for="verificationCode">Verification Code</label> <input type="text" id="verificationCode" placeholder="123456"> <button type="button" class="btn btn-primary" onclick="verifyPhoneCode()" style="margin-top: 10px;">Verify Code</button>
     </div><button type="button" class="btn btn-secondary" onclick="backToEmailAuth()" style="margin-top: 10px;"> ‚Üê Back to Email Sign In </button>
    </form>
   </div>
  </div>
  <div id="appScreen">
   <header class="app-header">
    <h1 id="orgNameHeader" style="cursor: pointer;" onclick="showOrgInfo()">
     <svg width="20" height="20" style="vertical-align: middle; margin-right: 6px;" fill="currentColor" viewbox="0 0 20 20">
      <path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0zM6 18a1 1 0 001-1v-2.065a8.935 8.935 0 00-2-.712V17a1 1 0 001 1z" />
     </svg> Loading...</h1>
    <div class="header-actions"><button class="btn btn-secondary" onclick="showChangeOrgScreen()" style="padding: 8px 16px; margin-right: 12px;"> üîÑ Change Org </button>
     <div class="user-badge">
      <div class="user-avatar" id="userAvatar"></div>
      <div>
       <div id="userName" style="font-weight: 600; font-size: 14px;"></div>
       <div class="role-pill" id="userRole"></div>
      </div>
     </div><button class="btn-logout" onclick="handleLogout()">Logout</button>
    </div>
   </header>
   <div class="app-body">
    <aside class="sidebar">
     <ul class="sidebar-nav" id="sidebarNav">
     </ul>
    </aside>
    <main class="main-content">
     <section class="content-section active" id="dashboardSection">
      <div class="section-header">
       <h2>Dashboard</h2>
       <p>Welcome back! Here's what's happening.</p>
      </div>
      <div class="dashboard-grid">
       <div class="widget">
        <div class="widget-header">
         <div>
          <div class="widget-title">
           Total Members
          </div>
          <div class="widget-value" id="widgetMembers">
           0
          </div>
         </div>
         <div class="widget-icon widget-primary">
          üë•
         </div>
        </div>
       </div>
       <div class="widget">
        <div class="widget-header">
         <div>
          <div class="widget-title">
           Pending Approvals
          </div>
          <div class="widget-value" id="widgetPending">
           0
          </div>
         </div>
         <div class="widget-icon widget-warning">
          ‚è≥
         </div>
        </div>
       </div>
       <div class="widget">
        <div class="widget-header">
         <div>
          <div class="widget-title">
           Upcoming Events
          </div>
          <div class="widget-value" id="widgetEvents">
           0
          </div>
         </div>
         <div class="widget-icon widget-success">
          üìÜ
         </div>
        </div>
       </div>
       <div class="widget">
        <div class="widget-header">
         <div>
          <div class="widget-title">
           Budget Remaining
          </div>
          <div class="widget-value" id="widgetBudget">
           ÔøΩÔøΩÔøΩ0
          </div>
         </div>
         <div class="widget-icon widget-danger">
          üí∞
         </div>
        </div>
       </div>
      </div>
      <div class="card">
       <div class="card-header">
        <h3 class="card-title">üì¢ Recent Announcements</h3>
       </div>
       <div id="recentAnnouncements">
        <p style="text-align: center; color: var(--text-muted); padding: 20px;">No announcements yet.</p>
       </div>
      </div>
     </section>
     <section class="content-section" id="membersSection">
      <div class="section-header">
       <h2>Members</h2>
       <p>Manage batch members and their roles</p>
      </div>
      <div class="card">
       <div class="card-header">
        <h3 class="card-title">Member List</h3>
        <div><button class="btn btn-small btn-success" onclick="exportMembersCSV()">üì• Export CSV</button>
        </div>
       </div>
       <div style="margin-bottom: 20px; display: flex; gap: 12px; flex-wrap: wrap;"><input type="text" id="memberSearch" placeholder="üîç Search members..." onkeyup="filterMembers()" style="flex: 1; min-width: 250px; padding: 12px; border: 2px solid var(--border); border-radius: 8px;"> <select id="memberRoleFilter" onchange="filterMembers()" style="padding: 12px; border: 2px solid var(--border); border-radius: 8px;"> <option value="">All Roles</option> <option value="PRESIDENT">President</option> <option value="VP">Vice President</option> <option value="SECRETARY">Secretary</option> <option value="TREASURER">Treasurer</option> <option value="AUDITOR">Auditor</option> <option value="PIO">PIO</option> <option value="SGT_AT_ARMS">Sergeant at Arms</option> <option value="MEMBER">Member</option> </select> <select id="memberStatusFilter" onchange="filterMembers()" style="padding: 12px; border: 2px solid var(--border); border-radius: 8px;"> <option value="">All Status</option> <option value="approved">Approved</option> <option value="pending">Pending</option> <option value="admin">Head Admin</option> </select>
       </div>
       <div class="table-container">
        <table id="membersTable">
         <thead>
          <tr>
           <th>Name</th>
           <th>Email</th>
           <th>Role</th>
           <th>Status</th>
           <th>Actions</th>
          </tr>
         </thead>
         <tbody id="membersTableBody">
          <tr>
           <td colspan="5" style="text-align: center; padding: 40px;">Loading members...</td>
          </tr>
         </tbody>
        </table>
       </div>
      </div>
     </section>
     <section class="content-section" id="auditSection">
      <div class="section-header">
       <h2>Audit Logs</h2>
       <p>System activity and change history</p>
      </div>
      <div class="card">
       <div class="card-header">
        <h3 class="card-title">Activity Log</h3><button class="btn btn-small btn-info" onclick="showAddAuditModal()" id="addAuditBtn" style="display: none;">‚ûï Add Entry</button>
       </div>
       <div class="table-container">
        <table>
         <thead>
          <tr>
           <th>Timestamp</th>
           <th>Action</th>
           <th>User</th>
           <th>Details</th>
           <th>Actions</th>
          </tr>
         </thead>
         <tbody id="auditTableBody">
          <tr>
           <td colspan="5" style="text-align: center; padding: 40px;">Loading logs...</td>
          </tr>
         </tbody>
        </table>
       </div>
      </div>
     </section>
     <section class="content-section" id="eventsSection">
      <div class="section-header">
       <h2>Events &amp; Calendar</h2>
       <p>Manage batch events and activities</p>
      </div>
      <div class="card">
       <div class="card-header">
        <h3 class="card-title">Upcoming Events</h3><button class="btn btn-small btn-success" onclick="showCreateEventModal()">‚ûï Create Event</button>
       </div>
       <div id="eventsContainer">
        <p style="text-align: center; color: var(--text-muted); padding: 40px;">No events scheduled.</p>
       </div>
      </div>
     </section>
     <section class="content-section" id="attendanceSection">
      <div class="section-header">
       <h2>Attendance Tracking</h2>
       <p>Manage attendance sessions and track participation</p>
      </div>
      <div class="card">
       <div class="card-header">
        <h3 class="card-title">Attendance Sessions</h3><button class="btn btn-small btn-success" onclick="showCreateAttendanceModal()">‚ûï Create Session</button>
       </div>
       <div id="attendanceContainer">
        <p style="text-align: center; color: var(--text-muted); padding: 40px;">No attendance sessions yet.</p>
       </div>
      </div>
     </section>
     <section class="content-section" id="filesSection">
      <div class="section-header">
       <h2>Files &amp; Documents</h2>
       <p>Manage batch documents and resources</p>
      </div>
      <div class="card">
       <div class="card-header">
        <h3 class="card-title">File Repository</h3><button class="btn btn-small btn-success" onclick="showUploadFileModal()">‚¨ÜÔ∏è Upload File</button>
       </div>
       <div id="filesContainer">
        <p style="text-align: center; color: var(--text-muted); padding: 40px;">No files uploaded yet.</p>
       </div>
      </div>
     </section>
     <section class="content-section" id="inventorySection">
      <div class="section-header">
       <h2>Inventory &amp; Receipt Safe</h2>
       <p>Track equipment and store receipts</p>
      </div>
      <div class="card">
       <div class="card-header">
        <h3 class="card-title">Inventory Items</h3><button class="btn btn-small btn-success" onclick="showAddInventoryModal()">‚ûï Add Item</button>
       </div>
       <div id="inventoryContainer">
        <p style="text-align: center; color: var(--text-muted); padding: 40px;">No items in inventory.</p>
       </div>
      </div>
      <div class="card" style="margin-top: 20px;">
       <div class="card-header">
        <h3 class="card-title">Receipt Safe</h3><button class="btn btn-small btn-success" onclick="showUploadReceiptModal()">‚¨ÜÔ∏è Upload Receipt</button>
       </div>
       <div id="receiptsContainer">
        <p style="text-align: center; color: var(--text-muted); padding: 40px;">No receipts stored.</p>
       </div>
      </div>
     </section>
     <section class="content-section" id="financeSection">
      <div class="section-header">
       <h2>Finance Ledger</h2>
       <p>Track income, expenses, and budget</p>
      </div>
      <div class="dashboard-grid">
       <div class="widget">
        <div class="widget-header">
         <div>
          <div class="widget-title">
           Total Income
          </div>
          <div class="widget-value" id="totalIncome">
           ‚Ç±0
          </div>
         </div>
         <div class="widget-icon widget-success">
          üíµ
         </div>
        </div>
       </div>
       <div class="widget">
        <div class="widget-header">
         <div>
          <div class="widget-title">
           Total Expenses
          </div>
          <div class="widget-value" id="totalExpenses">
           ‚Ç±0
          </div>
         </div>
         <div class="widget-icon widget-danger">
          üí∏
         </div>
        </div>
       </div>
       <div class="widget">
        <div class="widget-header">
         <div>
          <div class="widget-title">
           Balance
          </div>
          <div class="widget-value" id="balance">
           ‚Ç±0
          </div>
         </div>
         <div class="widget-icon widget-primary">
          üí∞
         </div>
        </div>
       </div>
      </div>
      <div class="card">
       <div class="card-header">
        <h3 class="card-title">Transaction Ledger</h3>
        <div><button class="btn btn-small btn-success" onclick="showAddTransactionModal()">‚ûï Add Transaction</button> <button class="btn btn-small btn-info" onclick="exportFinanceCSV()">üì• Export CSV</button>
        </div>
       </div>
       <div class="table-container">
        <table>
         <thead>
          <tr>
           <th>Date</th>
           <th>Type</th>
           <th>Category</th>
           <th>Description</th>
           <th>Amount</th>
          </tr>
         </thead>
         <tbody id="financeTableBody">
          <tr>
           <td colspan="5" style="text-align: center; padding: 40px;">No transactions yet.</td>
          </tr>
         </tbody>
        </table>
       </div>
      </div>
     </section>
     <section class="content-section" id="announcementsSection">
      <div class="section-header">
       <h2>Announcements</h2>
       <p>Create and manage public announcements</p>
      </div>
      <div class="card">
       <div class="card-header">
        <h3 class="card-title">All Announcements</h3><button class="btn btn-small btn-success" onclick="showCreateAnnouncementModal()">‚ûï Create Announcement</button>
       </div>
       <div id="allAnnouncementsContainer">
        <p style="text-align: center; color: var(--text-muted); padding: 40px;">No announcements yet.</p>
       </div>
      </div>
     </section>
     <section class="content-section" id="chatSection">
      <div class="section-header">
       <h2>Chat &amp; Messaging</h2>
       <p>Internal communication channels</p>
      </div>
      <div class="chat-container">
       <div class="chat-channels">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
         <h4 style="font-size: 14px; text-transform: uppercase; color: var(--text-muted); margin: 0;">Channels</h4><button class="btn btn-small btn-success" onclick="showCreateChannelModal()" style="padding: 4px 8px; font-size: 11px;">+ New</button>
        </div>
        <div id="chatChannelsList">
         <div class="chat-channel active" data-channel="general" onclick="switchChatChannel('general')">
          üí¨ General
         </div>
         <div class="chat-channel" data-channel="finance" onclick="switchChatChannel('finance')">
          üí∞ Finance
         </div>
         <div class="chat-channel" data-channel="events" onclick="switchChatChannel('events')">
          üìÖ Events
         </div>
         <div class="chat-channel" data-channel="logistics" onclick="switchChatChannel('logistics')">
          üì¶ Logistics
         </div>
        </div>
        <div class="chat-main">
         <div class="chat-messages" id="chatMessages">
          <p style="text-align: center; color: var(--text-muted); padding: 40px;">No messages yet. Start the conversation!</p>
         </div>
         <div class="typing-indicator" id="typingIndicator"></div>
         <div class="chat-input-container"><input type="text" class="chat-input" id="chatInput" placeholder="Type a message..." onkeypress="handleChatKeyPress(event)" oninput="handleChatTyping()"> <button class="btn btn-primary" onclick="sendChatMessage()">Send</button>
         </div>
        </div>
       </div>
      </div>
     </section>
     <section class="content-section" id="tasksSection">
      <div class="section-header">
       <h2>Task Board</h2>
       <p>Kanban-style task management</p>
      </div><button class="btn btn-success" onclick="showCreateTaskModal()" style="margin-bottom: 20px;">‚ûï Create Task</button>
      <div class="kanban-board">
       <div class="kanban-column">
        <div class="kanban-header">
         üìã To Do
        </div>
        <div id="kanban-todo"></div>
       </div>
       <div class="kanban-column">
        <div class="kanban-header">
         üî® Doing
        </div>
        <div id="kanban-doing"></div>
       </div>
       <div class="kanban-column">
        <div class="kanban-header">
         ÔøΩÔøΩÔøΩÔøΩ Review
        </div>
        <div id="kanban-review"></div>
       </div>
       <div class="kanban-column">
        <div class="kanban-header">
         ‚úÖ Done
        </div>
        <div id="kanban-done"></div>
       </div>
      </div>
     </section>
     <section class="content-section" id="pollsSection">
      <div class="section-header">
       <h2>Polls &amp; Voting</h2>
       <p>Create polls and gather feedback</p>
      </div>
      <div class="card">
       <div class="card-header">
        <h3 class="card-title">Active Polls</h3><button class="btn btn-small btn-success" onclick="showCreatePollModal()">‚ûï Create Poll</button>
       </div>
       <div id="pollsContainer">
        <p style="text-align: center; color: var(--text-muted); padding: 40px;">No polls created yet.</p>
       </div>
      </div>
     </section>
     <section class="content-section" id="profileSection">
      <div class="section-header">
       <h2>My Profile</h2>
       <p>View and manage your profile</p>
      </div>
      <div class="card">
       <div style="text-align: center; padding: 40px;">
        <div id="profileAvatarLarge" style="width: 120px; height: 120px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-size: 48px; font-weight: 700; margin: 0 auto 20px;"></div>
        <h3 id="profileName" style="margin-bottom: 8px;"></h3>
        <div class="role-pill" id="profileRole"></div>
        <p id="profileEmail" style="color: var(--text-muted); margin-top: 12px;"></p>
        <div style="margin-top: 20px;"><button class="btn btn-primary" onclick="showChangeNameModal()" style="margin-right: 8px;">‚úèÔ∏è Change Display Name</button> <button class="btn btn-primary" onclick="showChangePhotoModal()">üì∑ Change Photo</button>
        </div>
        <div style="margin-top: 30px;">
         <h4 style="margin-bottom: 16px;">Your QR ID</h4>
         <canvas id="profileQR" style="border: 2px solid var(--border); border-radius: 8px;"></canvas>
         <p style="margin-top: 12px; font-size: 12px; color: var(--text-muted);">Use this QR code for attendance check-in</p>
        </div>
       </div>
      </div>
     </section>
    </main>
   </div>
  </div>
  <div class="modal" id="universalModal">
   <div class="modal-content">
    <div class="modal-header">
     <h3 class="modal-title" id="modalTitle">Modal</h3><button class="modal-close" onclick="closeModal()">√ó</button>
    </div>
    <div class="modal-body" id="modalBody">
    </div>
    <div class="modal-footer" id="modalFooter">
    </div>
   </div>
  </div>
  <script>
    const CONFIG = {
      FIREBASE: {
        apiKey: "AIzaSyAK_41CRZM1pt5zTNqMzy_WdrZu1g8fKks",
        authDomain: "org-organizer.firebaseapp.com",
        databaseURL: "https://org-organizer-default-rtdb.firebaseio.com",
        projectId: "org-organizer",
        storageBucket: "org-organizer.firebasestorage.app",
        messagingSenderId: "971435967798",
        appId: "1:971435967798:web:969835f265d9ee4f879f97",
        measurementId: "G-STG68DJDWF"
      },
      SUPABASE: {
        URL: 'https://kidiqmlzfsdesqbdvnmk.supabase.co',
        ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtpZGlxbWx6ZnNkZXNxYmR2bm1rIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MzYxNzYyMCwiZXhwIjoyMDc5MTkzNjIwfQ.fNZCZBr0Bc8I2-GiPEyYAYE_w3OOh3hk4m-EOYhmYMA',
        BUCKET: 'org-resources-files'
      },
      CLOUDINARY: {
        CLOUD_NAME: 'damr6r9op',
        UPLOAD_PRESET: 'org-resources'
      },
      DISCORD_WEBHOOK: "https://discord.com/api/webhooks/1332509213073727532/20zggT_tEPEIZ6lYF52-wRaB6eAUOHCirNebJEoU2Hj7eytnDo9ZaxSlMVgzPQpQql18",
      REQUIRE_APPROVAL: true
    };
    
    let firebaseApp, auth, database, supabase;
    let currentUser = null;
    let currentUserData = null;
    let currentOrgId = null;
    let currentOrgData = null;
    let currentChatChannel = 'general';
    let typingTimeout = null;
    let offlineSyncQueue = [];
    let userOrganizations = [];
    
    const PERMISSIONS = {
      PRESIDENT: ['all'],
      VP: ['all'],
      SECRETARY: ['members', 'audit', 'approvals', 'events', 'attendance', 'announcements', 'chat', 'tasks', 'polls'],
      TREASURER: ['inventory', 'receipts', 'finance', 'audit', 'files'],
      AUDITOR: ['audit_write', 'audit'],
      PIO: ['announcements', 'events'],
      SGT_AT_ARMS: ['view_only'],
      MEMBER: ['view_only']
    };
    
    const UNIQUE_ROLES = ['PRESIDENT', 'VP', 'SECRETARY', 'TREASURER', 'PIO'];
    
    console.log('Initializing Firebase...');
    firebaseApp = firebase.initializeApp(CONFIG.FIREBASE);
    auth = firebase.auth();
    database = firebase.database();
    
    console.log('Initializing Supabase...');
    supabase = window.supabase.createClient(CONFIG.SUPABASE.URL, CONFIG.SUPABASE.ANON_KEY);
    
    window.addEventListener('DOMContentLoaded', () => {
      auth.onAuthStateChanged(async (user) => {
        if (user) {
          console.log('User authenticated:', user.uid);
          currentUser = user;
          
          await loadUserOrganizations();
          
          if (userOrganizations.length === 0) {
            showOrgSelectionScreen();
          } else {
            const lastOrgId = localStorage.getItem('lastOrgId');
            if (lastOrgId && userOrganizations.find(o => o.orgId === lastOrgId)) {
              await switchToOrganization(lastOrgId);
            } else {
              await switchToOrganization(userOrganizations[0].orgId);
            }
          }
        } else {
          console.log('No user authenticated');
          showAuthScreen();
        }
      });
      
      const savedQueue = localStorage.getItem('offlineSyncQueue');
      if (savedQueue) {
        offlineSyncQueue = JSON.parse(savedQueue);
        processSyncQueue();
      }
    });
    
    async function loadUserOrganizations() {
      try {
        const snapshot = await database.ref('userOrgs').child(currentUser.uid).once('value');
        userOrganizations = [];
        
        if (snapshot.exists()) {
          for (const child of snapshot.val() ? Object.keys(snapshot.val()) : []) {
            const orgData = snapshot.val()[child];
            const memberSnapshot = await database.ref(`orgs/${child}/members/${currentUser.uid}`).once('value');
            const memberData = memberSnapshot.val();
            
            // Fetch full org data including photo and description
            const fullOrgSnapshot = await database.ref(`orgs/${child}`).once('value');
            const fullOrgData = fullOrgSnapshot.val();
            
            userOrganizations.push({
              orgId: child,
              ...orgData,
              approved: memberData ? memberData.approved : false,
              isHeadAdmin: memberData ? memberData.isHeadAdmin : false,
              photoURL: fullOrgData ? fullOrgData.photoURL : null,
              description: fullOrgData ? fullOrgData.description : null
            });
          }
        }
        
        // Check if user is head admin - load ALL organizations
        const allOrgsSnapshot = await database.ref('orgs').once('value');
        allOrgsSnapshot.forEach(orgChild => {
          const orgId = orgChild.key;
          const orgData = orgChild.val();
          
          const memberData = orgData.members && orgData.members[currentUser.uid];
          
          if (memberData && memberData.isHeadAdmin) {
            // Check if org already in list
            if (!userOrganizations.find(o => o.orgId === orgId)) {
              userOrganizations.push({
                orgId: orgId,
                orgName: orgData.name,
                role: memberData.role || 'ADMIN',
                approved: true,
                isHeadAdmin: true,
                joinedAt: memberData.createdAt,
                photoURL: orgData.photoURL || null,
                description: orgData.description || null
              });
            }
          }
        });
      } catch (error) {
        console.error('Load orgs error:', error);
      }
    }
    
    async function switchToOrganization(orgId) {
      try {
        currentOrgId = orgId;
        
        const orgSnapshot = await database.ref(`orgs/${orgId}`).once('value');
        currentOrgData = orgSnapshot.val();
        
        if (!currentOrgData) {
          showToast('Organization not found', 'error');
          showOrgSelectionScreen();
          return;
        }
        
        const memberSnapshot = await database.ref(`orgs/${orgId}/members/${currentUser.uid}`).once('value');
        currentUserData = memberSnapshot.val();
        
        if (!currentUserData) {
          showToast('You are not a member of this organization', 'error');
          showOrgSelectionScreen();
          return;
        }
        
        if (!currentUserData.approved) {
          showPendingApprovalScreen();
          return;
        }
        
        localStorage.setItem('lastOrgId', orgId);
        loadMainApp();
      } catch (error) {
        console.error('Switch org error:', error);
        showToast('Failed to load organization: ' + error.message, 'error');
        showOrgSelectionScreen();
      }
    }
    
    function showOrgSelectionScreen() {
      const orgListHTML = userOrganizations.map(org => {
        const isApproved = org.approved;
        const isHeadAdmin = org.isHeadAdmin;
        const opacity = isApproved ? '1' : '0.5';
        const cursor = 'pointer';
        
        return `
          <div id="org-card-${org.orgId}" style="border: 2px solid ${isHeadAdmin ? '#10b981' : 'var(--border)'}; border-radius: 8px; margin-bottom: 12px; transition: all 0.3s; opacity: ${opacity}; ${!isApproved ? 'background: var(--light);' : ''} ${isHeadAdmin ? 'background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);' : ''}">
            <div style="padding: 16px; cursor: ${cursor};" onclick="toggleOrgCard('${org.orgId}')">
              <div style="display: flex; align-items: center; gap: 12px;">
                <div style="width: 50px; height: 50px; border-radius: 50%; background: var(--light); display: flex; align-items: center; justify-content: center; overflow: hidden; border: 2px solid var(--border); flex-shrink: 0;">
                  ${org.photoURL 
                    ? `<img src="${org.photoURL}" style="width: 100%; height: 100%; object-fit: cover;">` 
                    : `<svg width="24" height="24" fill="currentColor" viewBox="0 0 20 20"><path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0zM6 18a1 1 0 001-1v-2.065a8.935 8.935 0 00-2-.712V17a1 1 0 001 1z"/></svg>`
                  }
                </div>
                <div style="flex: 1;">
                  <strong style="font-size: 16px;">${org.orgName} ${!isApproved ? '‚è≥' : ''} ${isHeadAdmin ? 'üëë' : ''}</strong>
                  <p style="font-size: 13px; color: var(--text-muted); margin-top: 4px;">
                    Role: ${org.role}${isHeadAdmin ? ' <span style="color: #065f46; font-weight: 600;">(Head Admin)</span>' : ''}
                    ${!isApproved ? '<br><span style="color: var(--warning); font-weight: 600;">Pending Approval</span>' : ''}
                  </p>
                </div>
                <div style="font-size: 20px; transition: transform 0.3s;" id="org-arrow-${org.orgId}">‚ñº</div>
              </div>
            </div>
            
            <div id="org-details-${org.orgId}" style="display: none; padding: 0 16px 16px; border-top: 1px solid var(--border); margin-top: 12px; padding-top: 12px;">
              ${org.description ? `<p style="font-size: 14px; color: var(--text); margin-bottom: 12px;">${org.description}</p>` : '<p style="font-size: 14px; color: var(--text-muted); margin-bottom: 12px;">No description available</p>'}
              ${isApproved ? `
                <button class="btn btn-primary" onclick="event.stopPropagation(); switchToOrganization('${org.orgId}')" style="width: 100%;">
                  Open Organization
                </button>
              ` : `
                <p style="color: var(--warning); font-size: 13px; text-align: center; padding: 12px; background: #fef3c7; border-radius: 6px;">
                  ‚è≥ Waiting for approval from organization officers
                </p>
              `}
            </div>
          </div>
        `;
      }).join('');
      
      document.getElementById('authScreen').innerHTML = `
        <div class="auth-container">
          <div class="auth-header">
            <h1><svg width="24" height="24" style="vertical-align: middle; margin-right: 8px;" fill="currentColor" viewBox="0 0 20 20"><path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0zM6 18a1 1 0 001-1v-2.065a8.935 8.935 0 00-2-.712V17a1 1 0 001 1z"/></svg> Select Organization</h1>
            <p>Choose an organization to manage</p>
          </div>
          
          ${userOrganizations.length > 0 ? `
            <div style="margin-bottom: 24px;">
              <h3 style="margin-bottom: 16px; font-size: 14px; color: var(--text-muted); text-transform: uppercase;">Your Organizations</h3>
              ${orgListHTML}
            </div>
          ` : `
            <div style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
              <p style="margin-bottom: 20px;">You are not a member of any organization yet.</p>
            </div>
          `}
          
          <button class="btn btn-primary" onclick="showCreateOrgModal()" style="margin-bottom: 12px;">
            <svg width="16" height="16" style="vertical-align: middle; margin-right: 6px;" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"/></svg> Create New Organization
          </button>
          
          <button class="btn btn-secondary" onclick="showJoinOrgModal()">
            <svg width="16" height="16" style="vertical-align: middle; margin-right: 6px;" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd"/></svg> Join Existing Organization
          </button>
          
          <button class="btn btn-danger" onclick="handleLogout()" style="margin-top: 20px;">
            Logout
          </button>
        </div>
      `;
    }
    
    function toggleOrgCard(orgId) {
      const detailsDiv = document.getElementById(`org-details-${orgId}`);
      const arrowDiv = document.getElementById(`org-arrow-${orgId}`);
      
      const isOpen = detailsDiv.style.display === 'block';
      
      // Close all other cards
      document.querySelectorAll('[id^="org-details-"]').forEach(div => {
        if (div.id !== `org-details-${orgId}`) {
          div.style.display = 'none';
        }
      });
      document.querySelectorAll('[id^="org-arrow-"]').forEach(arrow => {
        if (arrow.id !== `org-arrow-${orgId}`) {
          arrow.style.transform = 'rotate(0deg)';
        }
      });
      
      // Toggle current card
      if (isOpen) {
        detailsDiv.style.display = 'none';
        arrowDiv.style.transform = 'rotate(0deg)';
      } else {
        detailsDiv.style.display = 'block';
        arrowDiv.style.transform = 'rotate(180deg)';
      }
    }
    
    function showCreateOrgModal() {
      showModal('Create Organization', `
        <div class="form-group">
          <label>Organization Name</label>
          <input type="text" id="newOrgName" placeholder="e.g., CVSU Batch 2024">
        </div>
        <div class="form-group">
          <label>Organization ID (unique identifier)</label>
          <input type="text" id="newOrgId" placeholder="e.g., cvsu-batch-2024">
          <div class="form-hint">Lowercase letters, numbers, and hyphens only</div>
        </div>
        <div class="form-group">
          <label>Your Role</label>
          <select id="creatorRole">
            <option value="PRESIDENT">President (Full Admin)</option>
            <option value="VP">Vice President</option>
            <option value="SECRETARY">Secretary</option>
            <option value="TREASURER">Treasurer</option>
            <option value="AUDITOR">Auditor</option>
            <option value="PIO">Public Information Officer</option>
            <option value="SGT_AT_ARMS">Sergeant at Arms</option>
            <option value="MEMBER">Member</option>
          </select>
          <div class="form-hint">As the creator, you'll be automatically approved</div>
        </div>
        <div class="form-group">
          <label>Description (Optional)</label>
          <textarea id="newOrgDesc" placeholder="Brief description of your organization"></textarea>
        </div>
      `, `
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="createOrganization()">Create Organization</button>
      `);
    }
    
    async function createOrganization() {
      const orgName = document.getElementById('newOrgName').value.trim();
      const orgId = document.getElementById('newOrgId').value.trim().toLowerCase();
      const role = document.getElementById('creatorRole').value;
      const description = document.getElementById('newOrgDesc').value.trim();
      
      if (!orgName || !orgId) {
        showToast('Please fill all required fields', 'error');
        return;
      }
      
      if (!/^[a-z0-9-]+$/.test(orgId)) {
        showToast('Organization ID can only contain lowercase letters, numbers, and hyphens', 'error');
        return;
      }
      
      try {
        const existingOrg = await database.ref(`orgs/${orgId}`).once('value');
        if (existingOrg.exists()) {
          showToast('Organization ID already exists. Please choose another.', 'error');
          return;
        }
        
        const orgData = {
          name: orgName,
          description: description,
          createdBy: currentUser.uid,
          createdAt: Date.now()
        };
        
        await database.ref(`orgs/${orgId}`).set(orgData);
        
        const userData = {
          uid: currentUser.uid,
          name: currentUser.displayName || currentUser.email,
          email: currentUser.email,
          role: role,
          approved: true,
          isHeadAdmin: false,
          createdAt: Date.now(),
          photoURL: currentUser.photoURL || null
        };
        
        await database.ref(`orgs/${orgId}/members/${currentUser.uid}`).set(userData);
        
        await database.ref(`userOrgs/${currentUser.uid}/${orgId}`).set({
          orgName: orgName,
          role: role,
          joinedAt: Date.now()
        });
        
        await database.ref(`orgs/${orgId}/auditLogs`).push({
          action: 'ORG_CREATE',
          userId: currentUser.uid,
          userName: currentUser.displayName || currentUser.email,
          details: `Organization created by ${currentUser.displayName || currentUser.email}`,
          timestamp: Date.now()
        });
        
        closeModal();
        showToast('Organization created successfully!', 'success');
        
        await loadUserOrganizations();
        await switchToOrganization(orgId);
      } catch (error) {
        console.error('Create org error:', error);
        showToast('Failed to create organization', 'error');
      }
    }
    
    function showJoinOrgModal() {
      showModal('Join Organization', `
        <div class="form-group">
          <label>Organization ID</label>
          <input type="text" id="joinOrgId" placeholder="e.g., cvsu-batch-2024">
          <div class="form-hint">Ask your organization admin for the Organization ID</div>
        </div>
        <div class="form-group">
          <label>Apply as Role</label>
          <select id="joinRole">
            <option value="MEMBER">Member (General Access)</option>
            <option value="PRESIDENT">President (Full Admin)</option>
            <option value="VP">Vice President</option>
            <option value="SECRETARY">Secretary</option>
            <option value="TREASURER">Treasurer</option>
            <option value="AUDITOR">Auditor</option>
            <option value="PIO">Public Information Officer</option>
            <option value="SGT_AT_ARMS">Sergeant at Arms</option>
          </select>
        </div>
        <div class="form-group">
          <label>Application Note</label>
          <textarea id="joinNote" placeholder="Why do you want to join? (Required for officer roles)"></textarea>
        </div>
      `, `
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="joinOrganization()">Request to Join</button>
      `);
    }
    
    async function joinOrganization() {
      const orgId = document.getElementById('joinOrgId').value.trim().toLowerCase();
      let role = document.getElementById('joinRole').value;
      const note = document.getElementById('joinNote').value.trim();
      
      if (!orgId) {
        showToast('Please enter an organization ID', 'error');
        return;
      }
      
      try {
        const orgSnapshot = await database.ref(`orgs/${orgId}`).once('value');
        if (!orgSnapshot.exists()) {
          showToast('Organization not found', 'error');
          return;
        }
        
        const existingMember = await database.ref(`orgs/${orgId}/members/${currentUser.uid}`).once('value');
        if (existingMember.exists()) {
          showToast('You are already a member of this organization', 'error');
          return;
        }
        
        // Check if officer role is already taken by an APPROVED member
        if (UNIQUE_ROLES.includes(role)) {
          const membersSnapshot = await database.ref(`orgs/${orgId}/members`)
            .orderByChild('role')
            .equalTo(role)
            .once('value');
          
          if (membersSnapshot.exists()) {
            let roleOccupied = false;
            membersSnapshot.forEach(child => {
              if (child.val().approved === true) {
                roleOccupied = true;
              }
            });
            
            if (roleOccupied) {
              showToast(`The ${role} position is already occupied. You've been assigned as MEMBER instead.`, 'info');
              role = 'MEMBER';
            }
          }
        }
        
        // Members are auto-approved, officers need approval from President
        const isOfficer = role !== 'MEMBER';
        const needsApproval = isOfficer;
        
        const userData = {
          uid: currentUser.uid,
          name: currentUser.displayName || currentUser.email,
          email: currentUser.email,
          role: role,
          approved: !needsApproval,
          isHeadAdmin: false,
          note: note,
          createdAt: Date.now(),
          photoURL: currentUser.photoURL || null
        };
        
        await database.ref(`orgs/${orgId}/members/${currentUser.uid}`).set(userData);
        
        await database.ref(`userOrgs/${currentUser.uid}/${orgId}`).set({
          orgName: orgSnapshot.val().name,
          role: role,
          joinedAt: Date.now(),
          approved: !needsApproval
        });
        
        if (needsApproval) {
          await sendDiscordNotification(`üîî New ${role} application from ${userData.name} (${userData.email}) to organization ${orgSnapshot.val().name}. ${note ? 'Note: ' + note : ''}`);
        }
        
        closeModal();
        
        if (needsApproval) {
          showToast('Application submitted! Awaiting approval from President.', 'success');
        } else {
          showToast('You have joined the organization as a Member!', 'success');
        }
        
        await loadUserOrganizations();
        
        if (!needsApproval) {
          await switchToOrganization(orgId);
        } else {
          showOrgSelectionScreen();
        }
      } catch (error) {
        console.error('Join org error:', error);
        showToast('Failed to join organization', 'error');
      }
    }
    
    function switchAuthTab(tab) {
      document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
      
      if (tab === 'signin') {
        document.querySelectorAll('.auth-tab')[0].classList.add('active');
        document.getElementById('signinForm').classList.add('active');
      } else {
        document.querySelectorAll('.auth-tab')[1].classList.add('active');
        document.getElementById('signupForm').classList.add('active');
      }
    }
    
    function handleRoleChange() {
      const role = document.getElementById('signupRole').value;
      const isOfficer = role && role !== 'MEMBER';
      
      document.getElementById('officerWarning').classList.toggle('hidden', !isOfficer);
      document.getElementById('noteGroup').classList.toggle('hidden', !isOfficer);
      
      if (isOfficer) {
        document.getElementById('signupNote').required = true;
      } else {
        document.getElementById('signupNote').required = false;
      }
    }
    
    async function handleSignIn(e) {
      e.preventDefault();
      
      const email = document.getElementById('signinEmail').value;
      const password = document.getElementById('signinPassword').value;
      
      try {
        await auth.signInWithEmailAndPassword(email, password);
        showToast('Welcome back!', 'success');
      } catch (error) {
        console.error('Sign in error:', error);
        showToast(error.message, 'error');
      }
    }
    
    async function handleSignUp(e) {
      e.preventDefault();
      
      const name = document.getElementById('signupName').value;
      const email = document.getElementById('signupEmail').value;
      const password = document.getElementById('signupPassword').value;
      const role = document.getElementById('signupRole').value;
      const note = document.getElementById('signupNote').value;
      
      try {
        if (UNIQUE_ROLES.includes(role)) {
          const membersSnapshot = await database.ref(`orgs/${CONFIG.ORG_ID}/members`)
            .orderByChild('role')
            .equalTo(role)
            .once('value');
          
          if (membersSnapshot.exists()) {
            showToast(`The ${role} role is already occupied. Please choose a different role.`, 'error');
            return;
          }
        }
        
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;
        
        const userData = {
          uid: user.uid,
          name: name,
          email: email,
          role: role,
          approved: false,
          isHeadAdmin: false,
          note: note || '',
          createdAt: Date.now(),
          photoURL: null
        };
        
        await database.ref(`orgs/${CONFIG.ORG_ID}/members/${user.uid}`).set(userData);
        
        await sendDiscordNotification(`New ${role} registration from ${name} (${email}). ${note ? 'Note: ' + note : ''}`);
        
        await addAuditLog('USER_REGISTER', user.uid, `${name} registered as ${role}`);
        
        showToast('Account created successfully! Awaiting approval from administrators.', 'success');
        
        currentUserData = userData;
        showPendingApprovalScreen();
      } catch (error) {
        console.error('Sign up error:', error);
        showToast(error.message, 'error');
        showLoading(false);
      }
    }
    
    async function handleGoogleSignIn() {
      const provider = new firebase.auth.GoogleAuthProvider();
      
      try {
        const result = await auth.signInWithPopup(provider);
        const user = result.user;
        
        const userSnapshot = await database.ref(`orgs/${CONFIG.ORG_ID}/members/${user.uid}`).once('value');
        
        if (!userSnapshot.exists()) {
          const role = prompt('Select your role: MEMBER, PRESIDENT, VP, SECRETARY, TREASURER, AUDITOR, PIO, SGT_AT_ARMS');
          
          if (!role) {
            await auth.signOut();
            showToast('Role selection is required', 'error');
            return;
          }
          
          const userData = {
            uid: user.uid,
            name: user.displayName,
            email: user.email,
            role: role.toUpperCase(),
            approved: false,
            isHeadAdmin: false,
            createdAt: Date.now(),
            photoURL: user.photoURL
          };
          
          await database.ref(`orgs/${CONFIG.ORG_ID}/members/${user.uid}`).set(userData);
          await addAuditLog('USER_REGISTER', user.uid, `${user.displayName} registered via Google`);
          await sendDiscordNotification(`New ${role.toUpperCase()} registration from ${user.displayName} (${user.email}) via Google Sign-In`);
        }
        
        showToast('Signed in with Google!', 'success');
      } catch (error) {
        console.error('Google sign in error:', error);
        showToast(error.message, 'error');
      }
    }
    
    function showPhoneAuth() {
      document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
      document.getElementById('phoneForm').classList.add('active');
      
      if (!window.recaptchaVerifier) {
        window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
          'size': 'normal'
        });
      }
    }
    
    async function handlePhoneAuth(e) {
      e.preventDefault();
      
      const phoneNumber = document.getElementById('phoneNumber').value;
      
      try {
        const confirmationResult = await auth.signInWithPhoneNumber(phoneNumber, window.recaptchaVerifier);
        window.confirmationResult = confirmationResult;
        
        document.getElementById('verificationGroup').classList.remove('hidden');
        showToast('Verification code sent!', 'success');
      } catch (error) {
        console.error('Phone auth error:', error);
        showToast(error.message, 'error');
      }
    }
    
    async function verifyPhoneCode() {
      const code = document.getElementById('verificationCode').value;
      
      try {
        await window.confirmationResult.confirm(code);
        showToast('Phone verified successfully!', 'success');
      } catch (error) {
        console.error('Verification error:', error);
        showToast(error.message, 'error');
      }
    }
    
    function backToEmailAuth() {
      document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
      document.getElementById('signinForm').classList.add('active');
    }
    
    async function handleLogout() {
      const confirmModal = document.createElement('div');
      confirmModal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
      confirmModal.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 400px; text-align: center;">
          <h3 style="margin-bottom: 20px;">Are you sure you want to log out?</h3>
          <div style="display: flex; gap: 12px; justify-content: center;">
            <button class="btn btn-secondary" onclick="this.closest('div').parentElement.remove()">Cancel</button>
            <button class="btn btn-danger" onclick="confirmLogout()">Logout</button>
          </div>
        </div>
      `;
      document.body.appendChild(confirmModal);
    }
    
    async function confirmLogout() {
      await auth.signOut();
      showToast('Logged out successfully', 'info');
      location.reload();
    }
    
    function showAuthScreen() {
      document.getElementById('authScreen').style.display = 'flex';
      document.getElementById('appScreen').style.display = 'none';
    }
    
    function showPendingApprovalScreen() {
      document.getElementById('authScreen').style.display = 'flex';
      document.getElementById('appScreen').style.display = 'none';
      
      document.getElementById('authScreen').innerHTML = `
        <div class="auth-container">
          <div class="auth-header">
            <h1>‚è≥ Pending Approval</h1>
            <p>Your application is being reviewed</p>
          </div>
          <div style="text-align: center; padding: 40px 20px;">
            <div style="font-size: 64px; margin-bottom: 20px;">‚è∞</div>
            <p style="color: var(--text-muted); margin-bottom: 20px;">
              Your application for <strong>${currentUserData.role}</strong> in <strong>${currentOrgData.name}</strong> is pending approval from the officers.
              You will receive access once your application is reviewed.
            </p>
            <button class="btn btn-secondary" onclick="showChangeOrgScreen()" style="margin-top: 20px; margin-right: 12px;">
              ÔøΩÔøΩÔøΩÔøΩ Switch Organization
            </button>
            <button class="btn btn-danger" onclick="handleLogout()" style="margin-top: 20px;">Logout</button>
          </div>
        </div>
      `;
    }
    
    function showChangeOrgScreen() {
      document.getElementById('authScreen').style.display = 'flex';
      document.getElementById('appScreen').style.display = 'none';
      showOrgSelectionScreen();
    }
    
    function showOrgInfo() {
      const canEditOrg = currentUserData.role === 'PRESIDENT' || currentUserData.isHeadAdmin;
      
      showModal('Organization Info', `
        <div style="padding: 20px; text-align: center;">
          <div style="width: 150px; height: 150px; border-radius: 50%; background: var(--light); margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 3px solid var(--border);">
            ${currentOrgData.photoURL 
              ? `<img src="${currentOrgData.photoURL}" style="width: 100%; height: 100%; object-fit: cover;">` 
              : `<svg width="80" height="80" fill="currentColor" viewBox="0 0 20 20"><path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0zM6 18a1 1 0 001-1v-2.065a8.935 8.935 0 00-2-.712V17a1 1 0 001 1z"/></svg>`
            }
          </div>
          
          ${canEditOrg ? `
            <button class="btn btn-small btn-primary" onclick="showChangeOrgPhotoModal()" style="margin-bottom: 20px;">üì∑ Change Organization Photo</button>
          ` : ''}
          
          <h3>${currentOrgData.name}</h3>
          <p style="color: var(--text-muted); margin-top: 8px;">
            <strong>Organization ID:</strong> ${currentOrgId}
          </p>
          ${currentOrgData.description ? `
            <p style="margin-top: 12px; text-align: left;">${currentOrgData.description}</p>
          ` : ''}
          <p style="margin-top: 12px; color: var(--text-muted); font-size: 13px;">
            Created ${new Date(currentOrgData.createdAt).toLocaleDateString()}
          </p>
          <div style="margin-top: 24px; padding: 16px; background: var(--light); border-radius: 8px; text-align: left;">
            <p style="font-size: 13px; color: var(--text-muted);">Share this Organization ID with others so they can join:</p>
            <div style="display: flex; gap: 8px; margin-top: 8px;">
              <input type="text" value="${currentOrgId}" readonly style="flex: 1; padding: 8px; border: 2px solid var(--border); border-radius: 6px; font-family: monospace;">
              <button class="btn btn-small btn-primary" onclick="copyOrgId()">Copy</button>
            </div>
          </div>
        </div>
      `, `<button class="btn btn-primary" onclick="closeModal()">Close</button>`);
    }
    
    function copyOrgId() {
      navigator.clipboard.writeText(currentOrgId);
      showToast('Organization ID copied to clipboard', 'success');
    }
    
    function showChangeOrgPhotoModal() {
      closeModal();
      
      setTimeout(() => {
        showModal('Change Organization Photo', `
          <div style="text-align: center;">
            <div id="currentOrgPhotoPreview" style="width: 150px; height: 150px; border-radius: 50%; background: var(--light); margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 3px solid var(--border);">
              ${currentOrgData.photoURL 
                ? `<img src="${currentOrgData.photoURL}" style="width: 100%; height: 100%; object-fit: cover;">` 
                : `<svg width="60" height="60" fill="currentColor" viewBox="0 0 20 20"><path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0zM6 18a1 1 0 001-1v-2.065a8.935 8.935 0 00-2-.712V17a1 1 0 001 1z"/></svg>`
              }
            </div>
            
            <div class="form-group">
              <label>Upload New Photo</label>
              <input type="file" id="orgPhotoInput" accept="image/*" onchange="previewOrgPhoto(event)">
              <div class="form-hint">Recommended: Square image, at least 200x200px</div>
            </div>
            
            <div id="uploadOrgProgress" style="display: none; margin-top: 20px;">
              <div style="background: var(--light); height: 8px; border-radius: 4px; overflow: hidden;">
                <div id="uploadOrgProgressBar" style="background: var(--primary); height: 100%; width: 0%; transition: width 0.3s;"></div>
              </div>
              <p style="margin-top: 8px; font-size: 12px; color: var(--text-muted);">Uploading...</p>
            </div>
          </div>
        `, `
          <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
          <button class="btn btn-primary" onclick="uploadOrgPhoto()" id="uploadOrgPhotoBtn">Upload Photo</button>
          ${currentOrgData.photoURL ? `<button class="btn btn-danger" onclick="removeOrgPhoto()">Remove Photo</button>` : ''}
        `);
      }, 100);
    }
    
    function previewOrgPhoto(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('currentOrgPhotoPreview').innerHTML = `
            <img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover;">
          `;
        };
        reader.readAsDataURL(file);
      }
    }
    
    async function uploadOrgPhoto() {
      const fileInput = document.getElementById('orgPhotoInput');
      const file = fileInput.files[0];
      
      if (!file) {
        showToast('Please select a photo', 'error');
        return;
      }
      
      if (file.size > 5 * 1024 * 1024) {
        showToast('File size must be less than 5MB', 'error');
        return;
      }
      
      try {
        document.getElementById('uploadOrgProgress').style.display = 'block';
        document.getElementById('uploadOrgPhotoBtn').disabled = true;
        document.getElementById('uploadOrgProgressBar').style.width = '30%';
        
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', CONFIG.CLOUDINARY.UPLOAD_PRESET);
        formData.append('folder', `${currentOrgId}/org`);
        
        document.getElementById('uploadOrgProgressBar').style.width = '60%';
        
        const response = await fetch(`https://api.cloudinary.com/v1_1/${CONFIG.CLOUDINARY.CLOUD_NAME}/image/upload`, {
          method: 'POST',
          body: formData
        });
        
        if (!response.ok) throw new Error('Upload failed');
        
        const data = await response.json();
        document.getElementById('uploadOrgProgressBar').style.width = '90%';
        
        await database.ref(`orgs/${currentOrgId}`).update({
          photoURL: data.secure_url
        });
        
        currentOrgData.photoURL = data.secure_url;
        
        document.getElementById('uploadOrgProgressBar').style.width = '100%';
        
        await addAuditLog('ORG_PHOTO_UPDATE', currentUser.uid, 'Updated organization photo');
        
        closeModal();
        showToast('Organization photo updated successfully!', 'success');
      } catch (error) {
        console.error('Upload org photo error:', error);
        showToast('Failed to upload photo. Please try again.', 'error');
        document.getElementById('uploadOrgPhotoBtn').disabled = false;
        document.getElementById('uploadOrgProgress').style.display = 'none';
      }
    }
    
    async function removeOrgPhoto() {
      const confirmModal = document.createElement('div');
      confirmModal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
      confirmModal.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 400px; text-align: center;">
          <h3 style="margin-bottom: 20px;">Remove organization photo?</h3>
          <div style="display: flex; gap: 12px; justify-content: center;">
            <button class="btn btn-secondary" onclick="this.closest('div').parentElement.remove()">Cancel</button>
            <button class="btn btn-danger" onclick="confirmRemoveOrgPhoto()">Remove</button>
          </div>
        </div>
      `;
      document.body.appendChild(confirmModal);
    }
    
    async function confirmRemoveOrgPhoto() {
      try {
        await database.ref(`orgs/${currentOrgId}`).update({
          photoURL: null
        });
        
        currentOrgData.photoURL = null;
        
        await addAuditLog('ORG_PHOTO_REMOVE', currentUser.uid, 'Removed organization photo');
        
        document.querySelector('[style*="z-index: 10000"]').remove();
        closeModal();
        showToast('Organization photo removed', 'success');
      } catch (error) {
        console.error('Remove org photo error:', error);
        showToast('Failed to remove photo', 'error');
      }
    }
    
    function loadMainApp() {
      document.getElementById('authScreen').style.display = 'none';
      document.getElementById('appScreen').style.display = 'block';
      
      document.getElementById('orgNameHeader').textContent = `üéì ${currentOrgData.name}`;
      
      const initials = currentUserData.name.split(' ').map(n => n[0]).join('').toUpperCase();
      const userAvatar = document.getElementById('userAvatar');
      
      if (currentUserData.photoURL) {
        userAvatar.innerHTML = `<img src="${currentUserData.photoURL}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
      } else {
        userAvatar.textContent = initials;
      }
      
      document.getElementById('userName').textContent = currentUserData.name;
      document.getElementById('userRole').textContent = currentUserData.role;
      document.getElementById('userRole').className = `role-pill role-${currentUserData.role}`;
      
      buildNavigation();
      
      loadDashboard();
      
      if (hasPermission('audit_write')) {
        document.getElementById('addAuditBtn').style.display = 'inline-block';
      }
      
      // Apply member view-only restrictions
      applyMemberRestrictions();
    }
    
    function applyMemberRestrictions() {
      const isMemberViewOnly = currentUserData.role === 'MEMBER' && !currentUserData.isHeadAdmin;
      
      if (isMemberViewOnly) {
        // Disable all action buttons by applying disabled style
        setTimeout(() => {
          const actionButtons = document.querySelectorAll('.btn-success, .btn-primary[onclick*="show"], .btn-info[onclick*="show"]');
          actionButtons.forEach(btn => {
            if (btn.textContent.includes('Create') || 
                btn.textContent.includes('Add') || 
                btn.textContent.includes('Upload') || 
                btn.textContent.includes('‚ûï') ||
                btn.textContent.includes('‚¨ÜÔ∏è') ||
                btn.textContent.includes('üì•')) {
              btn.style.opacity = '0.5';
              btn.style.cursor = 'not-allowed';
              btn.disabled = true;
              const originalOnclick = btn.getAttribute('onclick');
              btn.removeAttribute('onclick');
              btn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                showToast('Members have view-only access. Only officers can perform actions.', 'info');
              });
            }
          });
        }, 100);
      }
    }
    
    function buildNavigation() {
      const nav = document.getElementById('sidebarNav');
      const navItems = [
        { id: 'dashboard', label: 'Dashboard', icon: 'üìä', permission: 'all' },
        { id: 'members', label: 'Members', icon: 'üë•', permission: 'members' },
        { id: 'audit', label: 'Audit Logs', icon: 'üìù', permission: 'audit' },
        { id: 'events', label: 'Events', icon: 'üìÜ', permission: 'events' },
        { id: 'attendance', label: 'Attendance', icon: '‚úì', permission: 'attendance' },
        { id: 'files', label: 'Files', icon: 'üìÅ', permission: 'files' },
        { id: 'inventory', label: 'Inventory', icon: 'üì¶', permission: 'inventory' },
        { id: 'finance', label: 'Finance', icon: 'üí∞', permission: 'finance' },
        { id: 'announcements', label: 'Announcements', icon: 'üì¢', permission: 'announcements' },
        { id: 'chat', label: 'Chat', icon: 'üí¨', permission: 'chat' },
        { id: 'tasks', label: 'Tasks', icon: '‚úî', permission: 'tasks' },
        { id: 'polls', label: 'Polls', icon: 'üìä', permission: 'polls' },
        { id: 'profile', label: 'Profile', icon: 'üë§', permission: 'all' }
      ];
      
      nav.innerHTML = '';
      navItems.forEach((item, index) => {
        if (hasPermission(item.permission)) {
          const li = document.createElement('li');
          li.innerHTML = `<span class="icon">${item.icon}</span> ${item.label}`;
          li.classList.toggle('active', index === 0);
          li.onclick = () => switchSection(item.id);
          nav.appendChild(li);
        }
      });
    }
    
    function switchSection(sectionId) {
      document.querySelectorAll('.sidebar-nav li').forEach(li => li.classList.remove('active'));
      event.target.closest('li').classList.add('active');
      
      document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
      document.getElementById(`${sectionId}Section`).classList.add('active');
      
      switch(sectionId) {
        case 'dashboard': loadDashboard(); break;
        case 'members': loadMembers(); break;
        case 'audit': loadAuditLogs(); break;
        case 'events': loadEvents(); break;
        case 'attendance': loadAttendance(); break;
        case 'files': loadFiles(); break;
        case 'inventory': loadInventory(); break;
        case 'finance': loadFinance(); break;
        case 'announcements': loadAnnouncements(); break;
        case 'chat': loadChat(); break;
        case 'tasks': loadTasks(); break;
        case 'polls': loadPolls(); break;
        case 'profile': loadProfile(); break;
      }
      
      // Reapply member restrictions after loading new section
      applyMemberRestrictions();
      
      localStorage.setItem('lastSection', sectionId);
    }
    
    function hasPermission(permission) {
      if (!currentUserData) return false;
      
      // Head admins have all permissions
      if (currentUserData.isHeadAdmin) return true;
      
      const userPerms = PERMISSIONS[currentUserData.role] || [];
      return userPerms.includes('all') || userPerms.includes(permission);
    }
    
    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.innerHTML = `
        <div style="font-weight: 600;">${type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : '‚Ñπ'}</div>
        <div>${message}</div>
      `;
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.style.animation = 'slideInRight 0.3s reverse';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
    
    function showModal(title, bodyHTML, footerHTML) {
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalBody').innerHTML = bodyHTML;
      document.getElementById('modalFooter').innerHTML = footerHTML;
      document.getElementById('universalModal').classList.add('active');
    }
    
    function closeModal() {
      document.getElementById('universalModal').classList.remove('active');
    }
    
    async function loadDashboard() {
      try {
        const membersSnapshot = await database.ref(`orgs/${currentOrgId}/members`).once('value');
        const membersCount = membersSnapshot.numChildren();
        document.getElementById('widgetMembers').textContent = membersCount;
        
        const membersWithApprovalSnapshot = await database.ref(`orgs/${currentOrgId}/members`).once('value');
        let pendingCount = 0;
        membersWithApprovalSnapshot.forEach(child => {
          if (child.val().approved === false) pendingCount++;
        });
        document.getElementById('widgetPending').textContent = pendingCount;
        
        const eventsSnapshot = await database.ref(`orgs/${currentOrgId}/events`).once('value');
        let upcomingCount = 0;
        const now = Date.now();
        eventsSnapshot.forEach(child => {
          if (child.val().date > now) upcomingCount++;
        });
        document.getElementById('widgetEvents').textContent = upcomingCount;
        
        if (hasPermission('finance')) {
          const financeSnapshot = await database.ref(`orgs/${currentOrgId}/finance`).once('value');
          let income = 0, expenses = 0;
          financeSnapshot.forEach(child => {
            const txn = child.val();
            if (txn.type === 'income') income += txn.amount;
            else expenses += txn.amount;
          });
          document.getElementById('widgetBudget').textContent = `‚Ç±${(income - expenses).toLocaleString()}`;
        }
        
        const announcementsSnapshot = await database.ref(`orgs/${currentOrgId}/announcements`)
          .orderByChild('timestamp')
          .limitToLast(3)
          .once('value');
        
        const announcementsHTML = [];
        announcementsSnapshot.forEach(child => {
          const a = child.val();
          announcementsHTML.unshift(`
            <div style="padding: 16px; border-bottom: 1px solid var(--border);">
              <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <strong>${a.title}</strong>
                <span style="font-size: 12px; color: var(--text-muted);">${new Date(a.timestamp).toLocaleDateString()}</span>
              </div>
              <p style="color: var(--text-muted); font-size: 14px;">${a.content}</p>
            </div>
          `);
        });
        
        document.getElementById('recentAnnouncements').innerHTML = announcementsHTML.length > 0 
          ? announcementsHTML.join('') 
          : '<p style="text-align: center; color: var(--text-muted); padding: 20px;">No announcements yet.</p>';
          
      } catch (error) {
        console.error('Dashboard load error:', error);
        showToast('Failed to load dashboard data', 'error');
      }
    }
    
    async function loadMembers() {
      try {
        const snapshot = await database.ref(`orgs/${currentOrgId}/members`).once('value');
        const tbody = document.getElementById('membersTableBody');
        
        const approvedRows = [];
        const pendingRows = [];
        
        // Check if current user is President or Head Admin for approval permissions
        const canApprove = currentUserData.role === 'PRESIDENT' || currentUserData.isHeadAdmin;
        
        snapshot.forEach(child => {
          const member = child.val();
          
          if (member.approved) {
            approvedRows.push(`
              <tr data-role="${member.role}" data-status="approved" data-admin="${member.isHeadAdmin ? 'true' : 'false'}">
                <td>${member.name}${member.isHeadAdmin ? ' üëë' : ''}</td>
                <td>${member.email}</td>
                <td><span class="role-pill role-${member.role}">${member.role}</span></td>
                <td><span style="color: var(--secondary);">‚úì Approved</span></td>
                <td>
                  ${hasPermission('members') ? `
                    <button class="btn btn-small btn-info" onclick="viewMemberProfile('${member.uid}')">View</button>
                    ${hasPermission('all') ? `<button class="btn btn-small btn-danger" onclick="removeMember('${member.uid}')">Remove</button>` : ''}
                  ` : ''}
                </td>
              </tr>
            `);
          } else {
            pendingRows.push(`
              <tr style="background: #fef3c7;" data-role="${member.role}" data-status="pending" data-admin="false">
                <td>${member.name}</td>
                <td>${member.email}</td>
                <td><span class="role-pill role-${member.role}">${member.role}</span></td>
                <td><span style="color: var(--warning);">‚è≥ Pending</span></td>
                <td>
                  ${canApprove ? `
                    <button class="btn btn-small btn-success" onclick="approveMember('${member.uid}')">‚úì Approve</button>
                    <button class="btn btn-small btn-danger" onclick="rejectMember('${member.uid}')">‚úó Reject</button>
                  ` : ''}
                </td>
              </tr>
            `);
          }
        });
        
        const allRows = [...pendingRows, ...approvedRows];
        tbody.innerHTML = allRows.length > 0 ? allRows.join('') : '<tr><td colspan="5" style="text-align: center; padding: 40px;">No members found</td></tr>';
      } catch (error) {
        console.error('Load members error:', error);
        showToast('Failed to load members', 'error');
      }
    }
    
    function filterMembers() {
      const search = document.getElementById('memberSearch').value.toLowerCase();
      const roleFilter = document.getElementById('memberRoleFilter').value;
      const statusFilter = document.getElementById('memberStatusFilter').value;
      const rows = document.querySelectorAll('#membersTableBody tr');
      
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        const rowData = row.dataset;
        
        let show = true;
        
        // Search filter
        if (search && !text.includes(search)) {
          show = false;
        }
        
        // Role filter
        if (roleFilter && rowData.role !== roleFilter) {
          show = false;
        }
        
        // Status filter
        if (statusFilter === 'approved' && rowData.status !== 'approved') {
          show = false;
        }
        if (statusFilter === 'pending' && rowData.status !== 'pending') {
          show = false;
        }
        if (statusFilter === 'admin' && rowData.admin !== 'true') {
          show = false;
        }
        
        row.style.display = show ? '' : 'none';
      });
    }
    
    async function exportMembersCSV() {
      try {
        const snapshot = await database.ref(`orgs/${currentOrgId}/members`).once('value');
        const rows = [['Name', 'Email', 'Role', 'Status', 'Joined']];
        
        snapshot.forEach(child => {
          const m = child.val();
          rows.push([
            m.name,
            m.email,
            m.role,
            m.approved ? 'Approved' : 'Pending',
            new Date(m.createdAt).toLocaleDateString()
          ]);
        });
        
        const csv = rows.map(row => row.join(',')).join('\n');
        downloadFile(`members-${Date.now()}.csv`, csv);
        showToast('Members exported successfully', 'success');
      } catch (error) {
        console.error('Export error:', error);
        showToast('Failed to export members', 'error');
      }
    }
    
    async function viewMemberProfile(uid) {
      try {
        const snapshot = await database.ref(`orgs/${currentOrgId}/members/${uid}`).once('value');
        const member = snapshot.val();
        
        const attendanceSnapshot = await database.ref(`orgs/${currentOrgId}/attendance`).once('value');
        let attended = 0, total = 0;
        attendanceSnapshot.forEach(child => {
          total++;
          const session = child.val();
          if (session.attendees && session.attendees[uid]) attended++;
        });
        
        const avatarHTML = member.photoURL 
          ? `<img src="${member.photoURL}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">` 
          : member.name.split(' ').map(n => n[0]).join('').toUpperCase();
        
        showModal('Member Profile', `
          <div style="text-align: center;">
            <div style="width: 100px; height: 100px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-size: 36px; font-weight: 700; margin: 0 auto 20px; overflow: hidden;">
              ${avatarHTML}
            </div>
            <h3>${member.name}</h3>
            <span class="role-pill role-${member.role}">${member.role}</span>
            <p style="color: var(--text-muted); margin-top: 12px;">${member.email}</p>
            <div style="margin-top: 30px; text-align: left;">
              <h4>Statistics</h4>
              <p>Attendance: ${attended}/${total} sessions (${total > 0 ? Math.round(attended/total*100) : 0}%)</p>
              <p>Member since: ${new Date(member.createdAt).toLocaleDateString()}</p>
            </div>
          </div>
        `, `<button class="btn btn-secondary" onclick="closeModal()">Close</button>`);
      } catch (error) {
        console.error('View profile error:', error);
        showToast('Failed to load profile', 'error');
      }
    }
    
    async function loadProfile() {
      try {
        const initials = currentUserData.name.split(' ').map(n => n[0]).join('').toUpperCase();
        const avatarLarge = document.getElementById('profileAvatarLarge');
        
        if (currentUserData.photoURL) {
          avatarLarge.innerHTML = `<img src="${currentUserData.photoURL}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
        } else {
          avatarLarge.textContent = initials;
        }
        
        document.getElementById('profileName').textContent = currentUserData.name;
        document.getElementById('profileRole').textContent = currentUserData.role;
        document.getElementById('profileRole').className = `role-pill role-${currentUserData.role}`;
        document.getElementById('profileEmail').textContent = currentUserData.email;
        
        // Generate QR code with fade-in effect
        const qrCanvas = document.getElementById('profileQR');
        const qrData = JSON.stringify({
          type: 'student_id',
          uid: currentUser.uid,
          name: currentUserData.name,
          orgId: currentOrgId
        });
        
        // Clear canvas and set initial opacity
        qrCanvas.style.opacity = '0';
        qrCanvas.style.transition = 'opacity 0.5s ease-in-out';
        const ctx = qrCanvas.getContext('2d');
        ctx.clearRect(0, 0, qrCanvas.width, qrCanvas.height);
        
        // Generate QR code
        QRCode.toCanvas(qrCanvas, qrData, { width: 200 }, (error) => {
          if (error) {
            console.error('QR generation error:', error);
          } else {
            // Fade in the QR code after generation
            setTimeout(() => {
              qrCanvas.style.opacity = '1';
            }, 100);
          }
        });
        
        // Load attendance stats ONCE
        const attendanceSnapshot = await database.ref(`orgs/${currentOrgId}/attendance`).once('value');
        let attended = 0, total = 0;
        attendanceSnapshot.forEach(child => {
          total++;
          const session = child.val();
          if (session.attendees && session.attendees[currentUser.uid]) attended++;
        });
        
        // Check if stats section already exists
        const profileCard = document.querySelector('#profileSection .card > div');
        let statsSection = profileCard.querySelector('.profile-stats-section');
        
        if (!statsSection) {
          // Create stats section only if it doesn't exist
          const statsHTML = `
            <div class="profile-stats-section" style="margin-top: 30px; padding: 20px; background: var(--light); border-radius: 8px; opacity: 0; transition: opacity 0.5s ease-in-out;">
              <h4 style="margin-bottom: 16px;">Statistics</h4>
              <p style="margin-bottom: 8px;">‚úì Attendance: ${attended}/${total} sessions (${total > 0 ? Math.round(attended/total*100) : 0}%)</p>
              <p style="margin-bottom: 8px;">üìÖ Member since: ${new Date(currentUserData.createdAt).toLocaleDateString()}</p>
            </div>
          `;
          profileCard.insertAdjacentHTML('beforeend', statsHTML);
          
          // Fade in the stats section
          setTimeout(() => {
            statsSection = profileCard.querySelector('.profile-stats-section');
            if (statsSection) {
              statsSection.style.opacity = '1';
            }
          }, 200);
        } else {
          // Update existing stats section content
          statsSection.innerHTML = `
            <h4 style="margin-bottom: 16px;">Statistics</h4>
            <p style="margin-bottom: 8px;">‚úì Attendance: ${attended}/${total} sessions (${total > 0 ? Math.round(attended/total*100) : 0}%)</p>
            <p style="margin-bottom: 8px;">üìÖ Member since: ${new Date(currentUserData.createdAt).toLocaleDateString()}</p>
          `;
        }
      } catch (error) {
        console.error('Load profile error:', error);
        showToast('Failed to load profile', 'error');
      }
    }
    
    function showChangeNameModal() {
      showModal('Change Display Name', `
        <div class="form-group">
          <label>Current Name</label>
          <input type="text" value="${currentUserData.name}" disabled style="background: var(--light);">
        </div>
        <div class="form-group">
          <label>New Display Name</label>
          <input type="text" id="newDisplayName" placeholder="Enter new display name" value="${currentUserData.name}">
          <div class="form-hint">This is the name that will be shown throughout the app</div>
        </div>
      `, `
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="updateDisplayName()">Update Name</button>
      `);
    }
    
    async function updateDisplayName() {
      const newName = document.getElementById('newDisplayName').value.trim();
      
      if (!newName) {
        showToast('Please enter a display name', 'error');
        return;
      }
      
      if (newName === currentUserData.name) {
        showToast('New name is the same as current name', 'info');
        return;
      }
      
      try {
        await database.ref(`orgs/${currentOrgId}/members/${currentUser.uid}`).update({
          name: newName
        });
        
        currentUserData.name = newName;
        
        document.getElementById('userName').textContent = newName;
        
        await addAuditLog('PROFILE_UPDATE', currentUser.uid, `Changed display name to: ${newName}`);
        
        closeModal();
        showToast('Display name updated successfully!', 'success');
        loadProfile();
      } catch (error) {
        console.error('Update name error:', error);
        showToast('Failed to update display name', 'error');
      }
    }
    
    function showChangePhotoModal() {
      showModal('Change Profile Picture', `
        <div style="text-align: center;">
          <div id="currentPhotoPreview" style="width: 150px; height: 150px; border-radius: 50%; background: var(--light); margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 3px solid var(--border);">
            ${currentUserData.photoURL 
              ? `<img src="${currentUserData.photoURL}" style="width: 100%; height: 100%; object-fit: cover;">` 
              : `<span style="font-size: 48px; color: var(--text-muted);">${currentUserData.name.split(' ').map(n => n[0]).join('').toUpperCase()}</span>`
            }
          </div>
          
          <div class="form-group">
            <label>Upload New Photo</label>
            <input type="file" id="profilePhotoInput" accept="image/*" onchange="previewProfilePhoto(event)">
            <div class="form-hint">Recommended: Square image, at least 200x200px</div>
          </div>
          
          <div id="uploadProgress" style="display: none; margin-top: 20px;">
            <div style="background: var(--light); height: 8px; border-radius: 4px; overflow: hidden;">
              <div id="uploadProgressBar" style="background: var(--primary); height: 100%; width: 0%; transition: width 0.3s;"></div>
            </div>
            <p style="margin-top: 8px; font-size: 12px; color: var(--text-muted);">Uploading...</p>
          </div>
        </div>
      `, `
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="uploadProfilePhoto()" id="uploadPhotoBtn">Upload Photo</button>
        ${currentUserData.photoURL ? `<button class="btn btn-danger" onclick="removeProfilePhoto()">Remove Photo</button>` : ''}
      `);
    }
    
    function previewProfilePhoto(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('currentPhotoPreview').innerHTML = `
            <img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover;">
          `;
        };
        reader.readAsDataURL(file);
      }
    }
    
    async function uploadProfilePhoto() {
      const fileInput = document.getElementById('profilePhotoInput');
      const file = fileInput.files[0];
      
      if (!file) {
        showToast('Please select a photo', 'error');
        return;
      }
      
      if (file.size > 5 * 1024 * 1024) {
        showToast('File size must be less than 5MB', 'error');
        return;
      }
      
      try {
        document.getElementById('uploadProgress').style.display = 'block';
        document.getElementById('uploadPhotoBtn').disabled = true;
        document.getElementById('uploadProgressBar').style.width = '30%';
        
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', CONFIG.CLOUDINARY.UPLOAD_PRESET);
        formData.append('folder', `${currentOrgId}/profiles`);
        
        document.getElementById('uploadProgressBar').style.width = '60%';
        
        const response = await fetch(`https://api.cloudinary.com/v1_1/${CONFIG.CLOUDINARY.CLOUD_NAME}/image/upload`, {
          method: 'POST',
          body: formData
        });
        
        if (!response.ok) throw new Error('Upload failed');
        
        const data = await response.json();
        document.getElementById('uploadProgressBar').style.width = '90%';
        
        await database.ref(`orgs/${currentOrgId}/members/${currentUser.uid}`).update({
          photoURL: data.secure_url
        });
        
        currentUserData.photoURL = data.secure_url;
        
        const userAvatar = document.getElementById('userAvatar');
        userAvatar.innerHTML = `<img src="${data.secure_url}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
        
        document.getElementById('uploadProgressBar').style.width = '100%';
        
        await addAuditLog('PROFILE_UPDATE', currentUser.uid, 'Updated profile picture');
        
        closeModal();
        showToast('Profile picture updated successfully!', 'success');
        loadProfile();
      } catch (error) {
        console.error('Upload photo error:', error);
        showToast('Failed to upload photo. Please try again.', 'error');
        document.getElementById('uploadPhotoBtn').disabled = false;
        document.getElementById('uploadProgress').style.display = 'none';
      }
    }
    
    async function removeProfilePhoto() {
      const confirmModal = document.createElement('div');
      confirmModal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
      confirmModal.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 400px; text-align: center;">
          <h3 style="margin-bottom: 20px;">Remove your profile picture?</h3>
          <div style="display: flex; gap: 12px; justify-content: center;">
            <button class="btn btn-secondary" onclick="this.closest('div').parentElement.remove()">Cancel</button>
            <button class="btn btn-danger" onclick="confirmRemovePhoto()">Remove</button>
          </div>
        </div>
      `;
      document.body.appendChild(confirmModal);
    }
    
    async function confirmRemovePhoto() {
      try {
        await database.ref(`orgs/${currentOrgId}/members/${currentUser.uid}`).update({
          photoURL: null
        });
        
        currentUserData.photoURL = null;
        
        const initials = currentUserData.name.split(' ').map(n => n[0]).join('').toUpperCase();
        const userAvatar = document.getElementById('userAvatar');
        userAvatar.textContent = initials;
        
        await addAuditLog('PROFILE_UPDATE', currentUser.uid, 'Removed profile picture');
        
        document.querySelector('[style*="z-index: 10000"]').remove();
        closeModal();
        showToast('Profile picture removed', 'success');
        loadProfile();
      } catch (error) {
        console.error('Remove photo error:', error);
        showToast('Failed to remove photo', 'error');
      }
    }
    
    async function approveMember(uid) {
      try {
        const memberSnapshot = await database.ref(`orgs/${currentOrgId}/members/${uid}`).once('value');
        const member = memberSnapshot.val();
        
        await database.ref(`orgs/${currentOrgId}/members/${uid}`).update({
          approved: true
        });
        
        await database.ref(`userOrgs/${uid}/${currentOrgId}`).update({
          approved: true
        });
        
        await addAuditLog('MEMBER_APPROVE', currentUser.uid, `Approved ${member.name} as ${member.role}`);
        await sendDiscordNotification(`ÔøΩÔøΩ ${member.name} has been approved as ${member.role} in ${currentOrgData.name}`);
        
        showToast(`${member.name} approved successfully`, 'success');
        loadMembers();
        loadDashboard();
      } catch (error) {
        console.error('Approve member error:', error);
        showToast('Failed to approve member', 'error');
      }
    }
    
    async function rejectMember(uid) {
      const confirmModal = document.createElement('div');
      confirmModal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
      confirmModal.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 400px; text-align: center;">
          <h3 style="margin-bottom: 20px;">Reject this application?</h3>
          <p style="color: var(--text-muted); margin-bottom: 20px;">This will remove them from the organization.</p>
          <div style="display: flex; gap: 12px; justify-content: center;">
            <button class="btn btn-secondary" onclick="this.closest('div').parentElement.remove()">Cancel</button>
            <button class="btn btn-danger" onclick="confirmRejectMember('${uid}')">Reject</button>
          </div>
        </div>
      `;
      document.body.appendChild(confirmModal);
    }
    
    async function confirmRejectMember(uid) {
      try {
        const memberSnapshot = await database.ref(`orgs/${currentOrgId}/members/${uid}`).once('value');
        const member = memberSnapshot.val();
        
        await database.ref(`orgs/${currentOrgId}/members/${uid}`).remove();
        await database.ref(`userOrgs/${uid}/${currentOrgId}`).remove();
        
        await addAuditLog('MEMBER_REJECT', currentUser.uid, `Rejected application from ${member.name}`);
        await sendDiscordNotification(`‚ùå ${member.name}'s application for ${member.role} was rejected in ${currentOrgData.name}`);
        
        showToast('Application rejected', 'success');
        loadMembers();
        loadDashboard();
        document.querySelector('[style*="z-index: 10000"]').remove();
      } catch (error) {
        console.error('Reject member error:', error);
        showToast('Failed to reject application', 'error');
      }
    }
    
    async function removeMember(uid) {
      const confirmModal = document.createElement('div');
      confirmModal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
      confirmModal.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 400px; text-align: center;">
          <h3 style="margin-bottom: 20px;">Are you sure you want to remove this member?</h3>
          <div style="display: flex; gap: 12px; justify-content: center;">
            <button class="btn btn-secondary" onclick="this.closest('div').parentElement.remove()">Cancel</button>
            <button class="btn btn-danger" onclick="confirmRemoveMember('${uid}')">Remove</button>
          </div>
        </div>
      `;
      document.body.appendChild(confirmModal);
    }
    
    async function confirmRemoveMember(uid) {
      try {
        const memberSnapshot = await database.ref(`orgs/${currentOrgId}/members/${uid}`).once('value');
        const member = memberSnapshot.val();
        
        await database.ref(`orgs/${currentOrgId}/members/${uid}`).remove();
        await database.ref(`userOrgs/${uid}/${currentOrgId}`).remove();
        
        await addAuditLog('MEMBER_REMOVE', currentUser.uid, `Removed member ${member.name}`);
        showToast('Member removed', 'success');
        loadMembers();
        document.querySelector('[style*="z-index: 10000"]').remove();
      } catch (error) {
        console.error('Remove member error:', error);
        showToast('Failed to remove member', 'error');
      }
    }
    
    async function loadAuditLogs() {
      if (!hasPermission('audit')) {
        document.getElementById('auditTableBody').innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px;">You do not have permission to view audit logs.</td></tr>';
        return;
      }
      
      try {
        const snapshot = await database.ref(`orgs/${currentOrgId}/auditLogs`)
          .orderByChild('timestamp')
          .limitToLast(50)
          .once('value');
        
        const tbody = document.getElementById('auditTableBody');
        const rows = [];
        const canEdit = currentUserData.isHeadAdmin;
        
        snapshot.forEach(child => {
          const log = child.val();
          const logId = child.key;
          rows.unshift(`
            <tr>
              <td>${new Date(log.timestamp).toLocaleString()}</td>
              <td>${log.action}</td>
              <td>${log.userName || log.userId}</td>
              <td>${log.details}</td>
              <td>
                ${canEdit ? `<button class="btn btn-small btn-danger" onclick="deleteAuditLog('${logId}')">Delete</button>` : ''}
              </td>
            </tr>
          `);
        });
        
        tbody.innerHTML = rows.length > 0 ? rows.join('') : '<tr><td colspan="5" style="text-align: center; padding: 40px;">No audit logs</td></tr>';
        
        // Show/hide add button based on head admin status
        const addBtn = document.getElementById('addAuditBtn');
        if (addBtn) {
          addBtn.style.display = canEdit ? 'inline-block' : 'none';
        }
      } catch (error) {
        console.error('Load audit logs error:', error);
        showToast('Failed to load audit logs', 'error');
      }
    }
    
    async function addAuditLog(action, userId, details) {
      try {
        await database.ref(`orgs/${currentOrgId}/auditLogs`).push({
          action: action,
          userId: userId,
          userName: currentUserData?.name || 'System',
          details: details,
          timestamp: Date.now()
        });
      } catch (error) {
        console.error('Add audit log error:', error);
      }
    }
    
    function showAddAuditModal() {
      showModal('Add Audit Entry', `
        <div class="form-group">
          <label>Action</label>
          <input type="text" id="auditAction" placeholder="e.g., CUSTOM_ACTION">
        </div>
        <div class="form-group">
          <label>Details</label>
          <textarea id="auditDetails" placeholder="Description of the action..."></textarea>
        </div>
      `, `
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="submitAuditEntry()">Add Entry</button>
      `);
    }
    
    async function submitAuditEntry() {
      const action = document.getElementById('auditAction').value;
      const details = document.getElementById('auditDetails').value;
      
      if (!action || !details) {
        showToast('Please fill all fields', 'error');
        return;
      }
      
      await addAuditLog(action, currentUser.uid, details);
      closeModal();
      showToast('Audit entry added', 'success');
      loadAuditLogs();
    }
    
    async function deleteAuditLog(logId) {
      const confirmModal = document.createElement('div');
      confirmModal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
      confirmModal.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 400px; text-align: center;">
          <h3 style="margin-bottom: 20px;">Delete this audit log entry?</h3>
          <p style="color: var(--text-muted); margin-bottom: 20px;">This action cannot be undone.</p>
          <div style="display: flex; gap: 12px; justify-content: center;">
            <button class="btn btn-secondary" onclick="this.closest('div').parentElement.remove()">Cancel</button>
            <button class="btn btn-danger" onclick="confirmDeleteAuditLog('${logId}')">Delete</button>
          </div>
        </div>
      `;
      document.body.appendChild(confirmModal);
    }
    
    async function confirmDeleteAuditLog(logId) {
      try {
        await database.ref(`orgs/${currentOrgId}/auditLogs/${logId}`).remove();
        showToast('Audit log entry deleted', 'success');
        loadAuditLogs();
        document.querySelector('[style*="z-index: 10000"]').remove();
      } catch (error) {
        console.error('Delete audit log error:', error);
        showToast('Failed to delete audit log', 'error');
      }
    }
    
    async function loadEvents() {
      try {
        const snapshot = await database.ref(`orgs/${currentOrgId}/events`)
          .orderByChild('date')
          .once('value');
        
        const container = document.getElementById('eventsContainer');
        const events = [];
        
        snapshot.forEach(child => {
          const event = { id: child.key, ...child.val() };
          events.push(event);
        });
        
        if (events.length === 0) {
          container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 40px;">No events scheduled.</p>';
          return;
        }
        
        const html = events.map(e => `
          <div style="padding: 20px; border-bottom: 1px solid var(--border);">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
              <div>
                <h4 style="margin-bottom: 4px;">${e.title}</h4>
                <p style="color: var(--text-muted); font-size: 14px;">
                  üìÖ ${new Date(e.date).toLocaleDateString()} at ${e.time}<br>
                  üìç ${e.location}
                </p>
              </div>
              <div>
                <button class="btn btn-small btn-info" onclick="downloadICS('${e.id}')">üì• ICS</button>
                <button class="btn btn-small btn-success" onclick="viewEventAttendance('${e.id}')">‚úì Attendance</button>
                ${hasPermission('events') ? `<button class="btn btn-small btn-danger" onclick="deleteEvent('${e.id}')">Delete</button>` : ''}
              </div>
            </div>
            <p style="font-size: 14px; line-height: 1.6;">${e.description}</p>
          </div>
        `).join('');
        
        container.innerHTML = html;
      } catch (error) {
        console.error('Load events error:', error);
        showToast('Failed to load events', 'error');
      }
    }
    
    function showCreateEventModal() {
      showModal('Create Event', `
        <div class="form-group">
          <label>Event Title</label>
          <input type="text" id="eventTitle">
        </div>
        <div class="form-group">
          <label>Date</label>
          <input type="date" id="eventDate">
        </div>
        <div class="form-group">
          <label>Time</label>
          <input type="time" id="eventTime">
        </div>
        <div class="form-group">
          <label>Location</label>
          <input type="text" id="eventLocation">
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea id="eventDescription"></textarea>
        </div>
      `, `
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="createEvent()">Create Event</button>
      `);
    }
    
    async function createEvent() {
      const title = document.getElementById('eventTitle').value.trim();
      const date = document.getElementById('eventDate').value;
      const time = document.getElementById('eventTime').value;
      const location = document.getElementById('eventLocation').value.trim();
      const description = document.getElementById('eventDescription').value.trim();
      
      if (!title || !date || !time || !location) {
        showToast('Please fill all required fields', 'error');
        return;
      }
      
      if (!currentOrgId) {
        showToast('No organization selected', 'error');
        return;
      }
      
      try {
        const eventData = {
          title: title,
          date: new Date(date + 'T00:00:00').getTime(),
          time: time,
          location: location,
          description: description || '',
          createdBy: currentUser.uid,
          createdByName: currentUserData.name,
          createdAt: Date.now()
        };
        
        const newEventRef = await database.ref(`orgs/${currentOrgId}/events`).push(eventData);
        await addAuditLog('EVENT_CREATE', currentUser.uid, `Created event: ${title}`);
        
        closeModal();
        showToast('Event created successfully!', 'success');
        loadEvents();
        loadDashboard();
      } catch (error) {
        console.error('Create event error:', error);
        showToast('Failed to create event: ' + error.message, 'error');
      }
    }
    
    async function deleteEvent(eventId) {
      const confirmModal = document.createElement('div');
      confirmModal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
      confirmModal.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 400px; text-align: center;">
          <h3 style="margin-bottom: 20px;">Are you sure you want to delete this event?</h3>
          <div style="display: flex; gap: 12px; justify-content: center;">
            <button class="btn btn-secondary" onclick="this.closest('div').parentElement.remove()">Cancel</button>
            <button class="btn btn-danger" onclick="confirmDeleteEvent('${eventId}')">Delete</button>
          </div>
        </div>
      `;
      document.body.appendChild(confirmModal);
    }
    
    async function confirmDeleteEvent(eventId) {
      try {
        await database.ref(`orgs/${currentOrgId}/events/${eventId}`).remove();
        await addAuditLog('EVENT_DELETE', currentUser.uid, `Deleted event ${eventId}`);
        showToast('Event deleted', 'success');
        loadEvents();
        document.querySelector('[style*="z-index: 10000"]').remove();
      } catch (error) {
        console.error('Delete event error:', error);
        showToast('Failed to delete event', 'error');
      }
    }
    
    function downloadICS(eventId) {
      database.ref(`orgs/${currentOrgId}/events/${eventId}`).once('value').then(snapshot => {
        const event = snapshot.val();
        const ics = `BEGIN:VCALENDAR
VERSION:2.0
BEGIN:VEVENT
DTSTART:${new Date(event.date).toISOString().replace(/[-:]/g, '').split('.')[0]}Z
SUMMARY:${event.title}
DESCRIPTION:${event.description}
LOCATION:${event.location}
END:VEVENT
END:VCALENDAR`;
        
        downloadFile(`${event.title}.ics`, ics);
        showToast('ICS file downloaded', 'success');
      });
    }
    
    function viewEventAttendance(eventId) {
      showToast('Feature coming soon: Link attendance to event', 'info');
    }
    
    async function loadAttendance() {
      try {
        const snapshot = await database.ref(`orgs/${currentOrgId}/attendance`).once('value');
        const container = document.getElementById('attendanceContainer');
        const sessions = [];
        
        snapshot.forEach(child => {
          sessions.push({ id: child.key, ...child.val() });
        });
        
        if (sessions.length === 0) {
          container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 40px;">No attendance sessions yet.</p>';
          return;
        }
        
        const html = sessions.map(s => {
          const attendeeCount = s.attendees ? Object.keys(s.attendees).length : 0;
          return `
            <div style="padding: 20px; border-bottom: 1px solid var(--border);">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <h4>${s.name}</h4>
                  <p style="color: var(--text-muted); font-size: 14px;">
                    ${new Date(s.createdAt).toLocaleString()} ¬∑ ${attendeeCount} attendees
                  </p>
                </div>
                <div>
                  <button class="btn btn-small btn-info" onclick="showQRScanner('${s.id}')">üì∑ Scan QR</button>
                  <button class="btn btn-small btn-success" onclick="viewAttendees('${s.id}')">üë• View</button>
                  <button class="btn btn-small btn-primary" onclick="exportAttendanceCSV('${s.id}')">üì• Export</button>
                </div>
              </div>
            </div>
          `;
        }).join('');
        
        container.innerHTML = html;
      } catch (error) {
        console.error('Load attendance error:', error);
        showToast('Failed to load attendance', 'error');
      }
    }
    
    function showCreateAttendanceModal() {
      showModal('Create Attendance Session', `
        <div class="form-group">
          <label>Session Name</label>
          <input type="text" id="attendanceName" placeholder="e.g., Weekly Meeting - Jan 15">
        </div>
        <div class="form-group">
          <label>Description (Optional)</label>
          <textarea id="attendanceDescription" placeholder="Additional details about this session..."></textarea>
        </div>
      `, `
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="createAttendanceSession()">Create Session</button>
      `);
    }
    
    async function createAttendanceSession() {
      const name = document.getElementById('attendanceName').value.trim();
      const description = document.getElementById('attendanceDescription').value.trim();
      
      if (!name) {
        showToast('Please enter a session name', 'error');
        return;
      }
      
      try {
        const sessionData = {
          name,
          description,
          createdBy: currentUser.uid,
          createdAt: Date.now(),
          attendees: {}
        };
        
        await database.ref(`orgs/${currentOrgId}/attendance`).push(sessionData);
        await addAuditLog('ATTENDANCE_CREATE', currentUser.uid, `Created attendance session: ${name}`);
        
        closeModal();
        showToast('Attendance session created', 'success');
        loadAttendance();
      } catch (error) {
        console.error('Create attendance error:', error);
        showToast('Failed to create session', 'error');
      }
    }
    
    function showQRScanner(sessionId) {
      showModal('Scan Student QR Code', `
        <div style="text-align: center;">
          <video id="qrVideo" autoplay playsinline></video>
          <p style="margin-top: 20px; color: var(--text-muted);">Position QR code in front of camera</p>
          <div id="scanResult" style="margin-top: 20px;"></div>
        </div>
      `, `
        <button class="btn btn-secondary" onclick="stopQRScanner()">Close Scanner</button>
      `);
      
      startQRScanner(sessionId);
    }
    
    let qrScannerInterval = null;
    
    async function startQRScanner(sessionId) {
      try {
        const video = document.getElementById('qrVideo');
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        video.srcObject = stream;
        
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        qrScannerInterval = setInterval(() => {
          if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);
            
            if (code) {
              try {
                const data = JSON.parse(code.data);
                if (data.type === 'student_id' && data.orgId === currentOrgId) {
                  markAttendance(sessionId, data.uid, data.name);
                  clearInterval(qrScannerInterval);
                  stopQRScanner();
                }
              } catch (e) {
                console.error('QR parse error:', e);
              }
            }
          }
        }, 300);
      } catch (error) {
        console.error('QR scanner error:', error);
        showToast('Failed to access camera', 'error');
      }
    }
    
    function stopQRScanner() {
      if (qrScannerInterval) {
        clearInterval(qrScannerInterval);
        qrScannerInterval = null;
      }
      
      const video = document.getElementById('qrVideo');
      if (video && video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
      }
      
      closeModal();
    }
    
    async function markAttendance(sessionId, userId, userName) {
      try {
        await database.ref(`orgs/${currentOrgId}/attendance/${sessionId}/attendees/${userId}`).set({
          name: userName,
          timestamp: Date.now()
        });
        
        await addAuditLog('ATTENDANCE_MARK', currentUser.uid, `Marked attendance for ${userName}`);
        showToast(`‚úì Attendance recorded for ${userName}`, 'success');
        loadAttendance();
      } catch (error) {
        console.error('Mark attendance error:', error);
        showToast('Failed to mark attendance', 'error');
      }
    }
    
    async function viewAttendees(sessionId) {
      try {
        const snapshot = await database.ref(`orgs/${currentOrgId}/attendance/${sessionId}`).once('value');
        const session = snapshot.val();
        
        const attendeesList = session.attendees 
          ? Object.entries(session.attendees).map(([uid, data]) => `
              <div style="padding: 12px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between;">
                <span>${data.name}</span>
                <span style="color: var(--text-muted); font-size: 13px;">${new Date(data.timestamp).toLocaleString()}</span>
              </div>
            `).join('')
          : '<p style="text-align: center; padding: 20px; color: var(--text-muted);">No attendees yet</p>';
        
        showModal('Attendees', `
          <h4 style="margin-bottom: 16px;">${session.name}</h4>
          <div style="max-height: 400px; overflow-y: auto;">
            ${attendeesList}
          </div>
        `, `<button class="btn btn-secondary" onclick="closeModal()">Close</button>`);
      } catch (error) {
        console.error('View attendees error:', error);
        showToast('Failed to load attendees', 'error');
      }
    }
    
    async function exportAttendanceCSV(sessionId) {
      try {
        const snapshot = await database.ref(`orgs/${currentOrgId}/attendance/${sessionId}`).once('value');
        const session = snapshot.val();
        
        const rows = [['Name', 'Timestamp']];
        
        if (session.attendees) {
          Object.entries(session.attendees).forEach(([uid, data]) => {
            rows.push([data.name, new Date(data.timestamp).toLocaleString()]);
          });
        }
        
        const csv = rows.map(row => row.join(',')).join('\n');
        downloadFile(`attendance-${sessionId}.csv`, csv);
        showToast('Attendance exported', 'success');
      } catch (error) {
        console.error('Export attendance error:', error);
        showToast('Failed to export attendance', 'error');
      }
    }
    
    async function loadFiles() {
      try {
        const snapshot = await database.ref(`orgs/${currentOrgId}/files`).once('value');
        const container = document.getElementById('filesContainer');
        const files = [];
        
        snapshot.forEach(child => {
          files.push({ id: child.key, ...child.val() });
        });
        
        if (files.length === 0) {
          container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 40px;">No files uploaded yet.</p>';
          return;
        }
        
        const html = files.map(f => `
          <div style="padding: 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
            <div>
              <h4 style="margin-bottom: 4px;">üìÑ ${f.name}</h4>
              <p style="color: var(--text-muted); font-size: 13px;">
                Uploaded by ${f.uploadedBy} on ${new Date(f.uploadedAt).toLocaleDateString()}
              </p>
            </div>
            <div>
              <button class="btn btn-small btn-info" onclick="window.open('${f.url}', '_blank')">Download</button>
              ${hasPermission('files') ? `<button class="btn btn-small btn-danger" onclick="deleteFile('${f.id}')">Delete</button>` : ''}
            </div>
          </div>
        `).join('');
        
        container.innerHTML = html;
      } catch (error) {
        console.error('Load files error:', error);
        showToast('Failed to load files', 'error');
      }
    }
    
    function showUploadFileModal() {
      showModal('Upload File', `
        <div class="form-group">
          <label>File Name</label>
          <input type="text" id="fileName" placeholder="Document name">
        </div>
        <div class="form-group">
          <label>Select File</label>
          <input type="file" id="fileUpload">
        </div>
        <div id="fileUploadProgress" style="display: none; margin-top: 20px;">
          <div style="background: var(--light); height: 8px; border-radius: 4px; overflow: hidden;">
            <div id="fileUploadProgressBar" style="background: var(--primary); height: 100%; width: 0%; transition: width 0.3s;"></div>
          </div>
          <p style="margin-top: 8px; font-size: 12px; color: var(--text-muted);">Uploading...</p>
        </div>
      `, `
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="uploadFile()" id="uploadFileBtn">Upload</button>
      `);
    }
    
    async function uploadFile() {
      const name = document.getElementById('fileName').value.trim();
      const fileInput = document.getElementById('fileUpload');
      const file = fileInput.files[0];
      
      if (!name || !file) {
        showToast('Please provide file name and select a file', 'error');
        return;
      }
      
      try {
        document.getElementById('fileUploadProgress').style.display = 'block';
        document.getElementById('uploadFileBtn').disabled = true;
        
        const fileName = `${Date.now()}-${file.name}`;
        const filePath = `${currentOrgId}/files/${fileName}`;
        
        const { data, error } = await supabase.storage
          .from(CONFIG.SUPABASE.BUCKET)
          .upload(filePath, file);
        
        if (error) throw error;
        
        const { data: urlData } = supabase.storage
          .from(CONFIG.SUPABASE.BUCKET)
          .getPublicUrl(filePath);
        
        await database.ref(`orgs/${currentOrgId}/files`).push({
          name,
          url: urlData.publicUrl,
          uploadedBy: currentUserData.name,
          uploadedAt: Date.now()
        });
        
        await addAuditLog('FILE_UPLOAD', currentUser.uid, `Uploaded file: ${name}`);
        
        closeModal();
        showToast('File uploaded successfully', 'success');
        loadFiles();
      } catch (error) {
        console.error('Upload file error:', error);
        showToast('Failed to upload file', 'error');
        document.getElementById('uploadFileBtn').disabled = false;
      }
    }
    
    async function deleteFile(fileId) {
      const confirmModal = document.createElement('div');
      confirmModal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
      confirmModal.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 400px; text-align: center;">
          <h3 style="margin-bottom: 20px;">Delete this file?</h3>
          <div style="display: flex; gap: 12px; justify-content: center;">
            <button class="btn btn-secondary" onclick="this.closest('div').parentElement.remove()">Cancel</button>
            <button class="btn btn-danger" onclick="confirmDeleteFile('${fileId}')">Delete</button>
          </div>
        </div>
      `;
      document.body.appendChild(confirmModal);
    }
    
    async function confirmDeleteFile(fileId) {
      try {
        await database.ref(`orgs/${currentOrgId}/files/${fileId}`).remove();
        await addAuditLog('FILE_DELETE', currentUser.uid, `Deleted file ${fileId}`);
        showToast('File deleted', 'success');
        loadFiles();
        document.querySelector('[style*="z-index: 10000"]').remove();
      } catch (error) {
        console.error('Delete file error:', error);
        showToast('Failed to delete file', 'error');
      }
    }
    
    async function loadInventory() {
      try {
        const snapshot = await database.ref(`orgs/${currentOrgId}/inventory`).once('value');
        const container = document.getElementById('inventoryContainer');
        const items = [];
        
        snapshot.forEach(child => {
          items.push({ id: child.key, ...child.val() });
        });
        
        if (items.length === 0) {
          container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 40px;">No items in inventory.</p>';
          return;
        }
        
        const html = items.map(item => `
          <div style="padding: 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
            <div>
              <h4>${item.name}</h4>
              <p style="color: var(--text-muted); font-size: 13px;">Quantity: ${item.quantity} ¬∑ ${item.condition}</p>
            </div>
            <div>
              ${hasPermission('inventory') ? `<button class="btn btn-small btn-danger" onclick="deleteInventoryItem('${item.id}')">Delete</button>` : ''}
            </div>
          </div>
        `).join('');
        
        container.innerHTML = html;
        
        const receiptsSnapshot = await database.ref(`orgs/${currentOrgId}/receipts`).once('value');
        const receiptsContainer = document.getElementById('receiptsContainer');
        const receipts = [];
        
        receiptsSnapshot.forEach(child => {
          receipts.push({ id: child.key, ...child.val() });
        });
        
        if (receipts.length === 0) {
          receiptsContainer.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 40px;">No receipts stored.</p>';
        } else {
          const receiptsHTML = receipts.map(r => `
            <div style="padding: 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
              <div>
                <h4>${r.description}</h4>
                <p style="color: var(--text-muted); font-size: 13px;">‚Ç±${r.amount.toLocaleString()} ¬∑ ${new Date(r.date).toLocaleDateString()}</p>
              </div>
              <div>
                <button class="btn btn-small btn-info" onclick="window.open('${r.imageUrl}', '_blank')">View</button>
                ${hasPermission('receipts') ? `<button class="btn btn-small btn-danger" onclick="deleteReceipt('${r.id}')">Delete</button>` : ''}
              </div>
            </div>
          `).join('');
          receiptsContainer.innerHTML = receiptsHTML;
        }
      } catch (error) {
        console.error('Load inventory error:', error);
        showToast('Failed to load inventory', 'error');
      }
    }
    
    function showAddInventoryModal() {
      showModal('Add Inventory Item', `
        <div class="form-group">
          <label>Item Name</label>
          <input type="text" id="inventoryName">
        </div>
        <div class="form-group">
          <label>Quantity</label>
          <input type="number" id="inventoryQuantity" min="1" value="1">
        </div>
        <div class="form-group">
          <label>Condition</label>
          <select id="inventoryCondition">
            <option>New</option>
            <option>Good</option>
            <option>Fair</option>
            <option>Poor</option>
          </select>
        </div>
      `, `
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="addInventoryItem()">Add Item</button>
      `);
    }
    
    async function addInventoryItem() {
      const name = document.getElementById('inventoryName').value;
      const quantity = parseInt(document.getElementById('inventoryQuantity').value);
      const condition = document.getElementById('inventoryCondition').value;
      
      if (!name) {
        showToast('Please enter item name', 'error');
        return;
      }
      
      try {
        await database.ref(`orgs/${currentOrgId}/inventory`).push({
          name,
          quantity,
          condition,
          addedBy: currentUserData.name,
          addedAt: Date.now()
        });
        
        await addAuditLog('INVENTORY_ADD', currentUser.uid, `Added inventory: ${name}`);
        closeModal();
        showToast('Item added to inventory', 'success');
        loadInventory();
      } catch (error) {
        console.error('Add inventory error:', error);
        showToast('Failed to add item', 'error');
      }
    }
    
    async function deleteInventoryItem(itemId) {
      try {
        await database.ref(`orgs/${currentOrgId}/inventory/${itemId}`).remove();
        await addAuditLog('INVENTORY_DELETE', currentUser.uid, `Deleted inventory item`);
        showToast('Item deleted', 'success');
        loadInventory();
      } catch (error) {
        console.error('Delete inventory error:', error);
        showToast('Failed to delete item', 'error');
      }
    }
    
    function showUploadReceiptModal() {
      showModal('Upload Receipt', `
        <div class="form-group">
          <label>Description</label>
          <input type="text" id="receiptDescription" placeholder="What is this receipt for?">
        </div>
        <div class="form-group">
          <label>Amount</label>
          <input type="number" id="receiptAmount" min="0" step="0.01" placeholder="0.00">
        </div>
        <div class="form-group">
          <label>Date</label>
          <input type="date" id="receiptDate" value="${new Date().toISOString().split('T')[0]}">
        </div>
        <div class="form-group">
          <label>Receipt Image</label>
          <input type="file" id="receiptImage" accept="image/*">
        </div>
      `, `
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="uploadReceipt()">Upload Receipt</button>
      `);
    }
    
    async function uploadReceipt() {
      const description = document.getElementById('receiptDescription').value;
      const amount = parseFloat(document.getElementById('receiptAmount').value);
      const date = document.getElementById('receiptDate').value;
      const imageFile = document.getElementById('receiptImage').files[0];
      
      if (!description || !amount || !imageFile) {
        showToast('Please fill all fields', 'error');
        return;
      }
      
      try {
        const formData = new FormData();
        formData.append('file', imageFile);
        formData.append('upload_preset', CONFIG.CLOUDINARY.UPLOAD_PRESET);
        formData.append('folder', `${currentOrgId}/receipts`);
        
        const response = await fetch(`https://api.cloudinary.com/v1_1/${CONFIG.CLOUDINARY.CLOUD_NAME}/image/upload`, {
          method: 'POST',
          body: formData
        });
        
        const data = await response.json();
        
        await database.ref(`orgs/${currentOrgId}/receipts`).push({
          description,
          amount,
          date: new Date(date).getTime(),
          imageUrl: data.secure_url,
          uploadedBy: currentUserData.name,
          uploadedAt: Date.now()
        });
        
        await addAuditLog('RECEIPT_UPLOAD', currentUser.uid, `Uploaded receipt: ${description}`);
        closeModal();
        showToast('Receipt uploaded successfully', 'success');
        loadInventory();
      } catch (error) {
        console.error('Upload receipt error:', error);
        showToast('Failed to upload receipt', 'error');
      }
    }
    
    async function deleteReceipt(receiptId) {
      try {
        await database.ref(`orgs/${currentOrgId}/receipts/${receiptId}`).remove();
        await addAuditLog('RECEIPT_DELETE', currentUser.uid, `Deleted receipt`);
        showToast('Receipt deleted', 'success');
        loadInventory();
      } catch (error) {
        console.error('Delete receipt error:', error);
        showToast('Failed to delete receipt', 'error');
      }
    }
    
    async function loadFinance() {
      try {
        const snapshot = await database.ref(`orgs/${currentOrgId}/finance`).once('value');
        const tbody = document.getElementById('financeTableBody');
        const rows = [];
        
        let totalIncome = 0, totalExpenses = 0;
        
        snapshot.forEach(child => {
          const txn = child.val();
          if (txn.type === 'income') totalIncome += txn.amount;
          else totalExpenses += txn.amount;
          
          rows.unshift(`
            <tr>
              <td>${new Date(txn.date).toLocaleDateString()}</td>
              <td><span class="role-pill role-${txn.type === 'income' ? 'SECRETARY' : 'TREASURER'}">${txn.type}</span></td>
              <td>${txn.category}</td>
              <td>${txn.description}</td>
              <td style="color: ${txn.type === 'income' ? 'var(--secondary)' : 'var(--danger)'}; font-weight: 600;">
                ${txn.type === 'income' ? '+' : '-'}‚Ç±${txn.amount.toLocaleString()}
              </td>
            </tr>
          `);
        });
        
        document.getElementById('totalIncome').textContent = `‚Ç±${totalIncome.toLocaleString()}`;
        document.getElementById('totalExpenses').textContent = `‚Ç±${totalExpenses.toLocaleString()}`;
        document.getElementById('balance').textContent = `‚Ç±${(totalIncome - totalExpenses).toLocaleString()}`;
        
        tbody.innerHTML = rows.length > 0 ? rows.join('') : '<tr><td colspan="5" style="text-align: center; padding: 40px;">No transactions yet.</td></tr>';
      } catch (error) {
        console.error('Load finance error:', error);
        showToast('Failed to load finance data', 'error');
      }
    }
    
    function showAddTransactionModal() {
      showModal('Add Transaction', `
        <div class="form-group">
          <label>Type</label>
          <select id="txnType">
            <option value="income">Income</option>
            <option value="expense">Expense</option>
          </select>
        </div>
        <div class="form-group">
          <label>Category</label>
          <input type="text" id="txnCategory" placeholder="e.g., Membership Fee, Event Supplies">
        </div>
        <div class="form-group">
          <label>Description</label>
          <input type="text" id="txnDescription">
        </div>
        <div class="form-group">
          <label>Amount</label>
          <input type="number" id="txnAmount" min="0" step="0.01">
        </div>
        <div class="form-group">
          <label>Date</label>
          <input type="date" id="txnDate" value="${new Date().toISOString().split('T')[0]}">
        </div>
      `, `
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="addTransaction()">Add Transaction</button>
      `);
    }
    
    async function addTransaction() {
      const type = document.getElementById('txnType').value;
      const category = document.getElementById('txnCategory').value;
      const description = document.getElementById('txnDescription').value;
      const amount = parseFloat(document.getElementById('txnAmount').value);
      const date = document.getElementById('txnDate').value;
      
      if (!category || !description || !amount) {
        showToast('Please fill all fields', 'error');
        return;
      }
      
      try {
        await database.ref(`orgs/${currentOrgId}/finance`).push({
          type,
          category,
          description,
          amount,
          date: new Date(date).getTime(),
          addedBy: currentUserData.name,
          addedAt: Date.now()
        });
        
        await addAuditLog('FINANCE_ADD', currentUser.uid, `Added ${type}: ‚Ç±${amount}`);
        closeModal();
        showToast('Transaction added', 'success');
        loadFinance();
        loadDashboard();
      } catch (error) {
        console.error('Add transaction error:', error);
        showToast('Failed to add transaction', 'error');
      }
    }
    
    async function exportFinanceCSV() {
      try {
        const snapshot = await database.ref(`orgs/${currentOrgId}/finance`).once('value');
        const rows = [['Date', 'Type', 'Category', 'Description', 'Amount']];
        
        snapshot.forEach(child => {
          const txn = child.val();
          rows.push([
            new Date(txn.date).toLocaleDateString(),
            txn.type,
            txn.category,
            txn.description,
            txn.amount
          ]);
        });
        
        const csv = rows.map(row => row.join(',')).join('\n');
        downloadFile(`finance-${Date.now()}.csv`, csv);
        showToast('Finance data exported', 'success');
      } catch (error) {
        console.error('Export finance error:', error);
        showToast('Failed to export data', 'error');
      }
    }
    
    async function loadAnnouncements() {
      try {
        const snapshot = await database.ref(`orgs/${currentOrgId}/announcements`)
          .orderByChild('timestamp')
          .once('value');
        
        const container = document.getElementById('allAnnouncementsContainer');
        const announcements = [];
        
        snapshot.forEach(child => {
          announcements.unshift({ id: child.key, ...child.val() });
        });
        
        if (announcements.length === 0) {
          container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 40px;">No announcements yet.</p>';
          return;
        }
        
        const html = announcements.map(a => `
          <div style="padding: 20px; border-bottom: 1px solid var(--border);">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
              <div>
                <h4>${a.title}</h4>
                <p style="color: var(--text-muted); font-size: 13px;">
                  Posted by ${a.author} on ${new Date(a.timestamp).toLocaleString()}
                </p>
              </div>
              ${hasPermission('announcements') ? `<button class="btn btn-small btn-danger" onclick="deleteAnnouncement('${a.id}')">Delete</button>` : ''}
            </div>
            <p style="line-height: 1.6;">${a.content}</p>
          </div>
        `).join('');
        
        container.innerHTML = html;
      } catch (error) {
        console.error('Load announcements error:', error);
        showToast('Failed to load announcements', 'error');
      }
    }
    
    function showCreateAnnouncementModal() {
      showModal('Create Announcement', `
        <div class="form-group">
          <label>Title</label>
          <input type="text" id="announcementTitle">
        </div>
        <div class="form-group">
          <label>Content</label>
          <textarea id="announcementContent" rows="6"></textarea>
        </div>
      `, `
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="createAnnouncement()">Post Announcement</button>
      `);
    }
    
    async function createAnnouncement() {
      const title = document.getElementById('announcementTitle').value;
      const content = document.getElementById('announcementContent').value;
      
      if (!title || !content) {
        showToast('Please fill all fields', 'error');
        return;
      }
      
      try {
        await database.ref(`orgs/${currentOrgId}/announcements`).push({
          title,
          content,
          author: currentUserData.name,
          timestamp: Date.now()
        });
        
        await addAuditLog('ANNOUNCEMENT_CREATE', currentUser.uid, `Posted announcement: ${title}`);
        await sendDiscordNotification(`üì¢ New announcement in ${currentOrgData.name}: ${title}`);
        
        closeModal();
        showToast('Announcement posted', 'success');
        loadAnnouncements();
        loadDashboard();
      } catch (error) {
        console.error('Create announcement error:', error);
        showToast('Failed to create announcement', 'error');
      }
    }
    
    async function deleteAnnouncement(id) {
      try {
        await database.ref(`orgs/${currentOrgId}/announcements/${id}`).remove();
        await addAuditLog('ANNOUNCEMENT_DELETE', currentUser.uid, `Deleted announcement`);
        showToast('Announcement deleted', 'success');
        loadAnnouncements();
      } catch (error) {
        console.error('Delete announcement error:', error);
        showToast('Failed to delete announcement', 'error');
      }
    }
    
    async function loadChat() {
      loadChatMessages();
      
      database.ref(`orgs/${currentOrgId}/chat/${currentChatChannel}`).on('child_added', () => {
        loadChatMessages();
      });
    }
    
    async function loadChatMessages() {
      try {
        const snapshot = await database.ref(`orgs/${currentOrgId}/chat/${currentChatChannel}`)
          .limitToLast(50)
          .once('value');
        
        const container = document.getElementById('chatMessages');
        const messages = [];
        
        snapshot.forEach(child => {
          messages.push(child.val());
        });
        
        if (messages.length === 0) {
          container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 40px;">No messages yet. Start the conversation!</p>';
          return;
        }
        
        const html = messages.map(m => {
          const initials = m.userName.split(' ').map(n => n[0]).join('').toUpperCase();
          return `
            <div class="chat-message">
              <div class="chat-message-avatar">${initials}</div>
              <div class="chat-message-content">
                <div class="chat-message-header">
                  <span class="chat-message-author">${m.userName}</span>
                  <span class="chat-message-time">${new Date(m.timestamp).toLocaleTimeString()}</span>
                </div>
                <div class="chat-message-text">${m.message}</div>
              </div>
            </div>
          `;
        }).join('');
        
        container.innerHTML = html;
        container.scrollTop = container.scrollHeight;
      } catch (error) {
        console.error('Load chat error:', error);
      }
    }
    
    function switchChatChannel(channel) {
      currentChatChannel = channel;
      document.querySelectorAll('.chat-channel').forEach(c => c.classList.remove('active'));
      document.querySelector(`[data-channel="${channel}"]`).classList.add('active');
      loadChatMessages();
    }
    
    function handleChatKeyPress(e) {
      if (e.key === 'Enter') {
        sendChatMessage();
      }
    }
    
    function handleChatTyping() {
      if (typingTimeout) clearTimeout(typingTimeout);
      
      database.ref(`orgs/${currentOrgId}/typing/${currentChatChannel}/${currentUser.uid}`).set({
        name: currentUserData.name,
        timestamp: Date.now()
      });
      
      typingTimeout = setTimeout(() => {
        database.ref(`orgs/${currentOrgId}/typing/${currentChatChannel}/${currentUser.uid}`).remove();
      }, 3000);
    }
    
    async function sendChatMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      
      if (!message) return;
      
      try {
        await database.ref(`orgs/${currentOrgId}/chat/${currentChatChannel}`).push({
          userId: currentUser.uid,
          userName: currentUserData.name,
          message: message,
          timestamp: Date.now()
        });
        
        input.value = '';
        database.ref(`orgs/${currentOrgId}/typing/${currentChatChannel}/${currentUser.uid}`).remove();
      } catch (error) {
        console.error('Send message error:', error);
        showToast('Failed to send message', 'error');
      }
    }
    
    function showCreateChannelModal() {
      showModal('Create Chat Channel', `
        <div class="form-group">
          <label>Channel Name</label>
          <input type="text" id="channelName" placeholder="e.g., announcements, projects">
          <div class="form-hint">Use lowercase, no spaces</div>
        </div>
        <div class="form-group">
          <label>Channel Emoji (Optional)</label>
          <input type="text" id="channelEmoji" placeholder="üí¨" maxlength="2">
        </div>
      `, `
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="createChatChannel()">Create Channel</button>
      `);
    }
    
    async function createChatChannel() {
      const name = document.getElementById('channelName').value.trim().toLowerCase().replace(/\s+/g, '-');
      const emoji = document.getElementById('channelEmoji').value.trim() || 'üí¨';
      
      if (!name) {
        showToast('Please enter a channel name', 'error');
        return;
      }
      
      try {
        await database.ref(`orgs/${currentOrgId}/chatChannels/${name}`).set({
          name,
          emoji,
          createdBy: currentUser.uid,
          createdAt: Date.now()
        });
        
        const channelsList = document.getElementById('chatChannelsList');
        channelsList.innerHTML += `
          <div class="chat-channel" data-channel="${name}" onclick="switchChatChannel('${name}')">
            ${emoji} ${name.charAt(0).toUpperCase() + name.slice(1)}
          </div>
        `;
        
        await addAuditLog('CHANNEL_CREATE', currentUser.uid, `Created chat channel: ${name}`);
        closeModal();
        showToast('Channel created', 'success');
      } catch (error) {
        console.error('Create channel error:', error);
        showToast('Failed to create channel', 'error');
      }
    }
    
    async function loadTasks() {
      try {
        const snapshot = await database.ref(`orgs/${currentOrgId}/tasks`).once('value');
        
        const columns = { todo: [], doing: [], review: [], done: [] };
        
        snapshot.forEach(child => {
          const task = { id: child.key, ...child.val() };
          columns[task.status].push(task);
        });
        
        Object.keys(columns).forEach(status => {
          const container = document.getElementById(`kanban-${status}`);
          
          if (columns[status].length === 0) {
            container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 20px; font-size: 13px;">No tasks</p>';
          } else {
            container.innerHTML = columns[status].map(task => `
              <div class="kanban-card" onclick="viewTask('${task.id}')">
                <h4 style="margin-bottom: 8px;">${task.title}</h4>
                <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">${task.description}</p>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="font-size: 11px; color: var(--text-muted);">${task.assignedTo || 'Unassigned'}</span>
                  ${hasPermission('tasks') ? `<button class="btn btn-small btn-info" onclick="event.stopPropagation(); moveTask('${task.id}', '${task.status}')">Move</button>` : ''}
                </div>
              </div>
            `).join('');
          }
        });
      } catch (error) {
        console.error('Load tasks error:', error);
        showToast('Failed to load tasks', 'error');
      }
    }
    
    function showCreateTaskModal() {
      showModal('Create Task', `
        <div class="form-group">
          <label>Task Title</label>
          <input type="text" id="taskTitle">
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea id="taskDescription"></textarea>
        </div>
        <div class="form-group">
          <label>Assign To</label>
          <input type="text" id="taskAssignee" placeholder="Member name (optional)">
        </div>
      `, `
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="createTask()">Create Task</button>
      `);
    }
    
    async function createTask() {
      const title = document.getElementById('taskTitle').value;
      const description = document.getElementById('taskDescription').value;
      const assignedTo = document.getElementById('taskAssignee').value;
      
      if (!title) {
        showToast('Please enter a task title', 'error');
        return;
      }
      
      try {
        await database.ref(`orgs/${currentOrgId}/tasks`).push({
          title,
          description,
          assignedTo,
          status: 'todo',
          createdBy: currentUserData.name,
          createdAt: Date.now()
        });
        
        await addAuditLog('TASK_CREATE', currentUser.uid, `Created task: ${title}`);
        closeModal();
        showToast('Task created', 'success');
        loadTasks();
      } catch (error) {
        console.error('Create task error:', error);
        showToast('Failed to create task', 'error');
      }
    }
    
    async function viewTask(taskId) {
      try {
        const snapshot = await database.ref(`orgs/${currentOrgId}/tasks/${taskId}`).once('value');
        const task = snapshot.val();
        
        showModal(task.title, `
          <p style="margin-bottom: 16px;"><strong>Description:</strong><br>${task.description}</p>
          <p style="margin-bottom: 8px;"><strong>Status:</strong> ${task.status}</p>
          <p style="margin-bottom: 8px;"><strong>Assigned To:</strong> ${task.assignedTo || 'Unassigned'}</p>
          <p style="margin-bottom: 8px;"><strong>Created By:</strong> ${task.createdBy}</p>
          <p style="color: var(--text-muted); font-size: 13px;">Created ${new Date(task.createdAt).toLocaleString()}</p>
        `, `
          <button class="btn btn-secondary" onclick="closeModal()">Close</button>
          ${hasPermission('tasks') ? `<button class="btn btn-danger" onclick="deleteTask('${taskId}')">Delete Task</button>` : ''}
        `);
      } catch (error) {
        console.error('View task error:', error);
        showToast('Failed to load task', 'error');
      }
    }
    
    async function moveTask(taskId, currentStatus) {
      const statuses = ['todo', 'doing', 'review', 'done'];
      const currentIndex = statuses.indexOf(currentStatus);
      const nextStatus = statuses[currentIndex + 1] || statuses[0];
      
      try {
        await database.ref(`orgs/${currentOrgId}/tasks/${taskId}`).update({ status: nextStatus });
        await addAuditLog('TASK_MOVE', currentUser.uid, `Moved task to ${nextStatus}`);
        showToast('Task moved', 'success');
        loadTasks();
      } catch (error) {
        console.error('Move task error:', error);
        showToast('Failed to move task', 'error');
      }
    }
    
    async function deleteTask(taskId) {
      try {
        await database.ref(`orgs/${currentOrgId}/tasks/${taskId}`).remove();
        await addAuditLog('TASK_DELETE', currentUser.uid, `Deleted task`);
        closeModal();
        showToast('Task deleted', 'success');
        loadTasks();
      } catch (error) {
        console.error('Delete task error:', error);
        showToast('Failed to delete task', 'error');
      }
    }
    
    async function loadPolls() {
      try {
        const snapshot = await database.ref(`orgs/${currentOrgId}/polls`).once('value');
        const container = document.getElementById('pollsContainer');
        const polls = [];
        
        snapshot.forEach(child => {
          polls.push({ id: child.key, ...child.val() });
        });
        
        if (polls.length === 0) {
          container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 40px;">No polls created yet.</p>';
          return;
        }
        
        const html = polls.map(poll => {
          const totalVotes = poll.options ? Object.values(poll.options).reduce((sum, opt) => sum + (opt.votes || 0), 0) : 0;
          const hasVoted = poll.voters && poll.voters[currentUser.uid];
          
          return `
            <div style="padding: 20px; border-bottom: 1px solid var(--border);">
              <h4 style="margin-bottom: 16px;">${poll.question}</h4>
              ${poll.options ? Object.entries(poll.options).map(([key, opt]) => {
                const percentage = totalVotes > 0 ? (opt.votes || 0) / totalVotes * 100 : 0;
                return `
                  <div style="margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                      <span>${opt.text}</span>
                      <span style="font-weight: 600;">${opt.votes || 0} votes (${percentage.toFixed(0)}%)</span>
                    </div>
                    <div style="background: var(--light); height: 8px; border-radius: 4px; overflow: hidden;">
                      <div style="background: var(--primary); height: 100%; width: ${percentage}%; transition: width 0.3s;"></div>
                    </div>
                    ${!hasVoted ? `<button class="btn btn-small btn-primary" onclick="votePoll('${poll.id}', '${key}')" style="margin-top: 8px;">Vote</button>` : ''}
                  </div>
                `;
              }).join('') : ''}
              <p style="color: var(--text-muted); font-size: 13px; margin-top: 16px;">Total votes: ${totalVotes}</p>
              ${hasVoted ? '<p style="color: var(--secondary); font-size: 13px;">‚úì You voted in this poll</p>' : ''}
            </div>
          `;
        }).join('');
        
        container.innerHTML = html;
      } catch (error) {
        console.error('Load polls error:', error);
        showToast('Failed to load polls', 'error');
      }
    }
    
    function showCreatePollModal() {
      showModal('Create Poll', `
        <div class="form-group">
          <label>Question</label>
          <input type="text" id="pollQuestion">
        </div>
        <div class="form-group">
          <label>Option 1</label>
          <input type="text" id="pollOption1">
        </div>
        <div class="form-group">
          <label>Option 2</label>
          <input type="text" id="pollOption2">
        </div>
        <div class="form-group">
          <label>Option 3 (Optional)</label>
          <input type="text" id="pollOption3">
        </div>
        <div class="form-group">
          <label>Option 4 (Optional)</label>
          <input type="text" id="pollOption4">
        </div>
      `, `
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="createPoll()">Create Poll</button>
      `);
    }
    
    async function createPoll() {
      const question = document.getElementById('pollQuestion').value;
      const opt1 = document.getElementById('pollOption1').value;
      const opt2 = document.getElementById('pollOption2').value;
      const opt3 = document.getElementById('pollOption3').value;
      const opt4 = document.getElementById('pollOption4').value;
      
      if (!question || !opt1 || !opt2) {
        showToast('Please provide question and at least 2 options', 'error');
        return;
      }
      
      try {
        const options = {
          opt1: { text: opt1, votes: 0 },
          opt2: { text: opt2, votes: 0 }
        };
        
        if (opt3) options.opt3 = { text: opt3, votes: 0 };
        if (opt4) options.opt4 = { text: opt4, votes: 0 };
        
        await database.ref(`orgs/${currentOrgId}/polls`).push({
          question,
          options,
          createdBy: currentUserData.name,
          createdAt: Date.now(),
          voters: {}
        });
        
        await addAuditLog('POLL_CREATE', currentUser.uid, `Created poll: ${question}`);
        closeModal();
        showToast('Poll created', 'success');
        loadPolls();
      } catch (error) {
        console.error('Create poll error:', error);
        showToast('Failed to create poll', 'error');
      }
    }
    
    async function votePoll(pollId, optionKey) {
      try {
        const snapshot = await database.ref(`orgs/${currentOrgId}/polls/${pollId}`).once('value');
        const poll = snapshot.val();
        
        if (poll.voters && poll.voters[currentUser.uid]) {
          showToast('You have already voted in this poll', 'info');
          return;
        }
        
        const currentVotes = poll.options[optionKey].votes || 0;
        
        await database.ref(`orgs/${currentOrgId}/polls/${pollId}/options/${optionKey}`).update({
          votes: currentVotes + 1
        });
        
        await database.ref(`orgs/${currentOrgId}/polls/${pollId}/voters/${currentUser.uid}`).set(true);
        
        await addAuditLog('POLL_VOTE', currentUser.uid, `Voted in poll`);
        showToast('Vote recorded', 'success');
        loadPolls();
      } catch (error) {
        console.error('Vote poll error:', error);
        showToast('Failed to record vote', 'error');
      }
    }
    
    async function sendDiscordNotification(message) {
      if (!CONFIG.DISCORD_WEBHOOK) return;
      
      try {
        await fetch(CONFIG.DISCORD_WEBHOOK, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content: message })
        });
      } catch (error) {
        console.error('Discord notification error:', error);
      }
    }
    
    function downloadFile(filename, content) {
      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }
    
    function processSyncQueue() {
      if (navigator.onLine && offlineSyncQueue.length > 0) {
        offlineSyncQueue.forEach(async (operation) => {
          try {
            await database.ref(operation.path).set(operation.data);
          } catch (error) {
            console.error('Sync error:', error);
          }
        });
        offlineSyncQueue = [];
        localStorage.removeItem('offlineSyncQueue');
      }
    }
    
    window.addEventListener('online', processSyncQueue);
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a624db1942afe08',t:'MTc2NDQyMTM4OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
